<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Habit Tracker</title>
    <th:block layout:fragment="extra-css">
    <link rel="stylesheet" th:href="@{/css/habit.css}">
    </th:block>
</head>
<body>
    <div layout:fragment="content">
<div class="container">
                    <header>
                        <h1>Habit Tracker</h1>
                        <p class="subtitle">Track your daily habits</p>
                    </header>

                    <!-- Flash Messages -->
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

                    <!-- Add Habit Form -->
                    <div class="add-habit-section">
                        <form th:action="@{/habits}" method="post" th:object="${newHabit}" class="add-habit-form">
                            <input type="text" th:field="*{name}" placeholder="New habit name..." class="habit-input" required>
                            <select th:field="*{icon}" class="icon-select">
                                <option value="âœ…">âœ… Check</option>
                                <option value="ğŸƒ">ğŸƒ Exercise</option>
                                <option value="ğŸ“š">ğŸ“š Reading</option>
                                <option value="ğŸ’§">ğŸ’§ Water</option>
                                <option value="ğŸ§˜">ğŸ§˜ Meditation</option>
                                <option value="ğŸ’Š">ğŸ’Š Vitamins</option>
                                <option value="ğŸŒ…">ğŸŒ… Early Rise</option>
                                <option value="âœï¸">âœï¸ Writing</option>
                                <option value="ğŸ“Š">ğŸ“Š Body Log</option>
                            </select>
                            <button type="submit" class="btn btn-primary">Add Habit</button>
                        </form>
                    </div>

                    <!-- Month Navigation -->
                    <div class="month-nav">
                        <a th:href="@{/habits(year=${prevYear}, month=${prevMonth})}" class="nav-btn">â—€ Prev</a>
                        <h2 th:text="${year + '-' + (month < 10 ? '0' + month : month)}">2024-01</h2>
                        <a th:href="@{/habits(year=${nextYear}, month=${nextMonth})}" class="nav-btn">Next â–¶</a>
                    </div>

                    <!-- Habit Tracker Grid -->
                    <div th:if="${#lists.isEmpty(habits)}" class="empty-state">
                        <p>No habits yet. Add your first habit to track!</p>
                    </div>

                    <div class="habit-tracker" th:unless="${#lists.isEmpty(habits)}">
                        <table class="habit-table">
                            <thead>
                                <tr>
                                    <th class="habit-name-col">Habit</th>
                                    <th class="count-col">Count</th>
                                    <th th:each="day : ${days}"
                                        th:text="${day.dayOfMonth}"
                                        th:classappend="${(day.equals(today) ? 'today' : '') + (day.dayOfWeek.value == 6 or day.dayOfWeek.value == 7 ? ' weekend' : '')}"
                                        class="day-col">1</th>
                                    <th class="action-col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="habit : ${habits}">
                                    <td class="habit-name-cell">
                                        <span class="habit-icon" th:text="${habit.icon}">âœ…</span>
                                        <span th:text="${habit.name}">Habit Name</span>
                                    </td>
                                    <td class="count-cell">
                                        <span class="count-badge" th:if="${counts[habit.id] != null and counts[habit.id] > 0}" th:text="${counts[habit.id]}">0</span>
                                    </td>
                                    <td th:each="day : ${days}" class="check-cell" th:classappend="${(day.equals(today) ? 'today' : '') + (day.dayOfWeek.value == 6 or day.dayOfWeek.value == 7 ? ' weekend' : '')}"
                                        th:with="habitNumericMap=${numericRecords.get(habit.id)},numVal=${habitNumericMap != null ? habitNumericMap.get(day) : null}">
                                        <!-- Body Log: numeric input -->
                                        <form th:if="${habit.icon == 'ğŸ“Š'}" th:action="@{/habits/{id}/numeric(id=${habit.id})}" method="post" class="numeric-form">
                                            <input type="hidden" name="date" th:value="${day}">
                                            <input type="hidden" name="year" th:value="${year}">
                                            <input type="hidden" name="month" th:value="${month}">
                                            <input type="number" name="value" step="0.1" min="0" max="999.9"
                                                   class="numeric-input"
                                                   th:value="${numVal != null ? (numVal % 1 == 0 ? numVal.intValue() : numVal) : ''}"
                                                   th:classappend="${numVal != null} ? 'has-value' : ''"
                                                   onchange="this.form.submit()">
                                        </form>
                                        <!-- Other types: checkbox -->
                                        <form th:unless="${habit.icon == 'ğŸ“Š'}" th:action="@{/habits/{id}/toggle(id=${habit.id})}" method="post">
                                            <input type="hidden" name="date" th:value="${day}">
                                            <input type="hidden" name="year" th:value="${year}">
                                            <input type="hidden" name="month" th:value="${month}">
                                            <button type="submit" class="check-btn"
                                                    th:classappend="${records[habit.id] != null and records[habit.id].contains(day)} ? 'checked' : ''">
                                                <span th:if="${records[habit.id] != null and records[habit.id].contains(day)}">âœ“</span>
                                            </button>
                                        </form>
                                    </td>
                                    <td class="action-cell">
                                        <a th:href="@{/habits/{id}/edit(id=${habit.id})}" class="btn btn-edit btn-tiny">Edit</a>
                                        <form th:action="@{/habits/{id}/delete(id=${habit.id})}" method="post" style="display: inline;">
                                            <button type="submit" class="btn btn-delete btn-tiny" onclick="return confirm('Delete this habit?')">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
    </div>
</body>
</html>

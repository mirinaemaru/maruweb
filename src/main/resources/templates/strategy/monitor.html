<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Strategy Monitoring</title>
    <style>
        .monitor-container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .monitor-container header { margin-bottom: 25px; }
        .monitor-container header h1 { font-size: 28px; font-weight: 700; margin: 0 0 8px 0; color: var(--text-primary); }
        .monitor-container header .subtitle { font-size: 15px; color: var(--text-secondary); margin: 0; }

        .status-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .status-card { background: var(--bg-secondary); padding: 20px; border-radius: 12px;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
        .status-label { color: var(--text-muted); font-size: 14px; margin-bottom: 5px; }
        .status-value { font-size: 28px; font-weight: 700; color: var(--text-primary); }
        .status-value.positive { color: #27ae60; }
        .status-value.negative { color: #e74c3c; }

        .info-section { background: var(--bg-secondary); padding: 20px; border-radius: 12px;
                       box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .info-section h2 { color: var(--text-primary); font-size: 18px; margin: 0 0 15px 0; font-weight: 600; }
        .info-table { width: 100%; }
        .info-table th { text-align: left; padding: 10px 8px; color: var(--text-secondary); width: 30%; font-weight: 500; }
        .info-table td { padding: 10px 8px; color: var(--text-primary); }

        .trades-section { background: var(--bg-secondary); padding: 20px; border-radius: 12px;
                         box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid var(--border-color); }
        .trades-section h2 { color: var(--text-primary); font-size: 18px; margin: 0 0 15px 0; font-weight: 600; }
        .trades-table { width: 100%; border-collapse: collapse; }
        .trades-table th, .trades-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .trades-table th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-primary); }
        .trades-table td { color: var(--text-primary); }

        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;
              font-size: 14px; font-weight: 600; text-decoration: none; display: inline-block; margin-right: 10px;
              transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
                      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn-primary:hover { box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        [data-theme="dark"] .btn-primary { background: #6c757d; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3); }
        [data-theme="dark"] .btn-primary:hover { background: #5a6268; }

        .btn-secondary { background: #6c757d; color: white; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3); }
        .btn-secondary:hover { background: #5a6268; }

        .btn-danger { background: #e74c3c; color: white; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .btn-danger:hover { background: #c0392b; }
        [data-theme="dark"] .btn-danger { background: #6c757d; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3); }
        [data-theme="dark"] .btn-danger:hover { background: #5a6268; }

        .btn-success { background: #27ae60; color: white; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3); }
        .btn-success:hover { background: #229954; }
        [data-theme="dark"] .btn-success { background: #6c757d; box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3); }
        [data-theme="dark"] .btn-success:hover { background: #5a6268; }

        .monitor-actions { margin-top: 30px; }

        .alert { padding: 16px 24px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .alert-warning { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; border: 1px solid #ffeaa7; }
        .alert-success { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); color: #721c24; border: 1px solid #f5c6cb; }

        [data-theme="dark"] .alert-warning { background: linear-gradient(135deg, #3d3a1f 0%, #3d3520 100%);
                                            border: 1px solid rgba(255, 193, 7, 0.3); color: #ffc107; }
        [data-theme="dark"] .alert-success { background: linear-gradient(135deg, #1e3a27 0%, #1a3b35 100%);
                                            border: 1px solid rgba(40, 167, 69, 0.3); color: #75d99a; }
        [data-theme="dark"] .alert-error { background: linear-gradient(135deg, #3d1f22 0%, #3d2426 100%);
                                          border: 1px solid rgba(220, 53, 69, 0.3); color: #f5a5ae; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); padding: 30px; border-radius: 12px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); max-width: 500px; width: 90%;
                        border: 1px solid var(--border-color); }
        .modal-header { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        .modal-form-group { margin-bottom: 15px; }
        .modal-form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--text-primary); }
        .modal-form-group input { width: 100%; padding: 12px 14px; border: 2px solid var(--border-color); border-radius: 8px;
                                  font-size: 14px; box-sizing: border-box; background: var(--bg-tertiary);
                                  color: var(--text-primary); transition: all 0.3s ease; }
        .modal-form-group input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        [data-theme="dark"] .modal-form-group input:focus { border-color: #8b9df0; box-shadow: 0 0 0 3px rgba(139, 157, 240, 0.1); }
        .modal-form-group input::placeholder { color: var(--text-muted); }

        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-submit { flex: 1; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                     color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600;
                     cursor: pointer; transition: all 0.3s; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4); }
        [data-theme="dark"] .btn-submit { background: #6c757d; }
        [data-theme="dark"] .btn-submit:hover { background: #5a6268; box-shadow: 0 4px 10px rgba(108, 117, 125, 0.4); }

        .btn-close { flex: 1; padding: 12px; background: var(--bg-tertiary); color: var(--text-primary); border: none;
                    border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-close:hover { background: var(--border-color); }

        @media (max-width: 768px) {
            .status-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .status-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="monitor-container">
            <header>
                <h1>전략 모니터링 (Strategy Monitoring)</h1>
                <p class="subtitle" th:text="${strategy.title}"></p>
            </header>

            <!-- Status Error Alert -->
            <div th:if="${statusError}" class="alert alert-warning" th:text="${statusError}"></div>

            <!-- Success Message -->
            <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>

            <!-- Error Message -->
            <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

            <!-- Status Overview -->
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-label">Trading Status</div>
                    <div class="status-value"
                         th:text="${strategy.tradingStatus}"
                         th:classappend="${strategy.tradingStatus == 'ACTIVE'} ? 'positive' : ''">
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-label">Total Trades</div>
                    <div class="status-value" th:text="${strategy.totalTrades ?: 0}">0</div>
                </div>

                <div class="status-card">
                    <div class="status-label">Win Rate</div>
                    <div class="status-value"
                         th:text="${strategy.totalTrades > 0 ?
                                   #numbers.formatDecimal((strategy.winningTrades * 100.0 / strategy.totalTrades), 1, 1) + '%' :
                                   '0%'}">
                        0%
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-label">Total P/L</div>
                    <div class="status-value"
                         th:text="${#numbers.formatDecimal(strategy.totalProfitLoss ?: 0, 0, 0) + ' KRW'}"
                         th:classappend="${strategy.totalProfitLoss >= 0} ? 'positive' : 'negative'">
                        0 KRW
                    </div>
                </div>
            </div>

            <!-- Strategy Configuration Summary -->
            <div class="info-section">
                <h2>Configuration Summary</h2>
                <table class="info-table">
                    <tr>
                        <th>거래 계좌 (Account):</th>
                        <td th:text="${strategy.targetAccountId ?: 'Not configured'}">-</td>
                    </tr>
                    <tr>
                        <th>종목 (Symbol):</th>
                        <td th:text="${strategy.symbol ?: 'Not configured'}">-</td>
                    </tr>
                    <tr>
                        <th>자산 유형 (Asset Type):</th>
                        <td th:text="${strategy.assetType ?: 'Not configured'}">-</td>
                    </tr>
                    <tr>
                        <th>손절 (Stop Loss):</th>
                        <td>
                            <span th:text="${strategy.stopLossType}">-</span>
                            <span th:if="${strategy.stopLossValue != null}">
                                : <span th:text="${strategy.stopLossValue}"></span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>익절 (Take Profit):</th>
                        <td>
                            <span th:text="${strategy.takeProfitType}">-</span>
                            <span th:if="${strategy.takeProfitValue != null}">
                                : <span th:text="${strategy.takeProfitValue}"></span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>포지션 크기 (Position Size):</th>
                        <td>
                            <span th:text="${strategy.positionSizeType}">-</span>
                            <span th:if="${strategy.positionSizeValue != null}">
                                : <span th:text="${strategy.positionSizeValue}"></span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>최대 포지션 수 (Max Positions):</th>
                        <td th:text="${strategy.maxPositions ?: 1}">1</td>
                    </tr>
                    <tr>
                        <th>동기화 상태 (Sync Status):</th>
                        <td th:text="${strategy.syncStatus}">-</td>
                    </tr>
                    <tr th:if="${strategy.activatedAt != null}">
                        <th>활성화 시각 (Activated At):</th>
                        <td th:text="${#temporals.format(strategy.activatedAt, 'yyyy-MM-dd HH:mm:ss')}">-</td>
                    </tr>
                </table>
            </div>

            <!-- Recent Trades -->
            <div class="trades-section" th:if="${recentOrders != null}">
                <h2>Recent Trades</h2>
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>시각 (Time)</th>
                            <th>유형 (Type)</th>
                            <th>종목 (Symbol)</th>
                            <th>수량 (Qty)</th>
                            <th>가격 (Price)</th>
                            <th>상태 (Status)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="order : ${recentOrders}">
                            <td th:text="${order.createdAt}">-</td>
                            <td th:text="${order.orderType}">-</td>
                            <td th:text="${order.symbol}">-</td>
                            <td th:text="${order.quantity}">-</td>
                            <td th:text="${order.price}">-</td>
                            <td th:text="${order.status}">-</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(recentOrders)}">
                            <td colspan="6" style="text-align: center; color: #999;">No trades yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Actions -->
            <div class="monitor-actions">
                <button type="button" class="btn btn-success" onclick="openExecuteModal()">
                    수동 실행 (Execute Strategy)
                </button>

                <a th:href="@{/trading/strategies/{id}/trading(id=${strategy.id})}"
                   class="btn btn-primary">설정 수정 (Edit Configuration)</a>

                <form th:if="${strategy.tradingStatus == 'ACTIVE'}"
                      th:action="@{/trading/strategies/{id}/deactivate(id=${strategy.id})}"
                      method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger"
                            onclick="return confirm('자동매매를 중지하시겠습니까? (Deactivate auto-trading?)')">
                        자동매매 중지 (Deactivate Trading)
                    </button>
                </form>

                <a th:href="@{/trading/strategies}" class="btn btn-secondary">목록으로 (Back to List)</a>
            </div>

            <!-- Execute Strategy Modal -->
            <div id="executeModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">전략 수동 실행</div>
                    <form th:action="@{/trading/strategies/{id}/execute(id=${strategy.id})}" method="post">
                        <div class="modal-form-group">
                            <label for="symbol">종목 코드 <span style="color: red;">*</span></label>
                            <input type="text" id="symbol" name="symbol" required
                                   th:value="${strategy.symbol}"
                                   placeholder="예: 005930">
                        </div>
                        <div class="modal-form-group">
                            <label for="accountId">계좌 ID <span style="color: red;">*</span></label>
                            <input type="text" id="accountId" name="accountId" required
                                   th:value="${strategy.targetAccountId}"
                                   placeholder="예: ACC_001">
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn-submit">실행</button>
                            <button type="button" class="btn-close" onclick="closeExecuteModal()">취소</button>
                        </div>
                    </form>
                </div>
            </div>

            <script>
                function openExecuteModal() {
                    document.getElementById('executeModal').classList.add('active');
                }

                function closeExecuteModal() {
                    document.getElementById('executeModal').classList.remove('active');
                }

                // Click outside modal to close
                document.getElementById('executeModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeExecuteModal();
                    }
                });
            </script>
        </div>
    </div>
</body>
</html>

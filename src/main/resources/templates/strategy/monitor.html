<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Strategy Monitoring</title>
    <style>
        .monitor-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .status-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .status-card { background: #fff; padding: 20px; border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status-label { color: #666; font-size: 14px; margin-bottom: 5px; }
        .status-value { font-size: 28px; font-weight: 700; }
        .status-value.positive { color: #27ae60; }
        .status-value.negative { color: #e74c3c; }
        .info-section { background: #fff; padding: 20px; border-radius: 8px;
                       box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .info-table { width: 100%; }
        .info-table th { text-align: left; padding: 8px; color: #666; width: 30%; }
        .info-table td { padding: 8px; }
        .trades-section { background: #fff; padding: 20px; border-radius: 8px;
                         box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .trades-table { width: 100%; border-collapse: collapse; }
        .trades-table th, .trades-table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .trades-table th { background: #f8f9fa; font-weight: 600; }
        .btn { padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer;
              font-size: 14px; text-decoration: none; display: inline-block; margin-right: 10px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .monitor-actions { margin-top: 30px; }
        .alert { padding: 12px 20px; border-radius: 4px; margin-bottom: 15px; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="monitor-container">
            <header>
                <h1>전략 모니터링 (Strategy Monitoring)</h1>
                <p class="subtitle" th:text="${strategy.title}"></p>
            </header>

            <!-- Status Error Alert -->
            <div th:if="${statusError}" class="alert alert-warning" th:text="${statusError}"></div>

            <!-- Status Overview -->
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-label">Trading Status</div>
                    <div class="status-value"
                         th:text="${strategy.tradingStatus}"
                         th:classappend="${strategy.tradingStatus == 'ACTIVE'} ? 'positive' : ''">
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-label">Total Trades</div>
                    <div class="status-value" th:text="${strategy.totalTrades ?: 0}">0</div>
                </div>

                <div class="status-card">
                    <div class="status-label">Win Rate</div>
                    <div class="status-value"
                         th:text="${strategy.totalTrades > 0 ?
                                   #numbers.formatDecimal((strategy.winningTrades * 100.0 / strategy.totalTrades), 1, 1) + '%' :
                                   '0%'}">
                        0%
                    </div>
                </div>

                <div class="status-card">
                    <div class="status-label">Total P/L</div>
                    <div class="status-value"
                         th:text="${#numbers.formatDecimal(strategy.totalProfitLoss ?: 0, 0, 0) + ' KRW'}"
                         th:classappend="${strategy.totalProfitLoss >= 0} ? 'positive' : 'negative'">
                        0 KRW
                    </div>
                </div>
            </div>

            <!-- Strategy Configuration Summary -->
            <div class="info-section">
                <h2>Configuration Summary</h2>
                <table class="info-table">
                    <tr>
                        <th>거래 계좌 (Account):</th>
                        <td th:text="${strategy.targetAccountId ?: 'Not configured'}">-</td>
                    </tr>
                    <tr>
                        <th>종목 (Symbol):</th>
                        <td th:text="${strategy.symbol ?: 'Not configured'}">-</td>
                    </tr>
                    <tr>
                        <th>자산 유형 (Asset Type):</th>
                        <td th:text="${strategy.assetType ?: 'Not configured'}">-</td>
                    </tr>
                    <tr>
                        <th>손절 (Stop Loss):</th>
                        <td>
                            <span th:text="${strategy.stopLossType}">-</span>
                            <span th:if="${strategy.stopLossValue != null}">
                                : <span th:text="${strategy.stopLossValue}"></span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>익절 (Take Profit):</th>
                        <td>
                            <span th:text="${strategy.takeProfitType}">-</span>
                            <span th:if="${strategy.takeProfitValue != null}">
                                : <span th:text="${strategy.takeProfitValue}"></span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>포지션 크기 (Position Size):</th>
                        <td>
                            <span th:text="${strategy.positionSizeType}">-</span>
                            <span th:if="${strategy.positionSizeValue != null}">
                                : <span th:text="${strategy.positionSizeValue}"></span>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>최대 포지션 수 (Max Positions):</th>
                        <td th:text="${strategy.maxPositions ?: 1}">1</td>
                    </tr>
                    <tr>
                        <th>동기화 상태 (Sync Status):</th>
                        <td th:text="${strategy.syncStatus}">-</td>
                    </tr>
                    <tr th:if="${strategy.activatedAt != null}">
                        <th>활성화 시각 (Activated At):</th>
                        <td th:text="${#temporals.format(strategy.activatedAt, 'yyyy-MM-dd HH:mm:ss')}">-</td>
                    </tr>
                </table>
            </div>

            <!-- Recent Trades -->
            <div class="trades-section" th:if="${recentOrders != null}">
                <h2>Recent Trades</h2>
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>시각 (Time)</th>
                            <th>유형 (Type)</th>
                            <th>종목 (Symbol)</th>
                            <th>수량 (Qty)</th>
                            <th>가격 (Price)</th>
                            <th>상태 (Status)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="order : ${recentOrders}">
                            <td th:text="${order.createdAt}">-</td>
                            <td th:text="${order.orderType}">-</td>
                            <td th:text="${order.symbol}">-</td>
                            <td th:text="${order.quantity}">-</td>
                            <td th:text="${order.price}">-</td>
                            <td th:text="${order.status}">-</td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(recentOrders)}">
                            <td colspan="6" style="text-align: center; color: #999;">No trades yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Actions -->
            <div class="monitor-actions">
                <a th:href="@{/trading/strategies/{id}/trading(id=${strategy.id})}"
                   class="btn btn-primary">설정 수정 (Edit Configuration)</a>

                <form th:if="${strategy.tradingStatus == 'ACTIVE'}"
                      th:action="@{/trading/strategies/{id}/deactivate(id=${strategy.id})}"
                      method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger"
                            onclick="return confirm('자동매매를 중지하시겠습니까? (Deactivate auto-trading?)')">
                        자동매매 중지 (Deactivate Trading)
                    </button>
                </form>

                <a th:href="@{/trading/strategies}" class="btn btn-secondary">목록으로 (Back to List)</a>
            </div>
        </div>
    </div>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Kanban Board</title>
    <link rel="stylesheet" th:href="@{/css/kanban.css}">
</head>
<body>
<div layout:fragment="content">
    <div class="kanban-container">
        <!-- Header -->
        <div class="kanban-header">
            <h2>칸반 보드</h2>

            <!-- Project Selection -->
            <div class="project-controls">
                <select id="projectSelector" class="form-control"
                        onchange="location.href='/kanban?projectId=' + this.value">
                    <option value="">프로젝트 선택</option>
                    <option th:each="project : ${projects}"
                            th:value="${project.id}"
                            th:text="${project.name}"
                            th:selected="${selectedProject != null && selectedProject.id == project.id}">
                        Project
                    </option>
                </select>

                <div class="project-buttons">
                    <a th:href="@{/kanban/projects/new}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 새 프로젝트
                    </a>
                    <a th:if="${selectedProject != null}"
                       th:href="@{/kanban/projects/{id}/edit(id=${selectedProject.id})}"
                       class="btn btn-secondary">
                        <i class="fas fa-edit"></i> 수정
                    </a>
                    <form th:if="${selectedProject != null}"
                          th:action="@{/kanban/projects/{id}/delete(id=${selectedProject.id})}"
                          method="post"
                          style="display: inline;"
                          onsubmit="return confirm('프로젝트를 삭제하시겠습니까? (모든 태스크도 삭제됩니다)')">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> 삭제
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Project Info -->
        <div th:if="${selectedProject != null}" class="project-info">
            <div class="project-name">
                <span class="project-color" th:style="'background-color: ' + ${selectedProject.color}"></span>
                <strong th:text="${selectedProject.name}">Project Name</strong>
            </div>
            <div class="project-path">
                <i class="fas fa-folder"></i>
                <code th:text="${selectedProject.directoryPath}">~/projects/example</code>
            </div>
            <p th:if="${selectedProject.description}"
               class="project-description"
               th:text="${selectedProject.description}">
                Description
            </p>
        </div>

        <!-- Quick Add Task Form -->
        <div th:if="${selectedProject != null}" class="quick-add-task">
            <form th:action="@{/kanban/tasks}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                <!-- Row 1: Title, Priority, Add Button -->
                <div class="quick-add-row-1">
                    <input type="text" name="title" class="form-control title-input"
                           placeholder="새 태스크 제목..." required tabindex="1">
                    <select name="priority" class="form-control priority-select" tabindex="3">
                        <option value="LOW">낮음</option>
                        <option value="MEDIUM" selected>보통</option>
                        <option value="HIGH">높음</option>
                    </select>
                    <button type="submit" class="btn btn-success" tabindex="4">
                        <i class="fas fa-plus"></i> 등록
                    </button>
                </div>
                <!-- Row 2: Description -->
                <div class="quick-add-row-2">
                    <textarea name="description" class="form-control description-input" rows="3"
                              placeholder="새 태스크 내용..." tabindex="2"></textarea>
                </div>
                <!-- Row 3: File Upload (Single Row) -->
                <div class="quick-add-row-3">
                    <label class="file-upload-label" for="quick-file-upload">
                        <i class="fas fa-paperclip"></i> 파일 첨부 (선택사항)
                    </label>
                    <input type="file" id="quick-file-upload" name="file" class="form-control file-input"
                           accept=".txt,.md,.pdf,.doc,.docx,.png,.jpg,.jpeg">
                </div>
            </form>
        </div>

        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="alert alert-success" role="alert">
            <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
            <span th:text="${errorMessage}"></span>
        </div>

        <!-- Kanban Board -->
        <div th:if="${selectedProject != null}" class="kanban-board">
            <!-- REGISTERED Column -->
            <div th:each="status : ${statuses}" th:if="${status.name() == 'REGISTERED'}" class="kanban-column">
                <div class="column-header" th:classappend="${status.name()}">
                    <h3 th:text="${status.koreanName}">Status</h3>
                    <span class="task-count"
                          th:text="${tasksByStatus.get(status.name()).size()}">0</span>
                </div>

                <div class="column-body">
                    <!-- Task Cards -->
                    <div th:each="task : ${tasksByStatus.get(status.name())}" class="task-card" th:data-task-id="${task.id}">
                        <div class="task-header">
                            <span class="task-priority" th:classappend="${task.priority.toLowerCase()}">
                                <span class="task-id">#<span th:text="${task.taskNumber}">1</span></span>
                                <span th:text="${task.priority == 'LOW' ? '낮음' : task.priority == 'MEDIUM' ? '보통' : '높음'}">Priority</span>
                            </span>
                            <div class="task-actions">
                                <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                   class="btn-icon" title="조회">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                   class="btn-icon" title="수정">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form th:action="@{/kanban/tasks/{id}/delete(id=${task.id})}"
                                      method="post"
                                      style="display: inline;"
                                      onsubmit="return confirm('태스크를 삭제하시겠습니까?')">
                                    <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                    <button type="submit" class="btn-icon" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Inline Editable Title (REGISTERED only) -->
                        <div class="task-title-wrapper editable-wrapper" th:data-task-id="${task.id}">
                            <h4 class="task-title editable-content" th:text="${task.title}">Task Title</h4>
                            <textarea class="task-title-edit edit-input" style="display: none;" th:text="${task.title}"></textarea>
                            <button type="button" class="btn-inline-edit" onclick="toggleInlineEdit(this)" title="수정">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>

                        <!-- Inline Editable Description (REGISTERED only) -->
                        <div class="task-desc-wrapper editable-wrapper" th:data-task-id="${task.id}">
                            <p th:if="${task.description}" class="task-description editable-content" th:text="${task.description}">Description</p>
                            <p th:unless="${task.description}" class="task-description editable-content empty-desc">설명 없음</p>
                            <textarea class="task-desc-edit edit-input" style="display: none;" th:text="${task.description}" placeholder="설명을 입력하세요..."></textarea>
                            <button type="button" class="btn-inline-edit" onclick="toggleInlineEdit(this)" title="수정">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>

                        <!-- File Attachment -->
                        <div th:if="${task.hasFile()}" class="task-file">
                            <i class="fas fa-paperclip"></i>
                            <!-- Image file: Preview -->
                            <a th:if="${task.isImageFile()}"
                               href="javascript:void(0)"
                               th:data-task-id="${task.id}"
                               th:data-file-name="${task.fileOriginalName}"
                               class="image-preview-link"
                               onclick="openImagePreview(this)"
                               th:text="${task.fileOriginalName}">
                                image.png
                            </a>
                            <!-- Non-image file: Download -->
                            <a th:unless="${task.isImageFile()}"
                               th:href="@{/kanban/tasks/{id}/download(id=${task.id})}"
                               th:text="${task.fileOriginalName}">
                                file.pdf
                            </a>
                            <form th:action="@{/kanban/tasks/{id}/delete-file(id=${task.id})}"
                                  method="post"
                                  style="display: inline;"
                                  onsubmit="return confirm('파일을 삭제하시겠습니까?')">
                                <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                <button type="submit" class="btn-icon-small" title="파일 삭제">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>

                        <!-- Automation Notes -->
                        <div th:if="${task.automationNotes}" class="task-notes">
                            <small>
                                <i class="fas fa-robot"></i>
                                <span th:text="${task.automationNotes}">Automation notes</span>
                            </small>
                        </div>

                        <!-- Comments Section (WAITING_RESPONSE only) -->
                        <div th:if="${status.name() == 'WAITING_RESPONSE'}" class="task-comments">
                            <div class="comment-header">
                                <i class="fas fa-comments"></i>
                                <span>사용자 의견</span>
                            </div>
                            <!-- Existing Comments List -->
                            <div th:if="${commentsByTaskId != null && commentsByTaskId.get(task.id) != null && !commentsByTaskId.get(task.id).isEmpty()}" class="comments-list">
                                <div th:each="comment : ${commentsByTaskId.get(task.id)}" class="comment-item">
                                    <div class="comment-text" th:text="${comment.commentText}">Comment text</div>
                                    <div class="comment-meta">
                                        <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'MM-dd HH:mm')}">01-15 10:30</span>
                                        <form th:action="@{/kanban/comments/{id}/delete(id=${comment.id})}"
                                              method="post"
                                              style="display: inline;"
                                              onsubmit="return confirm('댓글을 삭제하시겠습니까?')">
                                            <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                            <button type="submit" class="btn-icon-tiny" title="삭제">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- Comment Input Form -->
                            <form th:action="@{/kanban/tasks/{id}/comments(id=${task.id})}"
                                  method="post"
                                  class="comment-form">
                                <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                <textarea name="commentText"
                                          class="comment-input"
                                          placeholder="이 태스크에 대한 의견이나 지시사항을 입력하세요..."
                                          rows="3"
                                          required></textarea>
                                <button type="submit" class="btn btn-sm btn-primary">
                                    <i class="fas fa-paper-plane"></i> 의견 제출
                                </button>
                            </form>
                        </div>

                        <!-- Status Change Buttons -->
                        <div class="task-footer">
                            <div class="task-footer-buttons">
                                <!-- Next Status Button -->
                                <form th:if="${status.name() != 'COMPLETED'}"
                                      th:action="@{/kanban/tasks/{id}/status(id=${task.id})}"
                                      method="post"
                                      style="display: inline;">
                                    <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                    <input type="hidden" name="status"
                                           th:value="${status.name() == 'REGISTERED' ? 'WAITING_RESPONSE' :
                                                      status.name() == 'WAITING_RESPONSE' ? 'IN_PROGRESS' :
                                                      'COMPLETED'}">
                                    <button type="submit" class="btn btn-sm btn-move">
                                        <i class="fas fa-arrow-right"></i>
                                        <span th:text="${status.name() == 'REGISTERED' ? '응답대기중으로' :
                                                        status.name() == 'WAITING_RESPONSE' ? '진행중으로' :
                                                        '완료'}">
                                            Move
                                        </span>
                                    </button>
                                </form>

                                <!-- Quick Complete Button (only for REGISTERED and WAITING_RESPONSE) -->
                                <form th:if="${status.name() == 'REGISTERED' || status.name() == 'WAITING_RESPONSE'}"
                                      th:action="@{/kanban/tasks/{id}/status(id=${task.id})}"
                                      method="post"
                                      style="display: inline;">
                                    <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                    <input type="hidden" name="status" value="COMPLETED">
                                    <button type="submit" class="btn btn-sm btn-complete">
                                        <i class="fas fa-check-circle"></i>
                                        완료로
                                    </button>
                                </form>
                            </div>

                            <small class="task-date" th:text="'생성일: ' + ${#temporals.format(task.createdAt, 'yyyy-MM-dd')}">
                                Created: 2024-01-07
                            </small>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div th:if="${tasksByStatus.get(status.name()).isEmpty()}" class="empty-column">
                        <i class="fas fa-inbox"></i>
                        <p>태스크가 없습니다</p>
                    </div>
                </div>
            </div>

            <!-- WAITING_RESPONSE + IN_PROGRESS Wrapper -->
            <div class="kanban-column-wrapper">
                <!-- WAITING_RESPONSE Column -->
                <div th:each="status : ${statuses}" th:if="${status.name() == 'WAITING_RESPONSE'}" class="kanban-column kanban-column-half">
                    <div class="column-header" th:classappend="${status.name()}">
                        <h3 th:text="${status.koreanName}">Status</h3>
                        <span class="task-count"
                              th:text="${tasksByStatus.get(status.name()).size()}">0</span>
                    </div>

                    <div class="column-body">
                        <!-- Task Cards -->
                        <div th:each="task : ${tasksByStatus.get(status.name())}" class="task-card" th:data-task-id="${task.id}">
                            <div class="task-header">
                                <span class="task-priority" th:classappend="${task.priority.toLowerCase()}">
                                    <span class="task-id">#<span th:text="${task.taskNumber}">1</span></span>
                                    <span th:text="${task.priority == 'LOW' ? '낮음' : task.priority == 'MEDIUM' ? '보통' : '높음'}">Priority</span>
                                </span>
                                <div class="task-actions">
                                    <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                       class="btn-icon" title="조회">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                       class="btn-icon" title="수정">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form th:action="@{/kanban/tasks/{id}/delete(id=${task.id})}"
                                          method="post"
                                          style="display: inline;"
                                          onsubmit="return confirm('태스크를 삭제하시겠습니까?')">
                                        <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                        <button type="submit" class="btn-icon" title="삭제">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <!-- Inline Editable Title (WAITING_RESPONSE) -->
                            <div class="task-title-wrapper editable-wrapper" th:data-task-id="${task.id}">
                                <h4 class="task-title editable-content" th:text="${task.title}">Task Title</h4>
                                <textarea class="task-title-edit edit-input" style="display: none;" th:text="${task.title}"></textarea>
                                <button type="button" class="btn-inline-edit" onclick="toggleInlineEdit(this)" title="수정">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>

                            <!-- Inline Editable Description (WAITING_RESPONSE) -->
                            <div class="task-desc-wrapper editable-wrapper" th:data-task-id="${task.id}">
                                <p th:if="${task.description}" class="task-description editable-content" th:text="${task.description}">Description</p>
                                <p th:unless="${task.description}" class="task-description editable-content empty-desc">설명 없음</p>
                                <textarea class="task-desc-edit edit-input" style="display: none;" th:text="${task.description}" placeholder="설명을 입력하세요..."></textarea>
                                <button type="button" class="btn-inline-edit" onclick="toggleInlineEdit(this)" title="수정">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>

                            <!-- File Attachment -->
                            <div th:if="${task.hasFile()}" class="task-file">
                                <i class="fas fa-paperclip"></i>
                                <a th:href="@{/kanban/tasks/{id}/download(id=${task.id})}"
                                   th:text="${task.fileOriginalName}">
                                    file.pdf
                                </a>
                                <form th:action="@{/kanban/tasks/{id}/delete-file(id=${task.id})}"
                                      method="post"
                                      style="display: inline;"
                                      onsubmit="return confirm('파일을 삭제하시겠습니까?')">
                                    <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                    <button type="submit" class="btn-icon-small" title="파일 삭제">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>

                            <!-- Automation Notes -->
                            <div th:if="${task.automationNotes}" class="task-notes">
                                <small>
                                    <i class="fas fa-robot"></i>
                                    <span th:text="${task.automationNotes}">Automation notes</span>
                                </small>
                            </div>

                            <!-- Comments Section (WAITING_RESPONSE only) -->
                            <div th:if="${status.name() == 'WAITING_RESPONSE'}" class="task-comments">
                                <div class="comment-header">
                                    <i class="fas fa-comments"></i>
                                    <span>사용자 의견</span>
                                </div>
                                <!-- Existing Comments List -->
                                <div th:if="${commentsByTaskId != null && commentsByTaskId.get(task.id) != null && !commentsByTaskId.get(task.id).isEmpty()}" class="comments-list">
                                    <div th:each="comment : ${commentsByTaskId.get(task.id)}" class="comment-item">
                                        <div class="comment-text" th:text="${comment.commentText}">Comment text</div>
                                        <div class="comment-meta">
                                            <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'MM-dd HH:mm')}">01-15 10:30</span>
                                            <form th:action="@{/kanban/comments/{id}/delete(id=${comment.id})}"
                                                  method="post"
                                                  style="display: inline;"
                                                  onsubmit="return confirm('댓글을 삭제하시겠습니까?')">
                                                <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                                <button type="submit" class="btn-icon-tiny" title="삭제">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <!-- Comment Input Form -->
                                <form th:action="@{/kanban/tasks/{id}/comments(id=${task.id})}"
                                      method="post"
                                      class="comment-form">
                                    <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                    <textarea name="commentText"
                                              class="comment-input"
                                              placeholder="이 태스크에 대한 의견이나 지시사항을 입력하세요..."
                                              rows="3"
                                              required></textarea>
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-paper-plane"></i> 의견 제출
                                    </button>
                                </form>
                            </div>

                            <!-- Status Change Buttons -->
                            <div class="task-footer">
                                <div class="task-footer-buttons">
                                    <!-- Next Status Button -->
                                    <form th:if="${status.name() != 'COMPLETED'}"
                                          th:action="@{/kanban/tasks/{id}/status(id=${task.id})}"
                                          method="post"
                                          style="display: inline;">
                                        <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                        <input type="hidden" name="status"
                                               th:value="${status.name() == 'REGISTERED' ? 'WAITING_RESPONSE' :
                                                          status.name() == 'WAITING_RESPONSE' ? 'IN_PROGRESS' :
                                                          'COMPLETED'}">
                                        <button type="submit" class="btn btn-sm btn-move">
                                            <i class="fas fa-arrow-right"></i>
                                            <span th:text="${status.name() == 'REGISTERED' ? '응답대기중으로' :
                                                            status.name() == 'WAITING_RESPONSE' ? '진행중으로' :
                                                            '완료'}">
                                                Move
                                            </span>
                                        </button>
                                    </form>

                                    <!-- Quick Complete Button (only for REGISTERED and WAITING_RESPONSE) -->
                                    <form th:if="${status.name() == 'REGISTERED' || status.name() == 'WAITING_RESPONSE'}"
                                          th:action="@{/kanban/tasks/{id}/status(id=${task.id})}"
                                          method="post"
                                          style="display: inline;">
                                        <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                        <input type="hidden" name="status" value="COMPLETED">
                                        <button type="submit" class="btn btn-sm btn-complete">
                                            <i class="fas fa-check-circle"></i>
                                            완료로
                                        </button>
                                    </form>
                                </div>

                                <small class="task-date" th:text="'생성일: ' + ${#temporals.format(task.createdAt, 'yyyy-MM-dd')}">
                                    Created: 2024-01-07
                                </small>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${tasksByStatus.get(status.name()).isEmpty()}" class="empty-column">
                            <i class="fas fa-inbox"></i>
                            <p>태스크가 없습니다</p>
                        </div>
                    </div>
                </div>

                <!-- IN_PROGRESS Column -->
                <div th:each="status : ${statuses}" th:if="${status.name() == 'IN_PROGRESS'}" class="kanban-column kanban-column-half">
                    <div class="column-header" th:classappend="${status.name()}">
                        <h3 th:text="${status.koreanName}">Status</h3>
                        <span class="task-count"
                              th:text="${tasksByStatus.get(status.name()).size()}">0</span>
                    </div>

                    <div class="column-body">
                        <!-- Task Cards -->
                        <div th:each="task : ${tasksByStatus.get(status.name())}" class="task-card" th:data-task-id="${task.id}">
                            <div class="task-header">
                                <span class="task-priority" th:classappend="${task.priority.toLowerCase()}">
                                    <span class="task-id">#<span th:text="${task.taskNumber}">1</span></span>
                                    <span th:text="${task.priority == 'LOW' ? '낮음' : task.priority == 'MEDIUM' ? '보통' : '높음'}">Priority</span>
                                </span>
                                <div class="task-actions">
                                    <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                       class="btn-icon" title="조회">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                       class="btn-icon" title="수정">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <form th:action="@{/kanban/tasks/{id}/delete(id=${task.id})}"
                                          method="post"
                                          style="display: inline;"
                                          onsubmit="return confirm('태스크를 삭제하시겠습니까?')">
                                        <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                        <button type="submit" class="btn-icon" title="삭제">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <h4 class="task-title" th:text="${task.title}">Task Title</h4>

                            <p th:if="${task.description}"
                               class="task-description"
                               th:text="${task.description}">
                                Description
                            </p>

                            <!-- File Attachment -->
                            <div th:if="${task.hasFile()}" class="task-file">
                                <i class="fas fa-paperclip"></i>
                                <!-- Image file: Preview -->
                                <a th:if="${task.isImageFile()}"
                                   href="javascript:void(0)"
                                   th:data-task-id="${task.id}"
                                   th:data-file-name="${task.fileOriginalName}"
                                   class="image-preview-link"
                                   onclick="openImagePreview(this)"
                                   th:text="${task.fileOriginalName}">
                                    image.png
                                </a>
                                <!-- Non-image file: Download -->
                                <a th:unless="${task.isImageFile()}"
                                   th:href="@{/kanban/tasks/{id}/download(id=${task.id})}"
                                   th:text="${task.fileOriginalName}">
                                    file.pdf
                                </a>
                                <form th:action="@{/kanban/tasks/{id}/delete-file(id=${task.id})}"
                                      method="post"
                                      style="display: inline;"
                                      onsubmit="return confirm('파일을 삭제하시겠습니까?')">
                                    <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                    <button type="submit" class="btn-icon-small" title="파일 삭제">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                            </div>

                            <!-- Automation Notes -->
                            <div th:if="${task.automationNotes}" class="task-notes">
                                <small>
                                    <i class="fas fa-robot"></i>
                                    <span th:text="${task.automationNotes}">Automation notes</span>
                                </small>
                            </div>

                            <!-- Status Change Buttons -->
                            <div class="task-footer">
                                <div class="task-footer-buttons">
                                    <!-- Next Status Button -->
                                    <form th:if="${status.name() != 'COMPLETED'}"
                                          th:action="@{/kanban/tasks/{id}/status(id=${task.id})}"
                                          method="post"
                                          style="display: inline;">
                                        <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                        <input type="hidden" name="status"
                                               th:value="${status.name() == 'REGISTERED' ? 'WAITING_RESPONSE' :
                                                          status.name() == 'WAITING_RESPONSE' ? 'IN_PROGRESS' :
                                                          'COMPLETED'}">
                                        <button type="submit" class="btn btn-sm btn-move">
                                            <i class="fas fa-arrow-right"></i>
                                            <span th:text="${status.name() == 'REGISTERED' ? '응답대기중으로' :
                                                            status.name() == 'WAITING_RESPONSE' ? '진행중으로' :
                                                            '완료'}">
                                                Move
                                            </span>
                                        </button>
                                    </form>
                                </div>

                                <small class="task-date" th:text="'생성일: ' + ${#temporals.format(task.createdAt, 'yyyy-MM-dd')}">
                                    Created: 2024-01-07
                                </small>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div th:if="${tasksByStatus.get(status.name()).isEmpty()}" class="empty-column">
                            <i class="fas fa-inbox"></i>
                            <p>태스크가 없습니다</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COMPLETED Column -->
            <div th:each="status : ${statuses}" th:if="${status.name() == 'COMPLETED'}" class="kanban-column">
                <div class="column-header" th:classappend="${status.name()}">
                    <h3 th:text="${status.koreanName}">Status</h3>
                    <span class="task-count"
                          th:text="${tasksByStatus.get(status.name()).size()}">0</span>
                </div>

                <div class="column-body">
                    <!-- Task Cards -->
                    <div th:each="task : ${tasksByStatus.get(status.name())}" class="task-card" th:data-task-id="${task.id}">
                        <div class="task-header">
                            <span class="task-priority" th:classappend="${task.priority.toLowerCase()}">
                                <span class="task-id">#<span th:text="${task.taskNumber}">1</span></span>
                                <span th:text="${task.priority == 'LOW' ? '낮음' : task.priority == 'MEDIUM' ? '보통' : '높음'}">Priority</span>
                            </span>
                            <div class="task-actions">
                                <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                   class="btn-icon" title="조회">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a th:href="@{/kanban/tasks/{id}/edit(id=${task.id})}"
                                   class="btn-icon" title="수정">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form th:action="@{/kanban/tasks/{id}/delete(id=${task.id})}"
                                      method="post"
                                      style="display: inline;"
                                      onsubmit="return confirm('태스크를 삭제하시겠습니까?')">
                                    <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                    <button type="submit" class="btn-icon" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <h4 class="task-title" th:text="${task.title}">Task Title</h4>

                        <p th:if="${task.description}"
                           class="task-description"
                           th:text="${task.description}">
                            Description
                        </p>

                        <!-- File Attachment -->
                        <div th:if="${task.hasFile()}" class="task-file">
                            <i class="fas fa-paperclip"></i>
                            <!-- Image file: Preview -->
                            <a th:if="${task.isImageFile()}"
                               href="javascript:void(0)"
                               th:data-task-id="${task.id}"
                               th:data-file-name="${task.fileOriginalName}"
                               class="image-preview-link"
                               onclick="openImagePreview(this)"
                               th:text="${task.fileOriginalName}">
                                image.png
                            </a>
                            <!-- Non-image file: Download -->
                            <a th:unless="${task.isImageFile()}"
                               th:href="@{/kanban/tasks/{id}/download(id=${task.id})}"
                               th:text="${task.fileOriginalName}">
                                file.pdf
                            </a>
                            <form th:action="@{/kanban/tasks/{id}/delete-file(id=${task.id})}"
                                  method="post"
                                  style="display: inline;"
                                  onsubmit="return confirm('파일을 삭제하시겠습니까?')">
                                <input type="hidden" name="projectId" th:value="${selectedProject.id}">
                                <button type="submit" class="btn-icon-small" title="파일 삭제">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                        </div>

                        <!-- Automation Notes -->
                        <div th:if="${task.automationNotes}" class="task-notes">
                            <small>
                                <i class="fas fa-robot"></i>
                                <span th:text="${task.automationNotes}">Automation notes</span>
                            </small>
                        </div>

                        <!-- Status Change Buttons -->
                        <div class="task-footer">
                            <small class="task-date" th:text="'생성일: ' + ${#temporals.format(task.createdAt, 'yyyy-MM-dd')}">
                                Created: 2024-01-07
                            </small>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div th:if="${tasksByStatus.get(status.name()).isEmpty()}" class="empty-column">
                        <i class="fas fa-inbox"></i>
                        <p>태스크가 없습니다</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Project Selected State -->
        <div th:if="${selectedProject == null}" class="empty-state">
            <i class="fas fa-clipboard-list"></i>
            <h3>프로젝트를 선택하거나 생성하세요</h3>
            <p>칸반 보드로 프로젝트 태스크를 관리하세요</p>
            <a th:href="@{/kanban/projects/new}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i> 새 프로젝트 만들기
            </a>
        </div>
    </div>

    <!-- Clipboard Paste & Drag-Drop File Upload Script -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.querySelector('.quick-add-task input[type="file"]');
            const quickAddForm = document.querySelector('.quick-add-task form');

            if (!fileInput || !quickAddForm) return;

            // Create paste area indicator
            const pasteIndicator = document.createElement('div');
            pasteIndicator.className = 'paste-indicator';
            pasteIndicator.innerHTML = '<i class="fas fa-paste"></i> Ctrl+V로 캡처 이미지 붙여넣기 가능';
            pasteIndicator.style.display = 'none';
            fileInput.parentNode.insertBefore(pasteIndicator, fileInput.nextSibling);

            // Show paste indicator when file input is focused
            fileInput.addEventListener('focus', function() {
                pasteIndicator.style.display = 'block';
            });

            fileInput.addEventListener('blur', function() {
                setTimeout(() => {
                    pasteIndicator.style.display = 'none';
                }, 200);
            });

            // Clipboard paste handler
            document.addEventListener('paste', function(e) {
                // Only handle paste when quick add form is visible
                if (!quickAddForm.offsetParent) return;

                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();

                        const blob = items[i].getAsFile();
                        const timestamp = new Date().getTime();
                        const fileName = 'screenshot_' + timestamp + '.png';

                        // Create File object from blob
                        const file = new File([blob], fileName, { type: 'image/png' });

                        // Create DataTransfer to set file input value
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;

                        // Show success message
                        showPasteSuccess(fileName);
                        break;
                    }
                }
            });

            // Drag and drop handlers
            const dropZone = quickAddForm;

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    // Only take first file
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    fileInput.files = dataTransfer.files;

                    showPasteSuccess(files[0].name);
                }
            });

            // Show paste success message
            function showPasteSuccess(fileName) {
                const successMsg = document.createElement('div');
                successMsg.className = 'paste-success';
                successMsg.innerHTML = '<i class="fas fa-check-circle"></i> ' + fileName + ' 첨부됨';
                fileInput.parentNode.insertBefore(successMsg, fileInput.nextSibling);

                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
            }
        });

        // Image Preview Modal Functions
        function openImagePreview(element) {
            const taskId = element.getAttribute('data-task-id');
            const fileName = element.getAttribute('data-file-name');
            const previewUrl = '/kanban/tasks/' + taskId + '/preview';

            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'image-preview-overlay';
            overlay.onclick = function(e) {
                if (e.target === overlay) {
                    closeImagePreview();
                }
            };

            // Create modal content
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';

            // Header with filename and close button
            const header = document.createElement('div');
            header.className = 'image-preview-header';
            header.innerHTML = '<span class="image-preview-title">' + fileName + '</span>' +
                '<button class="image-preview-close" onclick="closeImagePreview()">' +
                '<i class="fas fa-times"></i></button>';

            // Image container
            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-preview-container';

            // Loading spinner
            const spinner = document.createElement('div');
            spinner.className = 'image-preview-loading';
            spinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 이미지 로딩 중...';
            imgContainer.appendChild(spinner);

            // Image
            const img = document.createElement('img');
            img.className = 'image-preview-img';
            img.src = previewUrl;
            img.alt = fileName;
            img.onload = function() {
                spinner.style.display = 'none';
                img.style.display = 'block';
            };
            img.onerror = function() {
                spinner.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 이미지를 불러올 수 없습니다';
            };
            imgContainer.appendChild(img);

            // Download button
            const footer = document.createElement('div');
            footer.className = 'image-preview-footer';
            footer.innerHTML = '<a href="/kanban/tasks/' + taskId + '/download" class="btn btn-primary">' +
                '<i class="fas fa-download"></i> 다운로드</a>';

            modal.appendChild(header);
            modal.appendChild(imgContainer);
            modal.appendChild(footer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Add escape key listener
            document.addEventListener('keydown', handleEscapeKey);
        }

        function closeImagePreview() {
            const overlay = document.querySelector('.image-preview-overlay');
            if (overlay) {
                overlay.remove();
            }
            document.removeEventListener('keydown', handleEscapeKey);
        }

        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeImagePreview();
            }
        }

        // ===== Drag and Drop Functionality =====
        document.addEventListener('DOMContentLoaded', function() {
            initDragAndDrop();
        });

        function initDragAndDrop() {
            // Make all task cards draggable
            const taskCards = document.querySelectorAll('.task-card');
            taskCards.forEach(card => {
                card.setAttribute('draggable', 'true');

                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            });

            // Setup drop zones (column bodies)
            const columnBodies = document.querySelectorAll('.column-body');
            columnBodies.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        let draggedCard = null;

        function handleDragStart(e) {
            draggedCard = this;
            this.classList.add('dragging');

            // Set drag data (use data-task-id attribute for actual ID)
            const taskId = this.getAttribute('data-task-id');
            e.dataTransfer.setData('text/plain', taskId);
            e.dataTransfer.effectAllowed = 'move';

            // Add dragging state to body for cursor styling
            document.body.classList.add('is-dragging');

            // Delay to show the drag ghost properly
            setTimeout(() => {
                this.classList.add('drag-ghost');
            }, 0);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging', 'drag-ghost');
            document.body.classList.remove('is-dragging');

            // Remove all drop indicators
            document.querySelectorAll('.column-body').forEach(col => {
                col.classList.remove('drag-over', 'drag-valid', 'drag-invalid');
            });

            draggedCard = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this.classList.contains('column-body')) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            // Only remove if leaving the actual column body
            if (e.relatedTarget && !this.contains(e.relatedTarget)) {
                this.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (!draggedCard) return;

            // Get the target column's status
            const columnHeader = this.previousElementSibling;
            const statusClass = columnHeader.className.split(' ').find(cls =>
                ['REGISTERED', 'WAITING_RESPONSE', 'IN_PROGRESS', 'COMPLETED'].includes(cls)
            );

            if (!statusClass) {
                console.error('Could not determine target status');
                return;
            }

            // Get task ID (use data-task-id attribute for actual ID)
            const taskId = draggedCard.getAttribute('data-task-id');

            // Update task status via API
            updateTaskStatus(taskId, statusClass, this);
        }

        function updateTaskStatus(taskId, newStatus, targetColumn) {
            // Store local reference to the card before async operation
            // (handleDragEnd may set draggedCard = null before .then() executes)
            const card = draggedCard;

            if (!card) {
                console.error('No card reference available');
                return;
            }

            // Show loading state
            card.classList.add('updating');

            fetch('/kanban/api/tasks/' + taskId + '/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Move card to new column
                    const emptyState = targetColumn.querySelector('.empty-column');
                    if (emptyState) {
                        emptyState.style.display = 'none';
                    }

                    // Insert the card before the empty state or at the end
                    if (emptyState) {
                        targetColumn.insertBefore(card, emptyState);
                    } else {
                        targetColumn.appendChild(card);
                    }

                    // Update task count badges
                    updateTaskCounts();

                    // Show success feedback
                    showDragFeedback('success', '태스크가 이동되었습니다');

                    // Update the status buttons on the card based on new status
                    updateCardButtons(card, newStatus);
                } else {
                    showDragFeedback('error', data.message || '이동에 실패했습니다');
                }
            })
            .catch(error => {
                console.error('Error updating task status:', error);
                showDragFeedback('error', '서버 오류가 발생했습니다');
            })
            .finally(() => {
                if (card) {
                    card.classList.remove('updating');
                }
            });
        }

        function updateTaskCounts() {
            document.querySelectorAll('.kanban-column, .kanban-column-half').forEach(column => {
                const columnBody = column.querySelector('.column-body');
                const countBadge = column.querySelector('.task-count');
                if (columnBody && countBadge) {
                    const taskCount = columnBody.querySelectorAll('.task-card').length;
                    countBadge.textContent = taskCount;

                    // Show/hide empty state
                    const emptyState = columnBody.querySelector('.empty-column');
                    if (emptyState) {
                        emptyState.style.display = taskCount === 0 ? 'block' : 'none';
                    }
                }
            });
        }

        function updateCardButtons(card, newStatus) {
            // Refresh the page to update button states properly
            // This is simpler than updating all the forms/buttons manually
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        function showDragFeedback(type, message) {
            // Create feedback toast
            const toast = document.createElement('div');
            toast.className = 'drag-feedback ' + type;
            toast.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + '"></i> ' + message;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('show'), 10);

            // Remove after delay
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ===== Inline Edit Functions =====

        function toggleInlineEdit(button) {
            const wrapper = button.closest('.editable-wrapper');
            const content = wrapper.querySelector('.editable-content');
            const input = wrapper.querySelector('.edit-input');
            const isTitle = wrapper.classList.contains('task-title-wrapper');

            if (input.style.display === 'none') {
                // Switch to edit mode
                content.style.display = 'none';
                input.style.display = 'block';
                input.value = content.classList.contains('empty-desc') ? '' : content.textContent.trim();
                input.focus();
                button.innerHTML = '<i class="fas fa-save"></i>';
                button.title = '저장';

                // Add event listeners
                input.onkeydown = function(e) {
                    if (e.key === 'Enter' && !e.shiftKey && isTitle) {
                        e.preventDefault();
                        saveInlineEdit(wrapper, isTitle);
                    } else if (e.key === 'Escape') {
                        cancelInlineEdit(wrapper, isTitle);
                    }
                };

                // Save on blur (with delay to allow button click)
                input.onblur = function(e) {
                    setTimeout(() => {
                        if (document.activeElement !== button && input.style.display !== 'none') {
                            saveInlineEdit(wrapper, isTitle);
                        }
                    }, 200);
                };
            } else {
                // Save changes
                saveInlineEdit(wrapper, isTitle);
            }
        }

        function saveInlineEdit(wrapper, isTitle) {
            const taskId = wrapper.dataset.taskId;
            const content = wrapper.querySelector('.editable-content');
            const input = wrapper.querySelector('.edit-input');
            const button = wrapper.querySelector('.btn-inline-edit');
            const newValue = input.value.trim();

            // Validate title cannot be empty
            if (isTitle && !newValue) {
                showDragFeedback('error', '제목을 입력해주세요');
                input.focus();
                return;
            }

            // Prepare payload
            const payload = {};
            if (isTitle) {
                payload.title = newValue;
            } else {
                payload.description = newValue;
            }

            // Show saving state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // API call
            fetch('/kanban/api/tasks/' + taskId + '/content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update display
                    if (isTitle) {
                        content.textContent = data.title;
                    } else {
                        if (data.description) {
                            content.textContent = data.description;
                            content.classList.remove('empty-desc');
                        } else {
                            content.textContent = '설명 없음';
                            content.classList.add('empty-desc');
                        }
                    }
                    showDragFeedback('success', '저장되었습니다');
                } else {
                    showDragFeedback('error', data.message || '저장에 실패했습니다');
                }
            })
            .catch(error => {
                console.error('Error saving task content:', error);
                showDragFeedback('error', '서버 오류가 발생했습니다');
            })
            .finally(() => {
                // Switch back to view mode
                content.style.display = '';
                input.style.display = 'none';
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                button.title = '수정';
            });
        }

        function cancelInlineEdit(wrapper, isTitle) {
            const content = wrapper.querySelector('.editable-content');
            const input = wrapper.querySelector('.edit-input');
            const button = wrapper.querySelector('.btn-inline-edit');

            // Switch back to view mode without saving
            content.style.display = '';
            input.style.display = 'none';
            button.innerHTML = '<i class="fas fa-pencil-alt"></i>';
            button.title = '수정';
        }
    </script>
</div>
</body>
</html>

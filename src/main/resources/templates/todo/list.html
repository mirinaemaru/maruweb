<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Todo List</title>
</head>
<body>
    <div layout:fragment="content">
<div class="container">
        <header>
            <h1>Todo List</h1>
            <p class="subtitle">Manage your tasks efficiently</p>
        </header>

        <!-- Flash Messages -->
        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <!-- Add Todo Form -->
        <div class="add-todo-section">
            <form th:action="@{/todos}" method="post" th:object="${todo}">
                <div class="form-group">
                    <input type="text"
                           th:field="*{title}"
                           placeholder="Add a new todo..."
                           class="todo-input"
                           autofocus>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
                <div class="form-group">
                    <textarea th:field="*{description}"
                              placeholder="Description (optional)"
                              class="todo-textarea"
                              rows="2"></textarea>
                </div>
            </form>
        </div>

        <!-- Filter Tabs with Search -->
        <div class="filter-row">
            <div class="filter-tabs">
                <a th:href="@{/todos}"
                   th:classappend="${filter == 'active'} ? 'active' : ''">
                    Active
                </a>
                <a th:href="@{/todos(filter='completed')}"
                   th:classappend="${filter == 'completed'} ? 'active' : ''">
                    Completed
                </a>
                <a th:href="@{/todos(filter='all')}"
                   th:classappend="${filter == 'all'} ? 'active' : ''">
                    All
                </a>
            </div>

            <!-- Search Filter (Completed/All 탭에서만 표시) -->
            <div th:if="${filter == 'completed' || filter == 'all'}" class="search-filter">
                <form th:action="@{/todos}" method="get" class="search-filter-form" id="searchForm">
                    <input type="hidden" name="filter" th:value="${filter}">
                    <div class="keyword-wrapper">
                        <input type="text"
                               name="keyword"
                               id="keywordInput"
                               th:value="${keyword}"
                               placeholder="Search keyword..."
                               class="keyword-input">
                        <button type="button" class="keyword-clear" onclick="clearKeyword()" th:if="${keyword != null and keyword != ''}">×</button>
                    </div>
                    <input type="date"
                           name="from"
                           th:value="${from}"
                           class="date-input">
                    <span class="date-separator">~</span>
                    <input type="date"
                           name="to"
                           th:value="${to}"
                           class="date-input">
                    <button type="submit" class="btn btn-search">Search</button>
                </form>
            </div>
        </div>

        <!-- Todo List -->
        <div class="todo-list">
            <div th:if="${#lists.isEmpty(todos)}" class="empty-state">
                <p>No todos found. Add one to get started!</p>
            </div>

            <div th:each="todo : ${todos}" class="todo-item" th:classappend="${todo.completed == 'Y'} ? 'completed' : ''">
                <div class="todo-content">
                    <form th:action="@{/todos/{id}/toggle(id=${todo.id})}" method="post" class="toggle-form">
                        <input type="checkbox"
                               th:checked="${todo.completed == 'Y'}"
                               onchange="this.form.submit()"
                               class="todo-checkbox">
                    </form>
                    <div class="todo-text">
                        <!-- Active 탭: 제목만 표시 -->
                        <h3 th:if="${filter == 'active'}" th:text="${todo.title}">Todo Title</h3>
                        <!-- Completed/All 탭: 제목 + description 한 줄 표시 -->
                        <h3 th:if="${filter != 'active'}" class="todo-title-with-desc">
                            <span class="todo-title-text" th:text="${todo.title}">Todo Title</span>
                            <span th:if="${todo.description != null and todo.description != ''}"
                                  class="todo-desc-inline"
                                  th:text="' - ' + ${#strings.abbreviate(todo.description, 20)}"></span>
                        </h3>
                        <!-- Active 탭에서는 description 수정 가능 -->
                        <div th:if="${filter == 'active'}">
                            <form th:id="'descForm-' + ${todo.id}" th:action="@{/todos/{id}/description(id=${todo.id})}" method="post" class="description-form">
                                <textarea name="description"
                                          th:text="${todo.description}"
                                          placeholder="Add description..."
                                          class="todo-description-edit"
                                          rows="2"></textarea>
                                <input type="hidden" name="filter" th:value="${filter}">
                            </form>
                        </div>
                        <small class="todo-date" th:text="${#temporals.format(todo.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01</small>
                    </div>
                </div>
                <div class="todo-actions">
                    <button th:if="${filter == 'active'}" type="submit" th:form="'descForm-' + ${todo.id}" class="btn btn-save">Save</button>
                    <a th:href="@{/todos/{id}/edit(id=${todo.id}, filter=${filter})}" class="btn btn-edit">Edit</a>
                    <form th:action="@{/todos/{id}/delete(id=${todo.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-delete" onclick="return confirm('Are you sure?')">Delete</button>
                    </form>
                </div>
            </div>
                </div>
    </div>
    <th:block layout:fragment="extra-scripts">
<script>
        function clearKeyword() {
            document.getElementById('keywordInput').value = '';
            document.getElementById('searchForm').submit();
        }
    </script>
<script th:if="${keyword != null and keyword != ''}" th:inline="javascript">
        (function() {
            const keyword = /*[[${keyword}]]*/ '';
            if (!keyword || keyword.trim() === '') return;

            function highlightText(element) {
                if (!element || !element.textContent) return;

                const text = element.textContent;
                const regex = new RegExp('(' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');

                if (regex.test(text)) {
                    element.innerHTML = text.replace(regex, '<span class="keyword-highlight">$1</span>');
                }
            }

            // Highlight titles
            document.querySelectorAll('.todo-text h3').forEach(highlightText);

            // Highlight descriptions (read-only)
            document.querySelectorAll('.todo-description').forEach(highlightText);
        })();
    </script>
    </th:block>
</body>
</html>

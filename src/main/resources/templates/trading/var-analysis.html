<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>VaR ë¶„ì„</title>
    <style>
        .var-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .var-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .var-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-filter {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn-filter:hover {
            opacity: 0.9;
        }

        .var-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .var-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .var-card h3 {
            font-size: 14px;
            color: #666;
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .var-value {
            font-size: 32px;
            font-weight: 700;
            color: #ff6b6b;
        }

        .var-description {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }

        .chart-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-section h2 {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin: 0 0 20px 0;
        }

        .statistics-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #fecaca;
        }

        .info-box {
            background: #dbeafe;
            color: #1e40af;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #93c5fd;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="var-container">
            <div class="var-header">
                <h1>ğŸ“‰ VaR (Value at Risk) ë¶„ì„</h1>
                <p>í¬íŠ¸í´ë¦¬ì˜¤ì˜ ì ì¬ì  ì†ì‹¤ ìœ„í—˜ì„ í‰ê°€í•©ë‹ˆë‹¤</p>
            </div>

            <div th:if="${error}" class="error-message">
                <span th:text="${error}">ì˜¤ë¥˜ ë©”ì‹œì§€</span>
            </div>

            <div class="info-box">
                <strong>â„¹ï¸ VaRì´ë€?</strong> Value at RiskëŠ” íŠ¹ì • ì‹ ë¢° ìˆ˜ì¤€ê³¼ ê¸°ê°„ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì†ì‹¤ì•¡ì„ ì¶”ì •í•˜ëŠ” ë¦¬ìŠ¤í¬ ì¸¡ì • ì§€í‘œì…ë‹ˆë‹¤.
            </div>

            <!-- í•„í„° ì„¹ì…˜ -->
            <form method="get" th:action="@{/trading/risk/var}">
                <div class="filter-section">
                    <div class="filter-group">
                        <label>ì „ëµ ID (ì„ íƒ)</label>
                        <input type="text" name="strategyId" th:value="${strategyId}" placeholder="ì „ì²´">
                    </div>

                    <div class="filter-group">
                        <label>ì‹ ë¢° ìˆ˜ì¤€</label>
                        <select name="confidenceLevel" th:value="${confidenceLevel}">
                            <option value="0.90" th:selected="${confidenceLevel == 0.90}">90%</option>
                            <option value="0.95" th:selected="${confidenceLevel == 0.95}">95%</option>
                            <option value="0.99" th:selected="${confidenceLevel == 0.99}">99%</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>ì‹œê°„ ì§€í‰ (ì¼)</label>
                        <select name="timeHorizon" th:value="${timeHorizon}">
                            <option value="1" th:selected="${timeHorizon == 1}">1ì¼</option>
                            <option value="5" th:selected="${timeHorizon == 5}">5ì¼</option>
                            <option value="10" th:selected="${timeHorizon == 10}">10ì¼</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>ì‹œì‘ì¼</label>
                        <input type="date" name="startDate" th:value="${startDate}" required>
                    </div>

                    <div class="filter-group">
                        <label>ì¢…ë£Œì¼</label>
                        <input type="date" name="endDate" th:value="${endDate}" required>
                    </div>

                    <button type="submit" class="btn-filter">ğŸ“Š ë¶„ì„</button>
                </div>
            </form>

            <!-- VaR ì¹´ë“œ -->
            <div class="var-cards" th:if="${varData != null}">
                <div class="var-card">
                    <h3>VaR (ì¼ë³„)</h3>
                    <div class="var-value" th:text="${#numbers.formatDecimal(varData.dailyVaR, 0, 'COMMA', 0, 'POINT')} + 'ì›'">
                        -50,000ì›
                    </div>
                    <div class="var-description">
                        ì‹ ë¢° ìˆ˜ì¤€ <span th:text="${confidenceLevel * 100} + '%'">95%</span>ì—ì„œ í•˜ë£¨ ë™ì•ˆ ë°œìƒí•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì†ì‹¤
                    </div>
                </div>

                <div class="var-card">
                    <h3>VaR (ê¸°ê°„)</h3>
                    <div class="var-value" th:text="${#numbers.formatDecimal(varData.periodVaR, 0, 'COMMA', 0, 'POINT')} + 'ì›'">
                        -100,000ì›
                    </div>
                    <div class="var-description">
                        <span th:text="${timeHorizon}">1</span>ì¼ ë™ì•ˆ ë°œìƒí•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì†ì‹¤
                    </div>
                </div>

                <div class="var-card">
                    <h3>CVaR (ì¡°ê±´ë¶€ VaR)</h3>
                    <div class="var-value" th:text="${#numbers.formatDecimal(varData.cvar, 0, 'COMMA', 0, 'POINT')} + 'ì›'">
                        -75,000ì›
                    </div>
                    <div class="var-description">
                        VaRë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš°ì˜ í‰ê·  ì†ì‹¤ (Expected Shortfall)
                    </div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
            <div class="chart-section" th:if="${varData != null}">
                <h2>ì†ìµ ë¶„í¬</h2>
                <canvas id="varChart" width="400" height="150"></canvas>
            </div>

            <!-- í†µê³„ ì„¹ì…˜ -->
            <div class="statistics-section" th:if="${statistics != null}">
                <h2>ì¶”ê°€ í†µê³„</h2>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-label">í‰ê·  ìˆ˜ìµ/ì†ì‹¤</div>
                        <div class="stat-value"
                             th:text="${#numbers.formatDecimal(statistics.meanPL, 0, 'COMMA', 0, 'POINT')} + 'ì›'"
                             th:style="${statistics.meanPL >= 0} ? 'color: #10b981;' : 'color: #ef4444;'">
                            10,000ì›
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">í‘œì¤€í¸ì°¨</div>
                        <div class="stat-value" th:text="${#numbers.formatDecimal(statistics.stdDev, 0, 'COMMA', 0, 'POINT')} + 'ì›'">
                            25,000ì›
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">ìµœëŒ€ ì†ì‹¤ (MDD)</div>
                        <div class="stat-value" th:text="${#numbers.formatDecimal(statistics.maxDrawdown, 0, 'COMMA', 0, 'POINT')} + 'ì›'"
                             style="color: #ef4444;">
                            -150,000ì›
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">ìµœëŒ€ ì´ìµ</div>
                        <div class="stat-value" th:text="${#numbers.formatDecimal(statistics.maxProfit, 0, 'COMMA', 0, 'POINT')} + 'ì›'"
                             style="color: #10b981;">
                            200,000ì›
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">ìƒ¤í”„ ë¹„ìœ¨</div>
                        <div class="stat-value" th:text="${#numbers.formatDecimal(statistics.sharpeRatio, 1, 'COMMA', 2, 'POINT')}">
                            1.5
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">ì™œë„ (Skewness)</div>
                        <div class="stat-value" th:text="${#numbers.formatDecimal(statistics.skewness, 1, 'COMMA', 2, 'POINT')}">
                            -0.3
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-label">ì²¨ë„ (Kurtosis)</div>
                        <div class="stat-value" th:text="${#numbers.formatDecimal(statistics.kurtosis, 1, 'COMMA', 2, 'POINT')}">
                            3.2
                        </div>
                    </div>
                </div>
            </div>

            <div th:if="${varData == null}" style="text-align: center; padding: 40px; color: #666;">
                ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì¡°ì •í•´ ì£¼ì„¸ìš”.
            </div>
        </div>
    </div>

    <th:block layout:fragment="extra-scripts">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            const varData = /*[[${varData}]]*/ null;

            if (varData && varData.distribution) {
                const ctx = document.getElementById('varChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: varData.distribution.map(d => d.range),
                        datasets: [{
                            label: 'ë¹ˆë„',
                            data: varData.distribution.map(d => d.count),
                            backgroundColor: varData.distribution.map(d =>
                                d.range < varData.dailyVaR ? 'rgba(239, 68, 68, 0.7)' : 'rgba(16, 185, 129, 0.7)'
                            ),
                            borderColor: varData.distribution.map(d =>
                                d.range < varData.dailyVaR ? '#ef4444' : '#10b981'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'ë¹ˆë„: ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'ë¹ˆë„'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ì†ìµ ë²”ìœ„ (ì›)'
                                }
                            }
                        }
                    }
                });
            }
            /*]]>*/
        </script>
    </th:block>
</body>
</html>

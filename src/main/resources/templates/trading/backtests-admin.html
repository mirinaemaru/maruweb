<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>백테스트 관리</title>
    <th:block layout:fragment="extra-css">
        <style>
            .backtest-admin-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
                padding-bottom: 40px;
            }

            .page-header {
                margin-bottom: 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 30px 40px;
                border-radius: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            [data-theme="dark"] .page-header {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .page-header h2 {
                font-size: 28px;
                font-weight: 700;
                margin: 0;
                color: white;
            }

            .page-header .badge {
                background: rgba(255, 255, 255, 0.2) !important;
                color: white !important;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 14px;
                margin-left: 15px;
            }

            .btn-new {
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                text-decoration: none;
                transition: all 0.3s;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-new:hover {
                background: rgba(255, 255, 255, 0.3);
                color: white;
                transform: translateY(-2px);
            }

            .alert {
                padding: 15px 20px;
                border-radius: 12px;
                margin-bottom: 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            .card {
                background: var(--bg-secondary);
                border: none;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: background-color 0.3s ease;
                margin-bottom: 30px;
            }

            .card-body {
                color: var(--text-primary);
                padding: 0;
            }

            .table-responsive {
                border-radius: 12px;
                overflow: hidden;
            }

            .table {
                color: var(--text-primary);
                margin-bottom: 0;
                width: 100%;
            }

            .table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            [data-theme="dark"] .table thead {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
            }

            .table thead th {
                padding: 15px 12px;
                font-weight: 600;
                font-size: 13px;
                text-transform: uppercase;
                border: none;
                white-space: nowrap;
            }

            .table thead th:first-child {
                border-radius: 12px 0 0 0;
            }

            .table thead th:last-child {
                border-radius: 0 12px 0 0;
            }

            .table tbody tr {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }

            .table tbody tr:hover {
                background: var(--bg-tertiary);
            }

            .table tbody td {
                padding: 15px 12px;
                border: none;
                vertical-align: middle;
            }

            .table a {
                color: var(--text-primary);
                font-weight: 600;
            }

            .table a:hover {
                color: #667eea;
            }

            [data-theme="dark"] .table a:hover {
                color: #8b9df0;
            }

            .btn-group {
                display: flex;
                gap: 5px;
            }

            .btn-group .btn {
                padding: 6px 12px;
                font-size: 12px;
                border-radius: 6px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 4px;
                white-space: nowrap;
                transition: all 0.2s;
            }

            .btn-group .btn i {
                font-size: 12px;
            }

            .btn-outline-primary {
                border: 1px solid #667eea;
                color: #667eea;
                background: transparent;
            }

            .btn-outline-primary:hover {
                background: #667eea;
                color: white;
                border-color: #667eea;
            }

            [data-theme="dark"] .btn-outline-primary {
                border-color: #8b9df0;
                color: #8b9df0;
            }

            [data-theme="dark"] .btn-outline-primary:hover {
                background: #8b9df0;
                color: #1a1d29;
                border-color: #8b9df0;
            }

            .btn-outline-danger {
                border: 1px solid #dc3545;
                color: #dc3545;
                background: transparent;
            }

            .btn-outline-danger:hover {
                background: #dc3545;
                color: white;
                border-color: #dc3545;
            }

            [data-theme="dark"] .btn-outline-danger {
                border-color: #f5a5ae;
                color: #f5a5ae;
            }

            [data-theme="dark"] .btn-outline-danger:hover {
                background: #dc3545;
                color: white;
                border-color: #dc3545;
            }

            .text-success {
                color: #28a745 !important;
            }

            .text-danger {
                color: #dc3545 !important;
            }

            .text-muted {
                color: var(--text-muted) !important;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="backtest-admin-container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <h2>
                <i class="bi bi-gear-wide-connected me-2"></i>백테스트 관리
                <span class="badge" th:text="${backtests != null} ? '총 ' + ${#lists.size(backtests)} + '개' : '0개'"></span>
            </h2>
            <a href="/trading/backtests/admin/run" class="btn-new">
                <i class="bi bi-play-circle"></i>새 백테스트 실행
            </a>
        </div>

        <!-- 알림 메시지 -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i><span th:text="${error}"></span>
        </div>
        <div th:if="${warning}" class="alert alert-warning" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i><span th:text="${warning}"></span>
        </div>

        <!-- 백테스트 목록 -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>전략</th>
                                <th>종목</th>
                                <th>기간</th>
                                <th class="text-end">수익률</th>
                                <th class="text-end">Sharpe</th>
                                <th class="text-end">MDD</th>
                                <th>거래 수</th>
                                <th>실행일시</th>
                                <th>관리</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(backtests)}">
                                <td colspan="10" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    백테스트 결과가 없습니다.
                                    <a href="/trading/backtests/admin/run" class="d-block mt-2">새 백테스트 실행하기</a>
                                </td>
                            </tr>
                            <tr th:each="bt : ${backtests}">
                                <td>
                                    <a th:if="${bt['backtestId'] != null || bt['backtest_id'] != null}"
                                       th:href="@{/trading/backtests/admin/{id}(id=${bt['backtestId'] != null ? bt['backtestId'] : bt['backtest_id']})}"
                                       th:text="${#strings.abbreviate(bt['backtestId'] != null ? bt['backtestId'] : bt['backtest_id'], 12)}"
                                       class="text-decoration-none" title="상세 보기"></a>
                                    <span th:unless="${bt['backtestId'] != null || bt['backtest_id'] != null}">-</span>
                                </td>
                                <td th:text="${bt['strategyId'] != null ? bt['strategyId'] : (bt['strategy_id'] != null ? bt['strategy_id'] : '-')}" class="fw-bold"></td>
                                <td>
                                    <span th:if="${bt['symbols'] != null}" th:each="symbol, iter : ${bt['symbols']}">
                                        <span th:text="${symbol}"></span>
                                        <span th:if="${!iter.last}">, </span>
                                    </span>
                                    <span th:unless="${bt['symbols'] != null}">-</span>
                                </td>
                                <td class="small">
                                    <span th:text="${bt['startDate'] != null ? bt['startDate'] : (bt['start_date'] != null ? bt['start_date'] : '-')}"></span> ~
                                    <span th:text="${bt['endDate'] != null ? bt['endDate'] : (bt['end_date'] != null ? bt['end_date'] : '-')}"></span>
                                </td>
                                <td class="text-end"
                                    th:with="totalRet=${bt['totalReturn'] != null ? bt['totalReturn'] : bt['total_return']}"
                                    th:classappend="${totalRet != null and totalRet >= 0} ? 'text-success' : 'text-danger'">
                                    <span th:text="${totalRet != null} ? ${#numbers.formatDecimal(totalRet, 1, 2)} + '%' : '-'"></span>
                                </td>
                                <td class="text-end"
                                    th:with="sharpe=${bt['sharpeRatio'] != null ? bt['sharpeRatio'] : bt['sharpe_ratio']}">
                                    <span th:text="${sharpe != null} ? ${#numbers.formatDecimal(sharpe, 1, 2)} : '-'"></span>
                                </td>
                                <td class="text-end text-danger"
                                    th:with="mdd=${bt['maxDrawdown'] != null ? bt['maxDrawdown'] : bt['max_drawdown']}">
                                    <span th:text="${mdd != null} ? ${#numbers.formatDecimal(mdd, 1, 2)} + '%' : '-'"></span>
                                </td>
                                <td th:text="${bt['totalTrades'] != null ? bt['totalTrades'] : (bt['total_trades'] != null ? bt['total_trades'] : '-')}"></td>
                                <td class="small" th:text="${bt['createdAt'] != null ? bt['createdAt'] : (bt['created_at'] != null ? bt['created_at'] : '-')}"></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:if="${bt['backtestId'] != null || bt['backtest_id'] != null}"
                                           th:href="@{/trading/backtests/admin/{id}(id=${bt['backtestId'] != null ? bt['backtestId'] : bt['backtest_id']})}"
                                           class="btn btn-outline-primary" title="상세">
                                            <i class="bi bi-eye"></i> 상세
                                        </a>
                                        <button th:if="${bt['backtestId'] != null || bt['backtest_id'] != null}"
                                                type="button" class="btn btn-outline-danger"
                                                th:data-id="${bt['backtestId'] != null ? bt['backtestId'] : bt['backtest_id']}"
                                                onclick="confirmDelete(this)" title="삭제">
                                            <i class="bi bi-trash"></i> 삭제
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 폼 (hidden) -->
    <form id="deleteForm" method="post" style="display: none;">
    </form>

    <script>
    function confirmDelete(btn) {
        const backtestId = btn.dataset.id;
        if (confirm('이 백테스트를 삭제하시겠습니까?\nID: ' + backtestId)) {
            const form = document.getElementById('deleteForm');
            form.action = '/trading/backtests/admin/' + backtestId + '/delete';
            form.submit();
        }
    }
    </script>
</div>
</body>
</html>

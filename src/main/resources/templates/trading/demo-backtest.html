<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>데모 백테스트</title>
    <th:block layout:fragment="extra-css">
        <style>
            .demo-backtest-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
                padding-bottom: 40px;
            }

            .page-header {
                margin-bottom: 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 30px 40px;
                border-radius: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            [data-theme="dark"] .page-header {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .page-header h2 {
                font-size: 28px;
                font-weight: 700;
                margin: 0;
                color: white;
            }

            .page-header p {
                margin: 8px 0 0 0;
                opacity: 0.9;
                font-size: 15px;
            }

            .header-buttons {
                display: flex;
                gap: 10px;
            }

            .header-buttons .btn {
                padding: 10px 20px;
                border-radius: 8px;
                font-weight: 600;
            }

            .btn-header-success {
                background: rgba(40, 167, 69, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
            }

            .btn-header-success:hover {
                background: #28a745;
                color: white;
            }

            .btn-header-danger {
                background: rgba(220, 53, 69, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
            }

            .btn-header-danger:hover {
                background: #dc3545;
                color: white;
            }

            .alert {
                padding: 15px 20px;
                border-radius: 12px;
                margin-bottom: 20px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            .strategy-cards {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                margin-bottom: 20px;
            }

            @media (max-width: 1200px) {
                .strategy-cards {
                    grid-template-columns: repeat(2, 1fr);
                }
            }

            @media (max-width: 768px) {
                .strategy-cards {
                    grid-template-columns: 1fr;
                }
                .page-header {
                    flex-direction: column;
                    gap: 15px;
                    text-align: center;
                }
            }

            .card {
                background: var(--bg-secondary);
                border: none;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            .card:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            }

            .card-header {
                padding: 20px;
                border: none;
                border-radius: 0;
            }

            .card-header.bg-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            }

            .card-header.bg-success {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            }

            .card-header.bg-info {
                background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%) !important;
            }

            [data-theme="dark"] .card-header.bg-primary,
            [data-theme="dark"] .card-header.bg-success,
            [data-theme="dark"] .card-header.bg-info {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%) !important;
            }

            .card-header h5 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: white;
            }

            .card-body {
                padding: 20px;
                color: var(--text-primary);
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .card-body p {
                color: var(--text-muted);
                margin-bottom: 15px;
            }

            .card-body ul {
                margin-bottom: 20px;
                padding-left: 20px;
                flex: 1;
            }

            .card-body ul li {
                color: var(--text-primary);
                margin-bottom: 8px;
                font-size: 14px;
            }

            .card-footer {
                background: var(--bg-tertiary);
                border: none;
                padding: 15px 20px;
            }

            .btn {
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
                border: none;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }

            .btn-success {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            }

            .btn-success:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            }

            .btn-info {
                background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
            }

            .btn-info:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(23, 162, 184, 0.4);
            }

            [data-theme="dark"] .btn-primary,
            [data-theme="dark"] .btn-success,
            [data-theme="dark"] .btn-info {
                background: #6c757d;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }

            [data-theme="dark"] .btn-primary:hover,
            [data-theme="dark"] .btn-success:hover,
            [data-theme="dark"] .btn-info:hover {
                background: #5a6268;
            }

            .info-card {
                background: var(--bg-secondary);
                border: none;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .info-card .card-body {
                padding: 25px;
            }

            .info-card h5 {
                color: var(--text-primary);
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 20px;
            }

            .info-card h6 {
                color: #667eea;
                font-size: 15px;
                font-weight: 600;
                margin-bottom: 12px;
            }

            [data-theme="dark"] .info-card h6 {
                color: #8b9df0;
            }

            .info-card ol,
            .info-card ul {
                padding-left: 20px;
                margin-bottom: 0;
            }

            .info-card li {
                color: var(--text-muted);
                margin-bottom: 8px;
                font-size: 14px;
                line-height: 1.6;
            }

            .info-card li strong {
                color: var(--text-primary);
            }

            .info-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }

            @media (max-width: 768px) {
                .info-row {
                    grid-template-columns: 1fr;
                    gap: 20px;
                }
            }

            .result-content {
                font-size: 14px;
            }

            .result-content .table {
                color: var(--text-primary);
                font-size: 13px;
            }

            .result-content .table th,
            .result-content .table td {
                padding: 8px 12px;
                border-color: var(--border-color);
            }

            .text-success {
                color: #28a745 !important;
            }

            .text-danger {
                color: #dc3545 !important;
            }

            .text-muted {
                color: var(--text-muted) !important;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="demo-backtest-container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <div>
                <h2><i class="bi bi-lightning me-2"></i>데모 백테스트</h2>
                <p>전략 백테스트를 시뮬레이션하고 결과를 비교합니다</p>
            </div>
            <div class="header-buttons">
                <button type="button" class="btn btn-header-success" onclick="generateData()">
                    <i class="bi bi-database-add me-1"></i>데모 데이터 생성
                </button>
                <button type="button" class="btn btn-header-danger" onclick="clearData()">
                    <i class="bi bi-trash me-1"></i>데모 데이터 삭제
                </button>
            </div>
        </div>

        <!-- 상태 메시지 -->
        <div id="statusMessage" class="alert" style="display: none;"></div>

        <!-- 전략 카드들 -->
        <div class="strategy-cards">
            <!-- MA 크로스오버 백테스트 -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-graph-up me-2"></i>MA 크로스오버</h5>
                </div>
                <div class="card-body">
                    <p>5일/20일 이동평균선 교차 전략</p>
                    <ul>
                        <li>골든 크로스: 매수 신호</li>
                        <li>데드 크로스: 매도 신호</li>
                        <li>종목: 삼성전자 (005930)</li>
                        <li>기간: 최근 1년</li>
                    </ul>
                    <button type="button" class="btn btn-primary w-100" onclick="runBacktest('ma-crossover', this)">
                        <i class="bi bi-play-fill me-1"></i>백테스트 실행
                    </button>
                </div>
                <div class="card-footer" id="result-ma-crossover" style="display: none;">
                    <div class="result-content"></div>
                </div>
            </div>

            <!-- RSI 백테스트 -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="bi bi-activity me-2"></i>RSI 전략</h5>
                </div>
                <div class="card-body">
                    <p>RSI 과매수/과매도 기반 전략</p>
                    <ul>
                        <li>RSI 14일 기준</li>
                        <li>RSI 30 이하: 매수</li>
                        <li>RSI 70 이상: 매도</li>
                        <li>종목: SK하이닉스 (000660)</li>
                    </ul>
                    <button type="button" class="btn btn-success w-100" onclick="runBacktest('rsi', this)">
                        <i class="bi bi-play-fill me-1"></i>백테스트 실행
                    </button>
                </div>
                <div class="card-footer" id="result-rsi" style="display: none;">
                    <div class="result-content"></div>
                </div>
            </div>

            <!-- 전략 비교 -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="bi bi-bar-chart me-2"></i>전략 비교</h5>
                </div>
                <div class="card-body">
                    <p>여러 전략의 성과를 비교합니다</p>
                    <ul>
                        <li>MA 크로스오버 vs RSI</li>
                        <li>동일 기간, 동일 종목</li>
                        <li>수익률, Sharpe, MDD 비교</li>
                    </ul>
                    <button type="button" class="btn btn-info w-100" onclick="runComparison(this)">
                        <i class="bi bi-play-fill me-1"></i>비교 실행
                    </button>
                </div>
                <div class="card-footer" id="result-compare" style="display: none;">
                    <div class="result-content"></div>
                </div>
            </div>
        </div>

        <!-- 설명 -->
        <div class="card info-card">
            <div class="card-body">
                <h5><i class="bi bi-info-circle me-2"></i>데모 백테스트 안내</h5>
                <div class="info-row">
                    <div>
                        <h6><i class="bi bi-book me-1"></i>사용 방법</h6>
                        <ol>
                            <li><strong>데모 데이터 생성</strong> 버튼을 클릭하여 테스트용 가격 데이터를 생성합니다.</li>
                            <li>원하는 전략의 <strong>백테스트 실행</strong> 버튼을 클릭합니다.</li>
                            <li>결과를 확인하고 다른 전략과 비교해 보세요.</li>
                            <li>테스트가 끝나면 <strong>데모 데이터 삭제</strong>로 정리합니다.</li>
                        </ol>
                    </div>
                    <div>
                        <h6><i class="bi bi-exclamation-triangle me-1"></i>주의사항</h6>
                        <ul>
                            <li>데모 데이터는 실제 시장 데이터와 다를 수 있습니다.</li>
                            <li>백테스트 결과가 실제 성과를 보장하지 않습니다.</li>
                            <li>실제 투자 전 충분한 검증이 필요합니다.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
<script>
function showMessage(message, isError) {
    const div = document.getElementById('statusMessage');
    div.className = 'alert ' + (isError ? 'alert-danger' : 'alert-success');
    div.innerHTML = (isError ? '<i class="bi bi-exclamation-triangle me-2"></i>' : '<i class="bi bi-check-circle me-2"></i>') + message;
    div.style.display = 'block';
    setTimeout(() => div.style.display = 'none', 5000);
}

function generateData() {
    fetch('/trading/demo/backtest/generate-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showMessage(data.error, true);
        } else {
            showMessage('데모 데이터가 성공적으로 생성되었습니다.', false);
        }
    })
    .catch(err => showMessage('오류: ' + err.message, true));
}

function clearData() {
    if (!confirm('데모 데이터를 삭제하시겠습니까?')) return;

    fetch('/trading/demo/backtest/clear', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showMessage(data.error, true);
        } else {
            showMessage('데모 데이터가 삭제되었습니다.', false);
            // 결과 영역 숨기기
            document.querySelectorAll('[id^="result-"]').forEach(el => el.style.display = 'none');
        }
    })
    .catch(err => showMessage('오류: ' + err.message, true));
}

function runBacktest(type, btn) {
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>실행 중...';

    const resultDiv = document.getElementById('result-' + type);
    resultDiv.style.display = 'none';

    fetch('/trading/demo/backtest/' + type, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        displayBacktestResult(resultDiv, data);
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        resultDiv.querySelector('.result-content').innerHTML =
            '<div class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>오류: ' + err.message + '</div>';
        resultDiv.style.display = 'block';
    });
}

function runComparison(btn) {
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>비교 중...';

    const resultDiv = document.getElementById('result-compare');
    resultDiv.style.display = 'none';

    fetch('/trading/demo/backtest/compare', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;

        if (data.error) {
            resultDiv.querySelector('.result-content').innerHTML =
                '<div class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>' + data.error + '</div>';
        } else {
            let html = '<div class="small">';
            html += '<div class="fw-bold text-success mb-2"><i class="bi bi-check-circle me-1"></i>비교 완료</div>';
            html += '<table class="table table-sm table-bordered mb-0">';
            html += '<thead><tr><th>전략</th><th>수익률</th><th>Sharpe</th></tr></thead>';
            html += '<tbody>';
            for (const [strategy, result] of Object.entries(data)) {
                if (result && result.totalReturn != null) {
                    html += '<tr>';
                    html += '<td>' + strategy + '</td>';
                    html += '<td class="' + (result.totalReturn >= 0 ? 'text-success' : 'text-danger') + '">' +
                            (result.totalReturn * 100).toFixed(2) + '%</td>';
                    html += '<td>' + (result.sharpeRatio || '-') + '</td>';
                    html += '</tr>';
                }
            }
            html += '</tbody></table>';
            html += '</div>';
            resultDiv.querySelector('.result-content').innerHTML = html;
        }

        resultDiv.style.display = 'block';
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        resultDiv.querySelector('.result-content').innerHTML =
            '<div class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>오류: ' + err.message + '</div>';
        resultDiv.style.display = 'block';
    });
}

function displayBacktestResult(resultDiv, data) {
    if (data.error) {
        resultDiv.querySelector('.result-content').innerHTML =
            '<div class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>' + data.error + '</div>';
    } else {
        let html = '<div class="small">';
        html += '<div class="fw-bold text-success mb-2"><i class="bi bi-check-circle me-1"></i>백테스트 완료</div>';

        if (data.totalReturn != null) {
            const returnClass = data.totalReturn >= 0 ? 'text-success' : 'text-danger';
            html += '<div>수익률: <span class="' + returnClass + ' fw-bold">' +
                    (data.totalReturn * 100).toFixed(2) + '%</span></div>';
        }

        if (data.sharpeRatio != null) {
            html += '<div>Sharpe Ratio: ' + data.sharpeRatio.toFixed(2) + '</div>';
        }

        if (data.maxDrawdown != null) {
            html += '<div>MDD: <span class="text-danger">' +
                    (data.maxDrawdown * 100).toFixed(2) + '%</span></div>';
        }

        if (data.totalTrades != null) {
            html += '<div>총 거래 수: ' + data.totalTrades + '</div>';
        }

        if (data.winRate != null) {
            html += '<div>승률: ' + (data.winRate * 100).toFixed(1) + '%</div>';
        }

        html += '</div>';
        resultDiv.querySelector('.result-content').innerHTML = html;
    }
    resultDiv.style.display = 'block';
}
</script>
</th:block>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Market Data êµ¬ë… ê´€ë¦¬</title>
    <th:block layout:fragment="extra-css">
        <style>
            .market-data-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
                padding-bottom: 40px;
            }

            .page-header {
                margin-bottom: 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 30px 40px;
                border-radius: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            }
            [data-theme="dark"] .page-header {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .page-header h2 {
                font-size: 28px;
                font-weight: 700;
                margin: 0;
                color: white;
            }

            .page-header p {
                margin: 10px 0 0 0;
                opacity: 0.9;
                font-size: 14px;
            }

            .alert {
                padding: 15px 20px;
                margin-bottom: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            .alert-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .alert-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            [data-theme="dark"] .alert-success {
                background: rgba(40, 167, 69, 0.2);
                color: #75d99b;
                border-color: rgba(40, 167, 69, 0.3);
            }

            [data-theme="dark"] .alert-error {
                background: rgba(220, 53, 69, 0.2);
                color: #f5a5ae;
                border-color: rgba(220, 53, 69, 0.3);
            }

            .card {
                background: var(--bg-secondary);
                border: none;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
                margin-bottom: 20px;
            }

            .card:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

            .card-header {
                background: var(--bg-tertiary);
                border-bottom: 1px solid var(--border-color);
                padding: 15px 20px;
                border-radius: 12px 12px 0 0;
            }

            .card-header h5 {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .card-body {
                color: var(--text-primary);
                padding: 20px;
            }

            .status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .status-item {
                padding: 15px;
                background: var(--bg-tertiary);
                border-radius: 10px;
                transition: background-color 0.3s ease;
            }

            .status-label {
                font-size: 13px;
                color: var(--text-secondary);
                margin-bottom: 5px;
                font-weight: 500;
            }

            .status-value {
                font-size: 16px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .status-value.active {
                color: #28a745;
            }

            .status-value.inactive {
                color: #dc3545;
            }

            .symbols-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 10px;
            }

            .symbol-tag {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 20px;
                font-size: 13px;
                font-weight: 500;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }

            [data-theme="dark"] .symbol-tag {
                background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            .symbol-tag .symbol-remove {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 18px;
                height: 18px;
                background: rgba(255, 255, 255, 0.3);
                border: none;
                border-radius: 50%;
                color: white;
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.2s ease;
                padding: 0;
                line-height: 1;
            }

            .symbol-tag .symbol-remove:hover {
                background: rgba(220, 53, 69, 0.8);
                transform: scale(1.1);
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-label {
                display: block;
                font-weight: 600;
                color: var(--text-primary);
                font-size: 14px;
                margin-bottom: 8px;
            }

            .form-control {
                width: 100%;
                padding: 12px 15px;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                font-size: 14px;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                transition: all 0.3s ease;
                box-sizing: border-box;
            }

            .form-control:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .form-text {
                font-size: 12px;
                color: var(--text-muted);
            }

            .btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }

            .btn-sm {
                padding: 8px 16px;
                font-size: 13px;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .btn-primary:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }

            .btn-primary:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .btn-danger {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            }

            .btn-danger:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
            }

            .btn-secondary {
                background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
                color: white;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }

            .btn-secondary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
            }

            [data-theme="dark"] .btn-primary,
            [data-theme="dark"] .btn-danger,
            [data-theme="dark"] .btn-secondary {
                background: #4a5568;
                box-shadow: 0 4px 15px rgba(74, 85, 104, 0.3);
            }

            [data-theme="dark"] .btn-primary:hover:not(:disabled),
            [data-theme="dark"] .btn-danger:hover,
            [data-theme="dark"] .btn-secondary:hover {
                background: #5a6778;
            }

            .empty-symbols {
                text-align: center;
                padding: 30px;
                color: var(--text-muted);
            }

            .empty-symbols-icon {
                font-size: 48px;
                margin-bottom: 10px;
            }

            .info-box {
                background: var(--bg-secondary);
                padding: 20px;
                border-radius: 12px;
                border-left: 4px solid #667eea;
                margin-top: 20px;
                transition: background-color 0.3s ease;
            }

            [data-theme="dark"] .info-box {
                border-left-color: #8b9df0;
            }

            .info-box h3 {
                margin-top: 0;
                color: #667eea;
                font-size: 16px;
            }

            [data-theme="dark"] .info-box h3 {
                color: #8b9df0;
            }

            .info-box p {
                margin: 8px 0;
                color: var(--text-primary);
                font-size: 14px;
                line-height: 1.6;
            }

            /* ê²€ìƒ‰ ì…ë ¥ ê·¸ë£¹ - í•œ ì¤„ ë°°ì¹˜ */
            .search-row {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 15px;
            }

            .search-row .form-label {
                margin: 0;
                white-space: nowrap;
                min-width: 70px;
            }

            .search-row .form-control {
                flex: 1;
                max-width: 300px;
            }

            .search-row .btn-search {
                padding: 12px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                font-size: 16px;
            }

            .search-row .btn-search:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }

            [data-theme="dark"] .search-row .btn-search {
                background: #4a5568;
            }

            .search-row .form-text {
                margin: 0;
                flex-shrink: 0;
            }

            .search-row .btn-add {
                margin-left: auto;
            }

            /* ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” */
            .search-results {
                max-height: 350px;
                overflow-y: auto;
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
            }

            .search-results table {
                width: 100%;
                border-collapse: collapse;
            }

            .search-results th,
            .search-results td {
                padding: 10px 12px;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }

            .search-results th {
                background: var(--bg-tertiary);
                font-weight: 600;
                font-size: 13px;
                color: var(--text-secondary);
                position: sticky;
                top: 0;
            }

            .search-results td {
                font-size: 14px;
                color: var(--text-primary);
            }

            .search-results tbody tr:hover {
                background: var(--bg-tertiary);
            }

            .search-results .checkbox-cell {
                width: 40px;
                text-align: center;
            }

            .search-results input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
            }

            .search-results input[type="checkbox"]:disabled {
                cursor: not-allowed;
                opacity: 0.5;
            }

            .search-results .no-results,
            .search-results .loading {
                padding: 30px;
                text-align: center;
                color: var(--text-muted);
            }

            .search-results .subscribed-badge {
                display: inline-block;
                padding: 2px 8px;
                background: #28a745;
                color: white;
                border-radius: 10px;
                font-size: 11px;
                margin-left: 8px;
            }

            /* ìˆ¨ê¸´ êµ¬ë… ID í‘œì‹œ */
            .subscription-info {
                font-size: 11px;
                color: var(--text-muted);
                margin-top: 5px;
            }

            /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
            .spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            .spinner-dark {
                border-color: rgba(0,0,0,0.1);
                border-top-color: #667eea;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
            .toast-container {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 9999;
            }

            .toast {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                color: white;
                padding: 14px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
                font-size: 14px;
                font-weight: 500;
                animation: slideIn 0.3s ease, fadeOut 0.3s ease 0.7s forwards;
                max-width: 350px;
            }

            [data-theme="dark"] .toast {
                background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="market-data-container">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="page-header">
            <h2>ğŸ“¡ Market Data êµ¬ë… ê´€ë¦¬</h2>
            <p>ì‹¤ì‹œê°„ ì‹œì„¸ ë°ì´í„° êµ¬ë… ì¢…ëª©ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <!-- ì„±ê³µ ë©”ì‹œì§€ -->
        <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>

        <!-- êµ¬ë… ìƒíƒœ ì¹´ë“œ -->
        <div class="card" th:if="${status}">
            <div class="card-header">
                <h5>ğŸ“Š êµ¬ë… ìƒíƒœ</h5>
            </div>
            <div class="card-body">
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">êµ¬ë… ìƒíƒœ</div>
                        <div class="status-value" th:classappend="${status.subscribed ? 'active' : 'inactive'}"
                             th:text="${status.subscribed ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}">í™œì„±</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">êµ¬ë… ì´ë¦„</div>
                        <div class="status-value">ì‹¤ì‹œê°„ ì‹œì„¸</div>
                        <div th:if="${status.subscriptionId}" class="subscription-info"
                             th:text="'ID: ' + ${#strings.abbreviate(status.subscriptionId, 20)}"></div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ì¢…ëª© ìˆ˜</div>
                        <div class="status-value" id="statusSymbolCount" th:text="${status.symbolCount} + 'ê°œ'">0ê°œ</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">ì—°ê²° ìƒíƒœ</div>
                        <div class="status-value" th:classappend="${status.connected ? 'active' : 'inactive'}"
                             th:text="${status.connected ? 'ğŸŸ¢ ì—°ê²°ë¨' : 'ğŸ”´ ì—°ê²° ì•ˆë¨'}">ì—°ê²°ë¨</div>
                    </div>
                </div>
                <div th:if="${status.message}" class="status-item" style="margin-top: 15px;">
                    <div class="status-label">ë©”ì‹œì§€</div>
                    <div class="status-value" th:text="${status.message}">-</div>
                </div>
            </div>
        </div>

        <!-- êµ¬ë… ì¢…ëª© ëª©ë¡ ì¹´ë“œ -->
        <div class="card" th:if="${symbols}">
            <div class="card-header">
                <h5>ğŸ“‹ êµ¬ë… ì¢…ëª© ëª©ë¡ (<span id="symbolCount" th:text="${symbols.total}">0</span>ê°œ)</h5>
            </div>
            <div class="card-body">
                <div id="symbolsListContainer">
                    <div th:if="${symbols.symbols != null and !symbols.symbols.isEmpty()}" class="symbols-list" id="symbolsList">
                        <!-- ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì¢…ëª© ì½”ë“œë¡œ íƒœê·¸ ìƒì„± -->
                        <span class="symbol-tag" th:each="symbol : ${symbols.symbols}" th:data-symbol="${symbol}">
                            <span class="symbol-text" th:text="${symbol}">ë¡œë”©ì¤‘...</span>
                            <button type="button" class="symbol-remove" th:data-symbol="${symbol}" title="êµ¬ë… í•´ì œ">Ã—</button>
                        </span>
                    </div>
                    <div th:if="${symbols.symbols == null or symbols.symbols.isEmpty()}" class="empty-symbols" id="emptySymbols">
                        <div class="empty-symbols-icon">ğŸ“­</div>
                        <p>êµ¬ë… ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¢…ëª© ê²€ìƒ‰ ë° ì¶”ê°€ ì¹´ë“œ -->
        <div class="card">
            <div class="card-header">
                <h5>ğŸ” ì¢…ëª© ê²€ìƒ‰ ë° ì¶”ê°€</h5>
            </div>
            <div class="card-body">
                <!-- ê²€ìƒ‰ í–‰: ë ˆì´ë¸” + ì…ë ¥ì°½ + ì„¤ëª… (2ê¸€ì ì´ìƒ ì…ë ¥ì‹œ ìë™ ê²€ìƒ‰) -->
                <div class="search-row">
                    <label class="form-label">ì¢…ëª© ê²€ìƒ‰</label>
                    <input type="text" class="form-control" id="searchKeyword"
                           placeholder="ì¢…ëª©ì½”ë“œ ë˜ëŠ” ì¢…ëª©ëª… ì…ë ¥ (2ê¸€ì ì´ìƒ)">
                    <span class="form-text">2ê¸€ì ì´ìƒ ì…ë ¥í•˜ë©´ ìë™ ê²€ìƒ‰ë©ë‹ˆë‹¤. ì²´í¬ë°•ìŠ¤ ì„ íƒì‹œ ë°”ë¡œ êµ¬ë…ë©ë‹ˆë‹¤.</span>
                </div>

                <!-- ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” -->
                <div class="search-results" id="searchResults">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-cell">ì„ íƒ</th>
                                <th>ì¢…ëª©ì½”ë“œ</th>
                                <th>ì¢…ëª©ëª…</th>
                                <th>ì‹œì¥</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBody">
                            <tr><td colspan="4" class="loading"><div class="spinner spinner-dark"></div> ì¢…ëª© ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ì¬êµ¬ë… ì¹´ë“œ -->
        <div class="card">
            <div class="card-header">
                <h5>ğŸ”„ ì¬êµ¬ë…</h5>
            </div>
            <div class="card-body">
                <p style="margin-bottom: 15px; color: var(--text-secondary);">ëª¨ë“  êµ¬ë… ì¢…ëª©ì˜ ì—°ê²°ì„ ê°±ì‹ í•©ë‹ˆë‹¤. ì—°ê²° ë¬¸ì œê°€ ìˆì„ ë•Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                <form th:action="@{/trading/market-data/resubscribe}" method="post">
                    <button type="submit" class="btn btn-secondary">
                        <span>ğŸ”„</span> ì¬êµ¬ë…
                    </button>
                </form>
            </div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
            <h3>â„¹ï¸ Market Data êµ¬ë… ì•ˆë‚´</h3>
            <p><strong>êµ¬ë… ìƒíƒœ:</strong> í˜„ì¬ ì‹¤ì‹œê°„ ì‹œì„¸ ë°ì´í„° ìˆ˜ì‹  ìƒíƒœë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</p>
            <p><strong>ì¢…ëª© ê²€ìƒ‰:</strong> ì¢…ëª©ì½”ë“œ ë˜ëŠ” ì¢…ëª©ëª…ìœ¼ë¡œ ê²€ìƒ‰í•˜ì—¬ êµ¬ë…í•  ì¢…ëª©ì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
            <p><strong>êµ¬ë… í•´ì œ:</strong> ì¢…ëª© íƒœê·¸ì˜ X ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ êµ¬ë…ì„ í•´ì œí•©ë‹ˆë‹¤.</p>
            <p><strong>ì¬êµ¬ë…:</strong> ì—°ê²° ë¬¸ì œ ë°œìƒ ì‹œ ëª¨ë“  ì¢…ëª©ì˜ êµ¬ë…ì„ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.</p>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-scripts">
<script th:inline="javascript">
(function() {
    // êµ¬ë…ëœ ì¢…ëª© ì½”ë“œ ëª©ë¡ (ì„œë²„ì—ì„œ ì „ë‹¬)
    let subscribedSymbols = /*[[${symbols?.symbols}]]*/ [];

    // ì¢…ëª© ì •ë³´ ìºì‹œ
    const instrumentCache = {};

    // ê²€ìƒ‰ ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸
    let searchTimer = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        loadInitialInstruments();
        loadInstrumentNamesForTags();
        createToastContainer();
    });

    // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ìƒì„±
    function createToastContainer() {
        if (!document.querySelector('.toast-container')) {
            const container = document.createElement('div');
            container.className = 'toast-container';
            document.body.appendChild(container);
        }
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    function showToast(message) {
        const container = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);

        // 1ì´ˆ í›„ ì œê±°
        setTimeout(() => {
            toast.remove();
        }, 1000);
    }

    // êµ¬ë… ì¢…ëª© íƒœê·¸ì— ì¢…ëª©ëª… ë¡œë“œ
    async function loadInstrumentNamesForTags() {
        const symbolTags = document.querySelectorAll('.symbol-tag[data-symbol]');
        if (symbolTags.length === 0) return;

        const symbols = Array.from(symbolTags).map(tag => tag.dataset.symbol);

        for (const symbol of symbols) {
            try {
                const info = await fetchInstrumentInfo(symbol);
                if (info) {
                    instrumentCache[symbol] = info;
                    const tag = document.querySelector(`.symbol-tag[data-symbol="${symbol}"] .symbol-text`);
                    if (tag) {
                        tag.textContent = `${info.nameKr} (${symbol})`;
                    }
                }
            } catch (e) {
                console.error('ì¢…ëª© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', symbol, e);
            }
        }
    }

    // ë‹¨ì¼ ì¢…ëª© ì •ë³´ ì¡°íšŒ
    async function fetchInstrumentInfo(symbol) {
        try {
            const response = await fetch(`/trading/instruments/api/${encodeURIComponent(symbol)}`);
            if (!response.ok) return null;

            const data = await response.json();
            if (data && data.symbol) {
                return {
                    symbol: data.symbol,
                    nameKr: data.nameKr || symbol,
                    market: data.market
                };
            }
        } catch (e) {
            console.error('ì¢…ëª© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', symbol, e);
        }
        return null;
    }

    // ì´ˆê¸° ì¢…ëª© ëª©ë¡ ë¡œë“œ (ì´ë¦„ìˆœ ì •ë ¬, 10ê°œ)
    async function loadInitialInstruments() {
        const resultsBody = document.getElementById('searchResultsBody');

        try {
            const response = await fetch('/trading/instruments/api/search?market=KOSPI');
            if (!response.ok) throw new Error('API ì‘ë‹µ ì‹¤íŒ¨');

            const data = await response.json();

            if (data.items && data.items.length > 0) {
                const sorted = data.items
                    .filter(item => item.nameKr)
                    .sort((a, b) => (a.nameKr || '').localeCompare(b.nameKr || '', 'ko'))
                    .slice(0, 10);

                renderSearchResults(sorted);
            } else {
                resultsBody.innerHTML = '<tr><td colspan="4" class="no-results">ì¢…ëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        } catch (e) {
            console.error('ì´ˆê¸° ì¢…ëª© ë¡œë“œ ì‹¤íŒ¨:', e);
            resultsBody.innerHTML = '<tr><td colspan="4" class="no-results">ì¢…ëª© ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
    function renderSearchResults(items) {
        const resultsBody = document.getElementById('searchResultsBody');

        if (!items || items.length === 0) {
            resultsBody.innerHTML = '<tr><td colspan="4" class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        resultsBody.innerHTML = items.map(item => {
            const isSubscribed = subscribedSymbols.includes(item.symbol);
            instrumentCache[item.symbol] = {
                symbol: item.symbol,
                nameKr: item.nameKr || item.symbol,
                market: item.market
            };

            return `
                <tr data-symbol="${item.symbol}">
                    <td class="checkbox-cell">
                        <input type="checkbox" value="${item.symbol}" data-name="${item.nameKr || item.symbol}" ${isSubscribed ? 'disabled checked' : ''}>
                    </td>
                    <td>
                        ${item.symbol}
                        ${isSubscribed ? '<span class="subscribed-badge">êµ¬ë…ì¤‘</span>' : ''}
                    </td>
                    <td>${item.nameKr || '-'}</td>
                    <td>${item.market || '-'}</td>
                </tr>
            `;
        }).join('');

        // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸ ì¶”ê°€ (ì¦‰ì‹œ êµ¬ë…)
        resultsBody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', function() {
                if (this.checked) {
                    addSymbolImmediately(this.value, this.dataset.name);
                }
            });
        });
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
        // ê²€ìƒ‰ ì…ë ¥ì°½ - 2ê¸€ì ì´ìƒ ì…ë ¥ì‹œ ìë™ ê²€ìƒ‰
        const searchInput = document.getElementById('searchKeyword');
        searchInput.addEventListener('input', function() {
            const keyword = this.value.trim();

            // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (searchTimer) {
                clearTimeout(searchTimer);
            }

            // 2ê¸€ì ë¯¸ë§Œì´ë©´ ì´ˆê¸° ëª©ë¡ í‘œì‹œ
            if (keyword.length < 2) {
                if (keyword.length === 0) {
                    loadInitialInstruments();
                }
                return;
            }

            // 300ms ë””ë°”ìš´ìŠ¤ í›„ ê²€ìƒ‰ ì‹¤í–‰
            searchTimer = setTimeout(() => {
                performSearch(keyword);
            }, 300);
        });

        // ì¢…ëª© ì‚­ì œ ë²„íŠ¼ (ì´ë²¤íŠ¸ ìœ„ì„)
        const container = document.getElementById('symbolsListContainer');
        if (container) {
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('symbol-remove')) {
                    const symbol = e.target.dataset.symbol;
                    removeSymbol(symbol);
                }
            });
        }
    }

    // ì¢…ëª© ê²€ìƒ‰ ìˆ˜í–‰
    async function performSearch(keyword) {
        const resultsBody = document.getElementById('searchResultsBody');
        resultsBody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner spinner-dark"></div> ê²€ìƒ‰ ì¤‘...</td></tr>';

        try {
            const response = await fetch(`/trading/instruments/api/search?search=${encodeURIComponent(keyword)}`);
            if (!response.ok) throw new Error('API ì‘ë‹µ ì‹¤íŒ¨');

            const data = await response.json();

            if (data.items && data.items.length > 0) {
                const sorted = data.items.sort((a, b) =>
                    (a.nameKr || '').localeCompare(b.nameKr || '', 'ko')
                );
                renderSearchResults(sorted);
            } else {
                resultsBody.innerHTML = '<tr><td colspan="4" class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        } catch (e) {
            console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', e);
            resultsBody.innerHTML = '<tr><td colspan="4" class="no-results">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    // ì²´í¬ë°•ìŠ¤ ì„ íƒì‹œ ì¦‰ì‹œ ì¢…ëª© ì¶”ê°€
    async function addSymbolImmediately(symbol, name) {
        try {
            const formData = new FormData();
            formData.append('symbols', symbol);

            const response = await fetch('/trading/market-data/add', {
                method: 'POST',
                body: formData
            });

            if (response.ok || response.redirected) {
                // êµ¬ë… ëª©ë¡ì— ì¶”ê°€
                subscribedSymbols.push(symbol);

                // êµ¬ë… ì¢…ëª© ëª©ë¡ì— íƒœê·¸ ì¶”ê°€
                addSymbolTag(symbol, name);

                // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ êµ¬ë…ì¤‘ìœ¼ë¡œ í‘œì‹œ
                updateSearchResultToSubscribed(symbol);

                // ì¢…ëª© ìˆ˜ ì—…ë°ì´íŠ¸
                updateSymbolCount();

                showToast(`${name}(${symbol}) ì¢…ëª©ì´ êµ¬ë…ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        } catch (e) {
            console.error('ì¢…ëª© ì¶”ê°€ ì‹¤íŒ¨:', e);
            showToast('ì¢…ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // êµ¬ë… ì¢…ëª© íƒœê·¸ ì¶”ê°€
    function addSymbolTag(symbol, name) {
        const symbolsList = document.getElementById('symbolsList');
        const emptySymbols = document.getElementById('emptySymbols');

        // ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
        if (emptySymbols) {
            emptySymbols.style.display = 'none';
        }

        // ëª©ë¡ì´ ì—†ìœ¼ë©´ ìƒì„±
        if (!symbolsList) {
            const container = document.getElementById('symbolsListContainer');
            const newList = document.createElement('div');
            newList.className = 'symbols-list';
            newList.id = 'symbolsList';
            container.prepend(newList);
        }

        const list = document.getElementById('symbolsList');

        // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        if (list.querySelector(`[data-symbol="${symbol}"]`)) return;

        const tag = document.createElement('span');
        tag.className = 'symbol-tag';
        tag.dataset.symbol = symbol;
        tag.innerHTML = `
            <span class="symbol-text">${name} (${symbol})</span>
            <button type="button" class="symbol-remove" data-symbol="${symbol}" title="êµ¬ë… í•´ì œ">Ã—</button>
        `;
        list.appendChild(tag);

        // ìºì‹œì— ì €ì¥
        instrumentCache[symbol] = { symbol, nameKr: name };
    }

    // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ í•´ë‹¹ ì¢…ëª©ì„ êµ¬ë…ì¤‘ìœ¼ë¡œ í‘œì‹œ
    function updateSearchResultToSubscribed(symbol) {
        const row = document.querySelector(`#searchResultsBody tr[data-symbol="${symbol}"]`);
        if (row) {
            // ì²´í¬ë°•ìŠ¤ë¥¼ disabled + checkedë¡œ ë³€ê²½
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.disabled = true;
                checkbox.checked = true;
            }
            // ì¢…ëª©ì½”ë“œ ì˜†ì— êµ¬ë…ì¤‘ ë±ƒì§€ ì¶”ê°€
            const symbolCell = row.querySelector('td:nth-child(2)');
            if (symbolCell && !symbolCell.querySelector('.subscribed-badge')) {
                symbolCell.innerHTML = `${symbol} <span class="subscribed-badge">êµ¬ë…ì¤‘</span>`;
            }
        }
    }

    // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ êµ¬ë…ì¤‘ í‘œì‹œ ì œê±°
    function updateSearchResultToUnsubscribed(symbol, name) {
        const row = document.querySelector(`#searchResultsBody tr[data-symbol="${symbol}"]`);
        if (row) {
            // ì²´í¬ë°•ìŠ¤ë¥¼ enabled + uncheckedë¡œ ë³€ê²½
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.disabled = false;
                checkbox.checked = false;
            }
            // ì¢…ëª©ì½”ë“œ ì˜†ì˜ êµ¬ë…ì¤‘ ë±ƒì§€ ì œê±°
            const symbolCell = row.querySelector('td:nth-child(2)');
            if (symbolCell) {
                const badge = symbolCell.querySelector('.subscribed-badge');
                if (badge) {
                    badge.remove();
                }
            }
        }
    }

    // ì¢…ëª© ìˆ˜ ì—…ë°ì´íŠ¸ (êµ¬ë… ìƒíƒœ + êµ¬ë… ì¢…ëª© ëª©ë¡ ëª¨ë‘)
    function updateSymbolCount() {
        const count = subscribedSymbols.length;

        // êµ¬ë… ì¢…ëª© ëª©ë¡ íƒ€ì´í‹€ì˜ ì¢…ëª© ìˆ˜ ì—…ë°ì´íŠ¸
        const listCountEl = document.getElementById('symbolCount');
        if (listCountEl) {
            listCountEl.textContent = count;
        }

        // êµ¬ë… ìƒíƒœì˜ ì¢…ëª© ìˆ˜ ì—…ë°ì´íŠ¸
        const statusCountEl = document.getElementById('statusSymbolCount');
        if (statusCountEl) {
            statusCountEl.textContent = count + 'ê°œ';
        }
    }

    // ì¢…ëª© ì‚­ì œ (í™•ì¸ ì—†ì´ ë°”ë¡œ ì‚­ì œ)
    async function removeSymbol(symbol) {
        const info = instrumentCache[symbol];
        const displayName = info ? info.nameKr : symbol;

        try {
            const formData = new FormData();
            formData.append('symbols', symbol);

            const response = await fetch('/trading/market-data/remove', {
                method: 'POST',
                body: formData
            });

            if (response.ok || response.redirected) {
                // êµ¬ë… ëª©ë¡ì—ì„œ ì œê±°
                subscribedSymbols = subscribedSymbols.filter(s => s !== symbol);

                // UIì—ì„œ íƒœê·¸ ì œê±°
                const tag = document.querySelector(`.symbol-tag[data-symbol="${symbol}"]`);
                if (tag) {
                    tag.remove();
                }

                // ì¢…ëª© ìˆ˜ ì—…ë°ì´íŠ¸
                updateSymbolCount();

                // ë¹ˆ ìƒíƒœ í‘œì‹œ
                if (subscribedSymbols.length === 0) {
                    const container = document.getElementById('symbolsListContainer');
                    const emptyDiv = document.getElementById('emptySymbols');
                    if (emptyDiv) {
                        emptyDiv.style.display = 'block';
                    } else {
                        container.innerHTML = `
                            <div class="empty-symbols" id="emptySymbols">
                                <div class="empty-symbols-icon">ğŸ“­</div>
                                <p>êµ¬ë… ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                        `;
                    }
                }

                // ê²€ìƒ‰ ê²°ê³¼ì—ì„œ êµ¬ë…ì¤‘ í‘œì‹œ ì œê±°
                updateSearchResultToUnsubscribed(symbol, displayName);

                // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
                showToast(`${displayName}(${symbol}) ì¢…ëª©ì´ êµ¬ë… ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        } catch (e) {
            console.error('ì¢…ëª© ì‚­ì œ ì‹¤íŒ¨:', e);
            showToast('ì¢…ëª© ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
})();
</script>
</th:block>
</body>
</html>

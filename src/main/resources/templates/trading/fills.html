<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Ï≤¥Í≤∞ ÎÇ¥Ïó≠ Ï°∞Ìöå</title>
    <!-- Symbol Search Component -->
    <link rel="stylesheet" th:href="@{/css/symbol-search.css}">
    <th:block layout:fragment="extra-css">
        <style>
            .fills-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
                padding-bottom: 40px;
            }

            .page-header {
                margin-bottom: 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 30px 40px;
                border-radius: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            }
            [data-theme="dark"] .page-header {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .page-header h2 {
                font-size: 28px;
                font-weight: 700;
                margin: 0;
                color: white;
            }

            .page-header p {
                margin: 10px 0 0 0;
                opacity: 0.9;
                font-size: 15px;
            }

            .alert {
                padding: 15px 20px;
                margin-bottom: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            .alert-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .alert-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .card {
                background: var(--bg-secondary);
                border: none;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: background-color 0.3s ease;
                margin-bottom: 20px;
            }

            .card-body {
                color: var(--text-primary);
                padding: 20px;
            }

            .filter-form {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: center;
            }

            .filter-item {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .filter-buttons {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-left: auto;
            }

            .form-label {
                color: var(--text-primary);
                font-weight: 600;
                font-size: 14px;
                margin-bottom: 0;
                white-space: nowrap;
            }

            .form-select, .form-control {
                background: var(--bg-tertiary);
                border: 2px solid var(--border-color);
                color: var(--text-primary);
                padding: 10px 12px;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .form-select:focus, .form-control:focus {
                background: var(--bg-tertiary);
                border-color: #667eea;
                color: var(--text-primary);
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .btn {
                padding: 10px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }

            [data-theme="dark"] .btn-primary {
                background: #6c757d;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }

            [data-theme="dark"] .btn-primary:hover {
                background: #5a6268;
            }

            .btn-outline-secondary {
                border: 2px solid var(--border-color);
                color: var(--text-primary);
                background: transparent;
            }

            .btn-outline-secondary:hover {
                background: var(--bg-tertiary);
                border-color: var(--text-primary);
                color: var(--text-primary);
            }

            .btn-success {
                background: #28a745;
                color: white;
                border: none;
            }

            .btn-success:hover {
                background: #218838;
                transform: translateY(-2px);
            }

            [data-theme="dark"] .btn-success {
                background: #6c757d !important;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }

            [data-theme="dark"] .btn-success:hover {
                background: #5a6268 !important;
            }

            .table-responsive {
                border-radius: 12px;
                overflow: hidden;
            }

            .table {
                color: var(--text-primary);
                margin-bottom: 0;
                width: 100%;
            }

            .table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            [data-theme="dark"] .table thead {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
            }

            .table thead th {
                padding: 15px 12px;
                font-weight: 600;
                font-size: 13px;
                text-transform: uppercase;
                border: none;
                white-space: nowrap;
            }

            .table thead th:first-child {
                border-radius: 12px 0 0 0;
            }

            .table thead th:last-child {
                border-radius: 0 12px 0 0;
            }

            .table tbody tr {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }

            .table tbody tr:hover {
                background: var(--bg-tertiary);
            }

            .table tbody td {
                padding: 15px 12px;
                border: none;
                vertical-align: middle;
            }

            .table a {
                color: #667eea;
                font-weight: 600;
                text-decoration: none;
            }

            .table a:hover {
                text-decoration: underline;
            }

            [data-theme="dark"] .table a {
                color: #8b9df0;
            }

            .side-buy {
                color: #e74c3c;
                font-weight: 600;
            }

            .side-sell {
                color: #3498db;
                font-weight: 600;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-muted);
            }

            .empty-state i {
                font-size: 48px;
                display: block;
                margin-bottom: 15px;
            }

            .api-error {
                text-align: center;
                padding: 40px;
                color: var(--text-muted);
                background: var(--bg-secondary);
                border-radius: 12px;
                margin-bottom: 20px;
            }

            .price-cell {
                text-align: right;
                font-family: 'Courier New', monospace;
            }

            .number-cell {
                text-align: right;
            }

            .fills-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .fills-header h3 {
                margin: 0;
                color: var(--text-primary);
                font-size: 18px;
            }

            .fills-count {
                color: var(--text-muted);
                font-size: 14px;
            }

            .fills-count strong {
                color: #667eea;
                font-size: 18px;
            }

            [data-theme="dark"] .fills-count strong {
                color: #8b9df0;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="fills-container">
        <!-- ÌéòÏù¥ÏßÄ Ìó§Îçî -->
        <div class="page-header">
            <h2><i class="bi bi-receipt me-2"></i>Ï≤¥Í≤∞ ÎÇ¥Ïó≠ Ï°∞Ìöå</h2>
            <p>Ïã§Ï†ú Ï≤¥Í≤∞Îêú Ï£ºÎ¨∏Ïùò ÏÉÅÏÑ∏ ÎÇ¥Ïó≠ÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§</p>
        </div>

        <!-- Flash Messages -->
        <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <!-- API Connection Error -->
        <div th:if="${!apiConnected}" class="api-error">
            <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
            <h3>Trading SystemÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§</h3>
            <p>API ÏÑúÎ≤Ñ(Ìè¨Ìä∏ 8099)Í∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
            <p th:if="${errorDetail}" th:text="${errorDetail}" class="text-muted small"></p>
        </div>

        <!-- Filter Section -->
        <div th:if="${apiConnected}" class="card">
            <div class="card-body">
                <form th:action="@{/trading/fills}" method="get" class="filter-form">
                    <div class="filter-item">
                        <label class="form-label">Í≥ÑÏ¢å</label>
                        <select name="accountId" class="form-select" required>
                            <option th:each="account, accountStat : ${accounts}"
                                    th:value="${account.accountId}"
                                    th:text="${account.alias} + ' (' + ${account.cano} + ')'"
                                    th:selected="${account.accountId == selectedAccountId or (selectedAccountId == null and accountStat.first)}">
                                Account
                            </option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label class="form-label">ÏãúÏûëÏùº</label>
                        <input type="date"
                               name="startDate"
                               th:value="${param.startDate != null ? param.startDate[0] : #temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                               class="form-control">
                    </div>

                    <div class="filter-item">
                        <label class="form-label">Ï¢ÖÎ£åÏùº</label>
                        <input type="date"
                               name="endDate"
                               th:value="${param.endDate != null ? param.endDate[0] : #temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                               class="form-control">
                    </div>

                    <div class="filter-item">
                        <label class="form-label">Ï¢ÖÎ™©</label>
                        <div class="symbol-search-wrapper">
                            <input type="text"
                                   name="symbol"
                                   id="symbolInput"
                                   th:value="${selectedSymbol}"
                                   placeholder="Ï¢ÖÎ™© Í≤ÄÏÉâ"
                                   class="form-control"
                                   readonly>
                            <button type="button" class="symbol-search-btn" onclick="SymbolSearch.open('symbolInput', {multiSelect: false})" title="Ï¢ÖÎ™© Í≤ÄÏÉâ">
                                üîç
                            </button>
                        </div>
                    </div>

                    <div class="filter-item">
                        <label class="form-label">Ï£ºÎ¨∏Î≤àÌò∏</label>
                        <input type="text"
                               name="orderId"
                               th:value="${selectedOrderId}"
                               placeholder="Ï£ºÎ¨∏Î≤àÌò∏"
                               class="form-control">
                    </div>

                    <div class="filter-buttons">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-1"></i>Ï°∞Ìöå
                        </button>
                        <a th:href="@{/trading/fills}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Ï¥àÍ∏∞Ìôî
                        </a>
                        <button type="button" class="btn btn-success" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel me-1"></i>Export
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Fills List -->
        <div th:if="${apiConnected && selectedAccountId != null}" class="card">
            <div class="card-body">
                <div class="fills-header">
                    <h3><i class="bi bi-list-ul me-2"></i>Ï≤¥Í≤∞ ÎÇ¥Ïó≠</h3>
                    <div class="fills-count">
                        Ï¥ù <strong th:text="${fillCount ?: 0}">0</strong>Í±¥
                    </div>
                </div>

                <div th:if="${fills == null || fills.isEmpty()}" class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>Ï°∞ÌöåÎêú Ï≤¥Í≤∞ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    <p class="small text-muted">Îã§Î•∏ Ï°∞Í±¥ÏúºÎ°ú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî.</p>
                </div>

                <div th:if="${fills != null && !fills.isEmpty()}" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ï≤¥Í≤∞ÏùºÏãú</th>
                                <th>Ï¢ÖÎ™©</th>
                                <th>Íµ¨Î∂Ñ</th>
                                <th class="text-end">Ï≤¥Í≤∞Í∞Ä</th>
                                <th class="text-end">Ï≤¥Í≤∞ÏàòÎüâ</th>
                                <th class="text-end">ÏàòÏàòÎ£å</th>
                                <th class="text-end">ÏÑ∏Í∏à</th>
                                <th>Ï£ºÎ¨∏Î≤àÌò∏</th>
                                <th>Ï¶ùÍ∂åÏÇ¨Ï£ºÎ¨∏Î≤àÌò∏</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="fill : ${fills}">
                                <td>
                                    <a th:href="@{/trading/fills/{id}(id=${fill.fillId})}"
                                       th:text="${fill.fillTimestamp}">2025-01-01 09:00:00</a>
                                </td>
                                <td th:text="${fill.symbol}">005930</td>
                                <td>
                                    <span th:if="${fill.side == 'BUY'}" class="side-buy">Îß§Ïàò</span>
                                    <span th:if="${fill.side == 'SELL'}" class="side-sell">Îß§ÎèÑ</span>
                                </td>
                                <td class="text-end font-monospace" th:text="${#numbers.formatDecimal(fill.fillPrice, 0, 'COMMA', 2, 'POINT')}">70,000</td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(fill.fillQty, 0, 'COMMA', 0, 'POINT')}">10</td>
                                <td class="text-end font-monospace" th:text="${#numbers.formatDecimal(fill.fee, 0, 'COMMA', 0, 'POINT')}">350</td>
                                <td class="text-end font-monospace" th:text="${#numbers.formatDecimal(fill.tax, 0, 'COMMA', 0, 'POINT')}">1,400</td>
                                <td class="font-monospace small" th:text="${#strings.abbreviate(fill.orderId, 12)}">ord_...</td>
                                <td class="font-monospace small" th:text="${fill.brokerOrderNo ?: '-'}">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Initial State -->
        <div th:if="${apiConnected && selectedAccountId == null}" class="card">
            <div class="card-body empty-state">
                <i class="bi bi-search"></i>
                <p>Í≥ÑÏ¢åÎ•º ÏÑ†ÌÉùÌïòÍ≥† Ï°∞Ìöå Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.</p>
            </div>
        </div>

        <!-- Symbol Search Modal (Common Component) -->
        <div th:replace="~{fragments/symbol-search :: modal}"></div>

        <!-- Symbol Search Component Script -->
        <script th:src="@{/js/symbol-search.js}"></script>

        <script>
            function exportToExcel() {
                const params = new URLSearchParams(window.location.search);
                window.location.href = '/trading/fills/export?' + params.toString();
            }

            // Clear symbol input when clicking on it (allow manual clearing)
            document.getElementById('symbolInput')?.addEventListener('dblclick', function() {
                this.value = '';
            });
        </script>
    </div>
</div>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>체결 내역 조회</title>
    <th:block layout:fragment="extra-css">
        <style>
            .fills-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
                padding-bottom: 40px;
            }

            .page-header {
                margin-bottom: 30px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 30px 40px;
                border-radius: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            }
            [data-theme="dark"] .page-header {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .page-header h2 {
                font-size: 28px;
                font-weight: 700;
                margin: 0;
                color: white;
            }

            .page-header p {
                margin: 10px 0 0 0;
                opacity: 0.9;
                font-size: 15px;
            }

            .alert {
                padding: 15px 20px;
                margin-bottom: 20px;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }

            .alert-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .alert-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .card {
                background: var(--bg-secondary);
                border: none;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: background-color 0.3s ease;
                margin-bottom: 20px;
            }

            .card-body {
                color: var(--text-primary);
                padding: 20px;
            }

            .filter-form {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: center;
            }

            .filter-item {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .filter-buttons {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-left: auto;
            }

            .form-label {
                color: var(--text-primary);
                font-weight: 600;
                font-size: 14px;
                margin-bottom: 0;
                white-space: nowrap;
            }

            .form-select, .form-control {
                background: var(--bg-tertiary);
                border: 2px solid var(--border-color);
                color: var(--text-primary);
                padding: 10px 12px;
                border-radius: 8px;
                transition: all 0.3s ease;
            }

            .form-select:focus, .form-control:focus {
                background: var(--bg-tertiary);
                border-color: #667eea;
                color: var(--text-primary);
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .btn {
                padding: 10px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }

            [data-theme="dark"] .btn-primary {
                background: #6c757d;
                box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
            }

            [data-theme="dark"] .btn-primary:hover {
                background: #5a6268;
            }

            .btn-outline-secondary {
                border: 2px solid var(--border-color);
                color: var(--text-primary);
                background: transparent;
            }

            .btn-outline-secondary:hover {
                background: var(--bg-tertiary);
                border-color: var(--text-primary);
                color: var(--text-primary);
            }

            .btn-success {
                background: #28a745;
                color: white;
                border: none;
            }

            .btn-success:hover {
                background: #218838;
                transform: translateY(-2px);
            }

            .table-responsive {
                border-radius: 12px;
                overflow: hidden;
            }

            .table {
                color: var(--text-primary);
                margin-bottom: 0;
                width: 100%;
            }

            .table thead {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            [data-theme="dark"] .table thead {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
            }

            .table thead th {
                padding: 15px 12px;
                font-weight: 600;
                font-size: 13px;
                text-transform: uppercase;
                border: none;
                white-space: nowrap;
            }

            .table thead th:first-child {
                border-radius: 12px 0 0 0;
            }

            .table thead th:last-child {
                border-radius: 0 12px 0 0;
            }

            .table tbody tr {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }

            .table tbody tr:hover {
                background: var(--bg-tertiary);
            }

            .table tbody td {
                padding: 15px 12px;
                border: none;
                vertical-align: middle;
            }

            .table a {
                color: #667eea;
                font-weight: 600;
                text-decoration: none;
            }

            .table a:hover {
                text-decoration: underline;
            }

            [data-theme="dark"] .table a {
                color: #8b9df0;
            }

            .side-buy {
                color: #e74c3c;
                font-weight: 600;
            }

            .side-sell {
                color: #3498db;
                font-weight: 600;
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-muted);
            }

            .empty-state i {
                font-size: 48px;
                display: block;
                margin-bottom: 15px;
            }

            .api-error {
                text-align: center;
                padding: 40px;
                color: var(--text-muted);
                background: var(--bg-secondary);
                border-radius: 12px;
                margin-bottom: 20px;
            }

            .price-cell {
                text-align: right;
                font-family: 'Courier New', monospace;
            }

            .number-cell {
                text-align: right;
            }

            .fills-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .fills-header h3 {
                margin: 0;
                color: var(--text-primary);
                font-size: 18px;
            }

            .fills-count {
                color: var(--text-muted);
                font-size: 14px;
            }

            .fills-count strong {
                color: #667eea;
                font-size: 18px;
            }

            [data-theme="dark"] .fills-count strong {
                color: #8b9df0;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="fills-container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <h2><i class="bi bi-receipt me-2"></i>체결 내역 조회</h2>
            <p>실제 체결된 주문의 상세 내역을 확인합니다</p>
        </div>

        <!-- Flash Messages -->
        <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
        <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

        <!-- API Connection Error -->
        <div th:if="${!apiConnected}" class="api-error">
            <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
            <h3>Trading System에 연결할 수 없습니다</h3>
            <p>API 서버(포트 8099)가 실행 중인지 확인하세요.</p>
            <p th:if="${errorDetail}" th:text="${errorDetail}" class="text-muted small"></p>
        </div>

        <!-- Filter Section -->
        <div th:if="${apiConnected}" class="card">
            <div class="card-body">
                <form th:action="@{/trading/fills}" method="get" class="filter-form">
                    <div class="filter-item">
                        <label class="form-label">계좌</label>
                        <select name="accountId" class="form-select" required>
                            <option value="">계좌를 선택하세요</option>
                            <option th:each="account : ${accounts}"
                                    th:value="${account.accountId}"
                                    th:text="${account.alias} + ' (' + ${account.cano} + ')'"
                                    th:selected="${account.accountId == selectedAccountId}">
                                Account
                            </option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label class="form-label">시작일</label>
                        <input type="date"
                               name="startDate"
                               th:value="${param.startDate != null ? param.startDate[0] : #temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                               class="form-control">
                    </div>

                    <div class="filter-item">
                        <label class="form-label">종료일</label>
                        <input type="date"
                               name="endDate"
                               th:value="${param.endDate != null ? param.endDate[0] : #temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                               class="form-control">
                    </div>

                    <div class="filter-item">
                        <label class="form-label">종목코드</label>
                        <input type="text"
                               name="symbol"
                               th:value="${selectedSymbol}"
                               placeholder="예: 005930"
                               class="form-control">
                    </div>

                    <div class="filter-item">
                        <label class="form-label">주문번호</label>
                        <input type="text"
                               name="orderId"
                               th:value="${selectedOrderId}"
                               placeholder="주문번호"
                               class="form-control">
                    </div>

                    <div class="filter-buttons">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search me-1"></i>조회
                        </button>
                        <a th:href="@{/trading/fills}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>초기화
                        </a>
                        <button type="button" class="btn btn-success" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel me-1"></i>Export
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Fills List -->
        <div th:if="${apiConnected && selectedAccountId != null}" class="card">
            <div class="card-body">
                <div class="fills-header">
                    <h3><i class="bi bi-list-ul me-2"></i>체결 내역</h3>
                    <div class="fills-count">
                        총 <strong th:text="${fillCount ?: 0}">0</strong>건
                    </div>
                </div>

                <div th:if="${fills == null || fills.isEmpty()}" class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>조회된 체결 내역이 없습니다.</p>
                    <p class="small text-muted">다른 조건으로 검색해보세요.</p>
                </div>

                <div th:if="${fills != null && !fills.isEmpty()}" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>체결일시</th>
                                <th>종목</th>
                                <th>구분</th>
                                <th class="text-end">체결가</th>
                                <th class="text-end">체결수량</th>
                                <th class="text-end">수수료</th>
                                <th class="text-end">세금</th>
                                <th>주문번호</th>
                                <th>증권사주문번호</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="fill : ${fills}">
                                <td>
                                    <a th:href="@{/trading/fills/{id}(id=${fill.fillId})}"
                                       th:text="${fill.fillTimestamp}">2025-01-01 09:00:00</a>
                                </td>
                                <td th:text="${fill.symbol}">005930</td>
                                <td>
                                    <span th:if="${fill.side == 'BUY'}" class="side-buy">매수</span>
                                    <span th:if="${fill.side == 'SELL'}" class="side-sell">매도</span>
                                </td>
                                <td class="text-end font-monospace" th:text="${#numbers.formatDecimal(fill.fillPrice, 0, 'COMMA', 2, 'POINT')}">70,000</td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(fill.fillQty, 0, 'COMMA', 0, 'POINT')}">10</td>
                                <td class="text-end font-monospace" th:text="${#numbers.formatDecimal(fill.fee, 0, 'COMMA', 0, 'POINT')}">350</td>
                                <td class="text-end font-monospace" th:text="${#numbers.formatDecimal(fill.tax, 0, 'COMMA', 0, 'POINT')}">1,400</td>
                                <td class="font-monospace small" th:text="${#strings.abbreviate(fill.orderId, 12)}">ord_...</td>
                                <td class="font-monospace small" th:text="${fill.brokerOrderNo ?: '-'}">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Initial State -->
        <div th:if="${apiConnected && selectedAccountId == null}" class="card">
            <div class="card-body empty-state">
                <i class="bi bi-search"></i>
                <p>계좌를 선택하고 조회 버튼을 클릭하세요.</p>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
<script>
    function exportToExcel() {
        const params = new URLSearchParams(window.location.search);
        window.location.href = '/trading/fills/export?' + params.toString();
    }
</script>
</th:block>
</body>
</html>

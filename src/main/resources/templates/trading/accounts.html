<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>계좌 관리</title>
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" th:href="@{/css/trading.css}"/>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <!-- Skip Link for Accessibility -->
        <a href="#accounts-list" class="skip-link">계좌 목록으로 바로가기</a>

        <!-- Live Region for Dynamic Updates -->
        <div id="live-region" aria-live="polite" aria-atomic="true" class="sr-only"></div>

        <main class="accounts-page" role="main">
            <header class="page-header">
                <h1>
                    <span aria-hidden="true">💼</span>
                    <span>계좌 관리</span>
                </h1>
                <p>Trading System에 등록된 계좌 정보를 확인할 수 있습니다.</p>
            </header>

            <!-- Flash Messages -->
            <div th:if="${message}"
                 class="alert-success"
                 role="alert"
                 aria-live="polite"
                 th:text="${message}">
                성공 메시지
            </div>

            <!-- API Connection Error Alert -->
            <div th:if="${error}" class="alert alert-error" role="alert" aria-live="assertive">
                <div class="alert-title">
                    <span aria-hidden="true">⚠️</span>
                    <span>API 연결 오류</span>
                </div>
                <div class="alert-message" th:text="${error}">
                    Trading System API에 연결할 수 없습니다.
                </div>
                <div th:if="${errorDetail}" class="alert-detail">
                    <strong>상세 정보:</strong><br>
                    <span th:text="${errorDetail}">Error details</span>
                </div>
                <div class="alert-help">
                    <h4>해결 방법</h4>
                    <ol>
                        <li>Trading System API 서버가 실행 중인지 확인하세요 (포트 8099)</li>
                        <li>터미널에서 다음 명령어를 실행하세요:
                            <pre>cd /Users/changsupark/projects/cautostock
./run-with-env.sh</pre>
                        </li>
                        <li>Health Check 확인:
                            <a href="http://localhost:8099/health"
                               target="_blank"
                               rel="noopener noreferrer">
                                http://localhost:8099/health
                                <span class="sr-only">(새 창에서 열림)</span>
                            </a>
                        </li>
                    </ol>
                </div>
            </div>

            <!-- Action Header -->
            <div class="action-header">
                <h2 id="accounts-list-heading">계좌 목록</h2>
                <a th:href="@{/trading/accounts/new}"
                   class="btn btn-primary"
                   aria-label="새 계좌 등록">
                    <span aria-hidden="true">+</span> 계좌 등록
                </a>
            </div>

            <!-- Accounts Grid -->
            <section id="accounts-list"
                     aria-labelledby="accounts-list-heading"
                     th:if="${accounts != null && !accounts.isEmpty()}"
                     class="accounts-grid">
                <article th:each="account : ${accounts}"
                         class="account-card"
                         th:data-account-id="${account.accountId}"
                         th:aria-label="${account.alias + ' 계좌 정보'}"
                         tabindex="0"
                         onclick="window.location.href='/trading/accounts/' + this.getAttribute('data-account-id')"
                         onkeydown="if(event.key==='Enter') window.location.href='/trading/accounts/' + this.getAttribute('data-account-id')">
                    <header class="account-header">
                        <h3 class="account-name" th:text="${account.alias}">Account Name</h3>
                        <div>
                            <span class="badge"
                                  role="status"
                                  th:classappend="${account.environment == 'PAPER'} ? 'badge-paper' : 'badge-real'"
                                  th:aria-label="${account.environment == 'PAPER'} ? '모의투자 환경' : '실거래 환경'"
                                  th:text="${account.environment}">PAPER</span>
                        </div>
                    </header>
                    <dl class="account-info">
                        <div class="info-row">
                            <dt class="info-label">계좌번호</dt>
                            <dd class="info-value" th:text="${account.accountId}">Account ID</dd>
                        </div>
                        <div class="info-row">
                            <dt class="info-label">상태</dt>
                            <dd>
                                <span class="badge"
                                      role="status"
                                      th:classappend="${account.status == 'ACTIVE'} ? 'badge-active' : 'badge-inactive'"
                                      th:aria-label="${account.status == 'ACTIVE'} ? '활성 상태' : '비활성 상태'"
                                      th:text="${account.status}">ACTIVE</span>
                            </dd>
                        </div>
                        <div class="info-row" th:if="${account.createdAt}">
                            <dt class="info-label">등록일</dt>
                            <dd class="info-value" th:text="${#strings.substring(account.createdAt, 0, 16)}">2024-01-01</dd>
                        </div>
                    </dl>

                    <!-- Account Actions -->
                    <nav class="account-actions"
                         aria-label="계좌 관리 작업"
                         onclick="event.stopPropagation()"
                         onkeydown="event.stopPropagation()">
                        <a th:href="@{/trading/accounts/{id}(id=${account.accountId})}"
                           class="btn btn-primary btn-sm"
                           th:aria-label="${account.alias + ' 상세보기'}">상세보기</a>
                        <a th:href="@{/trading/accounts/{id}/edit(id=${account.accountId})}"
                           class="btn btn-secondary btn-sm"
                           th:aria-label="${account.alias + ' 수정'}">수정</a>
                        <a th:href="@{/trading/accounts/{id}/permissions(id=${account.accountId})}"
                           class="btn btn-warning btn-sm"
                           th:aria-label="${account.alias + ' 권한 관리'}">
                            <span aria-hidden="true">🔐</span> 권한 관리
                        </a>

                        <!-- Status Toggle Buttons -->
                        <form th:if="${account.status == 'INACTIVE'}"
                              class="delete-form"
                              th:action="@{/trading/accounts/{id}/status(id=${account.accountId})}"
                              method="post">
                            <input type="hidden" name="status" value="ACTIVE"/>
                            <button type="submit"
                                    class="btn btn-success btn-sm"
                                    th:aria-label="${account.alias + ' 활성화'}">활성화</button>
                        </form>

                        <form th:if="${account.status == 'ACTIVE'}"
                              class="delete-form"
                              th:action="@{/trading/accounts/{id}/status(id=${account.accountId})}"
                              method="post"
                              onsubmit="return confirm('이 계좌를 비활성화하시겠습니까?');">
                            <input type="hidden" name="status" value="INACTIVE"/>
                            <button type="submit"
                                    class="btn btn-warning btn-sm"
                                    th:aria-label="${account.alias + ' 비활성화'}">비활성화</button>
                        </form>

                        <!-- Delete Button -->
                        <form class="delete-form"
                              th:action="@{/trading/accounts/{id}/delete(id=${account.accountId})}"
                              method="post"
                              onsubmit="return confirm('정말로 이 계좌를 삭제하시겠습니까?');">
                            <button type="submit"
                                    class="btn btn-danger btn-sm"
                                    th:aria-label="${account.alias + ' 삭제'}">삭제</button>
                        </form>
                    </nav>
                </article>
            </section>

            <!-- Empty State -->
            <div th:if="${accounts == null || accounts.isEmpty()}"
                 class="trading-empty"
                 role="status"
                 aria-label="등록된 계좌가 없습니다">
                <div class="trading-empty-icon" aria-hidden="true">📭</div>
                <h3 class="trading-empty-title">등록된 계좌가 없습니다</h3>
                <p class="trading-empty-description">새 계좌를 등록하여 트레이딩을 시작하세요.</p>
                <a th:href="@{/trading/accounts/new}"
                   class="btn btn-primary"
                   aria-label="새 계좌 등록하기">계좌 등록하기</a>
            </div>
        </main>
    </div>
</body>
</html>

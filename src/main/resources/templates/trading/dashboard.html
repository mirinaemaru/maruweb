<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Trading Dashboard</title>
    <th:block layout:fragment="extra-css">
        <style>
            .trading-dashboard {
                padding: 30px;
                max-width: 1800px;
                margin: 0 auto;
            }
            .dashboard-header {
                margin-bottom: 40px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 40px;
                border-radius: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            }
            [data-theme="dark"] .dashboard-header {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .dashboard-header h1 {
                font-size: 36px;
                font-weight: 700;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 15px;
            }
            .dashboard-header p {
                font-size: 16px;
                opacity: 0.95;
            }

            /* Stats Grid */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 25px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border-left: 4px solid #667eea;
                transition: all 0.3s;
            }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            }

            .stat-card.positive {
                border-left-color: #28a745;
            }

            .stat-card.negative {
                border-left-color: #dc3545;
            }

            .stat-card.warning {
                border-left-color: #ffc107;
            }

            .stat-label {
                font-size: 13px;
                color: var(--text-secondary);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 10px;
            }

            .stat-value {
                font-size: 32px;
                font-weight: 800;
                color: var(--text-primary);
                margin-bottom: 5px;
            }

            .stat-change {
                font-size: 12px;
                color: var(--text-muted);
            }

            /* Main Grid */
            .dashboard-main-grid {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 25px;
                margin-bottom: 30px;
            }

            @media (max-width: 1200px) {
                .dashboard-main-grid {
                    grid-template-columns: 1fr;
                }
            }

            .dashboard-card {
                background: var(--bg-secondary);
                border-radius: 16px;
                padding: 28px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                border: 1px solid var(--border-color);
                transition: background-color 0.3s ease, border-color 0.3s ease;
            }

            .card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 2px solid var(--border-color);
                transition: border-color 0.3s ease;
            }

            .card-title {
                font-size: 20px;
                font-weight: 700;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .card-icon {
                font-size: 24px;
            }

            /* Chart Container */
            .chart-container {
                position: relative;
                height: 300px;
                margin-top: 20px;
            }

            /* Recent Activities */
            .activity-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .activity-item {
                padding: 15px;
                border-left: 3px solid #667eea;
                margin-bottom: 12px;
                background: var(--bg-tertiary);
                border-radius: 0 8px 8px 0;
                transition: all 0.2s;
            }

            .activity-item:hover {
                background: var(--filter-tab-hover);
                transform: translateX(5px);
            }

            .activity-time {
                font-size: 11px;
                color: var(--text-muted);
                margin-bottom: 5px;
            }

            .activity-title {
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 3px;
            }

            .activity-desc {
                font-size: 13px;
                color: var(--text-secondary);
            }

            /* System Status */
            .status-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .status-item {
                padding: 15px;
                background: var(--bg-tertiary);
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background-color 0.3s ease;
            }

            .status-badge {
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
            }

            .status-badge.up {
                background: #d4edda;
                color: #155724;
            }

            .status-badge.down {
                background: #f8d7da;
                color: #721c24;
            }

            /* Quick Actions */
            .quick-actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
                margin-top: 20px;
            }

            .quick-action-btn {
                padding: 12px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                text-align: center;
                transition: all 0.3s;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }

            .quick-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="trading-dashboard">
            <div class="dashboard-header">
                <h1>ğŸ“Š Trading System Dashboard</h1>
                <p>ì‹¤ì‹œê°„ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ì˜¤ëŠ˜ ì£¼ë¬¸</div>
                    <div class="stat-value" th:text="${todayOrders != null ? todayOrders : 0}">0</div>
                    <div class="stat-change">ì´ ì£¼ë¬¸ ê±´ìˆ˜</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ì˜¤ëŠ˜ ì²´ê²°</div>
                    <div class="stat-value" th:text="${todayFills != null ? todayFills : 0}">0</div>
                    <div class="stat-change">ì´ ì²´ê²° ê±´ìˆ˜</div>
                </div>

                <div class="stat-card" th:classappend="${todayProfitLoss != null && todayProfitLoss >= 0 ? 'positive' : 'negative'}">
                    <div class="stat-label">ì˜¤ëŠ˜ ì†ìµ</div>
                    <div class="stat-value">
                        <span th:if="${todayProfitLoss != null}" th:text="${#numbers.formatInteger(todayProfitLoss, 0, 'COMMA')}">0</span>
                        <span th:unless="${todayProfitLoss != null}">0</span>
                        <span style="font-size: 18px;">ì›</span>
                    </div>
                    <div class="stat-change">ì¼ì¼ ì†ìµ</div>
                </div>

                <div class="stat-card" th:classappend="${totalProfitLoss != null && totalProfitLoss >= 0 ? 'positive' : 'negative'}">
                    <div class="stat-label">ëˆ„ì  ì†ìµ</div>
                    <div class="stat-value">
                        <span th:if="${totalProfitLoss != null}" th:text="${#numbers.formatInteger(totalProfitLoss, 0, 'COMMA')}">0</span>
                        <span th:unless="${totalProfitLoss != null}">0</span>
                        <span style="font-size: 18px;">ì›</span>
                    </div>
                    <div class="stat-change">ì „ì²´ ì†ìµ</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ìŠ¹ë¥ </div>
                    <div class="stat-value">
                        <span th:if="${winRate != null}" th:text="${#numbers.formatDecimal(winRate, 1, 1)}">0.0</span>
                        <span th:unless="${winRate != null}">0.0</span>
                        <span style="font-size: 18px;">%</span>
                    </div>
                    <div class="stat-change">ê±°ë˜ ì„±ê³µë¥ </div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">í™œì„± ì „ëµ</div>
                    <div class="stat-value" th:text="${activeStrategyCount != null ? activeStrategyCount : 0}">0</div>
                    <div class="stat-change" th:text="'ì´ ' + ${strategyCount != null ? strategyCount : 0} + ' ê°œ'">ì´ 0 ê°œ</div>
                </div>
            </div>

            <!-- Main Grid -->
            <div class="dashboard-main-grid">
                <!-- Chart Section -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ“ˆ</span>
                            <span>ì¼ë³„ ì†ìµ ì¶”ì´</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="profitLossChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ“‹</span>
                            <span>ìµœê·¼ í™œë™</span>
                        </div>
                    </div>
                    <ul class="activity-list">
                        <li th:if="${recentActivities == null || #lists.isEmpty(recentActivities)}" class="activity-item">
                            <div class="activity-desc" style="text-align: center; color: var(--text-muted);">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </li>
                        <li th:each="activity : ${recentActivities}" class="activity-item">
                            <div class="activity-time" th:text="${activity.timestamp}">2024-01-01 10:00:00</div>
                            <div class="activity-title" th:text="${activity.title}">í™œë™ ì œëª©</div>
                            <div class="activity-desc" th:text="${activity.description}">í™œë™ ì„¤ëª…</div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- System Status Grid -->
            <div class="dashboard-main-grid">
                <!-- System Health -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ¥</span>
                            <span>ì‹œìŠ¤í…œ ìƒíƒœ</span>
                        </div>
                        <span class="status-badge" th:classappend="${systemStatus == 'UP' ? 'up' : 'down'}" th:text="${systemStatus ?: 'UNKNOWN'}">UP</span>
                    </div>
                    <div class="status-grid">
                        <div class="status-item">
                            <span>Database</span>
                            <span class="status-badge up">UP</span>
                        </div>
                        <div class="status-item">
                            <span>KIS REST</span>
                            <span class="status-badge up">UP</span>
                        </div>
                        <div class="status-item">
                            <span>KIS WebSocket</span>
                            <span class="status-badge up">UP</span>
                        </div>
                        <div class="status-item">
                            <span>Token</span>
                            <span class="status-badge up">VALID</span>
                        </div>
                    </div>
                </div>

                <!-- Accounts & Strategies -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ’¼</span>
                            <span>ê³„ì¢Œ ë° ì „ëµ</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">í™œì„± ê³„ì¢Œ</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-primary);" th:text="${accountCount != null ? accountCount : 0}">0</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">ì‹¤í–‰ ì¤‘ì¸ ì „ëµ</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-primary);" th:text="${activeStrategyCount != null ? activeStrategyCount : 0}">0</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">âš¡</span>
                        <span>ë¹ ë¥¸ ì•¡ì„¸ìŠ¤</span>
                    </div>
                </div>
                <div class="quick-actions">
                    <a th:href="@{/trading/accounts}" class="quick-action-btn">ğŸ’¼ ê³„ì¢Œ ê´€ë¦¬</a>
                    <a th:href="@{/trading/strategies}" class="quick-action-btn">ğŸ¯ ì „ëµ ê´€ë¦¬</a>
                    <a th:href="@{/trading/orders}" class="quick-action-btn">ğŸ“ˆ ì£¼ë¬¸ ì¡°íšŒ</a>
                    <a th:href="@{/trading/positions}" class="quick-action-btn">ğŸ“Š í¬ì§€ì…˜ ê´€ë¦¬</a>
                    <a th:href="@{/trading/fills}" class="quick-action-btn">âœ… ì²´ê²° ë‚´ì—­</a>
                    <a th:href="@{/trading/execution-history}" class="quick-action-btn">ğŸ“‹ ì‹¤í–‰ íˆìŠ¤í† ë¦¬</a>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="extra-scripts">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script>
            // Chart.jsë¥¼ ì‚¬ìš©í•œ ì†ìµ ì°¨íŠ¸
            let profitLossChart = null;
            const ctx = document.getElementById('profitLossChart');

            function initializeChart() {
                if (!ctx) return;

                const dailyStats = /*[[${dailyStats}]]*/ [];

                // ë°ì´í„° ì¤€ë¹„
                const labels = [];
                const profitLossData = [];

                if (dailyStats && dailyStats.length > 0) {
                    dailyStats.forEach(stat => {
                        labels.push(stat.date);
                        profitLossData.push(stat.profitLoss || 0);
                    });
                } else {
                    // ê¸°ë³¸ ë°ì´í„° (ìµœê·¼ 7ì¼)
                    const today = new Date();
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        labels.push(date.toISOString().split('T')[0]);
                        profitLossData.push(0);
                    }
                }

                profitLossChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ì¼ë³„ ì†ìµ (ì›)',
                            data: profitLossData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += new Intl.NumberFormat('ko-KR').format(context.parsed.y) + 'ì›';
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('ko-KR').format(value) + 'ì›';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateDashboardStats(stats) {
                console.log('Updating dashboard stats:', stats);

                // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                updateStatCard('todayOrders', stats.todayOrders || 0);
                updateStatCard('todayFills', stats.todayFills || 0);
                updateStatCard('todayProfitLoss', stats.todayProfitLoss || 0, true);
                updateStatCard('totalProfitLoss', stats.totalProfitLoss || 0, true);
                updateStatCard('winRate', stats.winRate || 0, false, '%');

                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                if (stats.dailyStats && profitLossChart) {
                    const labels = stats.dailyStats.map(stat => stat.date);
                    const data = stats.dailyStats.map(stat => stat.profitLoss || 0);

                    profitLossChart.data.labels = labels;
                    profitLossChart.data.datasets[0].data = data;
                    profitLossChart.update();
                }

                // ìµœê·¼ í™œë™ ì—…ë°ì´íŠ¸
                if (stats.recentActivities) {
                    updateRecentActivities(stats.recentActivities);
                }
            }

            function updateStatCard(name, value, isCurrency = false, suffix = '') {
                const elements = document.querySelectorAll('.stat-card .stat-value');
                const labels = ['ì˜¤ëŠ˜ ì£¼ë¬¸', 'ì˜¤ëŠ˜ ì²´ê²°', 'ì˜¤ëŠ˜ ì†ìµ', 'ëˆ„ì  ì†ìµ', 'ìŠ¹ë¥ '];
                const names = ['todayOrders', 'todayFills', 'todayProfitLoss', 'totalProfitLoss', 'winRate'];

                const index = names.indexOf(name);
                if (index !== -1 && elements[index]) {
                    const card = elements[index].closest('.stat-card');
                    let displayValue = value;

                    if (isCurrency) {
                        displayValue = new Intl.NumberFormat('ko-KR').format(value);
                        elements[index].innerHTML = displayValue + '<span style="font-size: 18px;">ì›</span>';

                        // positive/negative í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
                        card.classList.remove('positive', 'negative');
                        if (value >= 0) {
                            card.classList.add('positive');
                        } else {
                            card.classList.add('negative');
                        }
                    } else if (suffix === '%') {
                        displayValue = value.toFixed(1);
                        elements[index].innerHTML = displayValue + '<span style="font-size: 18px;">%</span>';
                    } else {
                        elements[index].textContent = displayValue;
                    }
                }
            }

            function updateRecentActivities(activities) {
                const activityList = document.querySelector('.activity-list');
                if (!activityList || !activities || activities.length === 0) return;

                activityList.innerHTML = '';
                activities.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'activity-item';
                    li.innerHTML = `
                        <div class="activity-time">${activity.timestamp || ''}</div>
                        <div class="activity-title">${activity.title || ''}</div>
                        <div class="activity-desc">${activity.description || ''}</div>
                    `;
                    activityList.appendChild(li);
                });
            }

            // WebSocket ì—°ê²° ë° ëŒ€ì‹œë³´ë“œ í†µê³„ êµ¬ë…
            document.addEventListener('DOMContentLoaded', function() {
                initializeChart();

                // WebSocket ì—°ê²°
                const socket = new SockJS('/ws-trading');
                const stompClient = Stomp.over(socket);

                stompClient.connect({}, function(frame) {
                    console.log('Dashboard WebSocket connected');

                    // ëŒ€ì‹œë³´ë“œ í†µê³„ êµ¬ë…
                    stompClient.subscribe('/topic/dashboard/stats', function(message) {
                        const stats = JSON.parse(message.body);
                        updateDashboardStats(stats);
                    });

                    console.log('Subscribed to /topic/dashboard/stats');
                }, function(error) {
                    console.error('Dashboard WebSocket error:', error);
                });

                // ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì—ì„œ ìµœì‹  í†µê³„ ìš”ì²­ (30ì´ˆë§ˆë‹¤)
                setInterval(function() {
                    fetch('/api/v1/query/dashboard/stats')
                        .then(response => response.json())
                        .then(stats => updateDashboardStats(stats))
                        .catch(error => console.error('Failed to fetch dashboard stats:', error));
                }, 30000);
            });
        </script>
    </th:block>
</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Trading Dashboard</title>
    <th:block layout:fragment="extra-css">
        <style>
            .trading-dashboard {
                padding: 30px;
                max-width: 1800px;
                margin: 0 auto;
            }
            .dashboard-header {
                margin-bottom: 40px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 40px;
                border-radius: 16px;
                color: white;
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
            }
            [data-theme="dark"] .dashboard-header {
                background: linear-gradient(135deg, #2a2d4a 0%, #1e2139 100%);
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .dashboard-header h1 {
                font-size: 36px;
                font-weight: 700;
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 15px;
            }
            .dashboard-header p {
                font-size: 16px;
                opacity: 0.95;
            }

            /* Stats Grid */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }

            .stat-card {
                background: var(--bg-secondary);
                border-radius: 12px;
                padding: 25px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border-left: 4px solid #667eea;
                transition: all 0.3s;
            }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            }

            .stat-card.positive {
                border-left-color: #28a745;
            }

            .stat-card.negative {
                border-left-color: #dc3545;
            }

            .stat-card.warning {
                border-left-color: #ffc107;
            }

            .stat-label {
                font-size: 13px;
                color: var(--text-secondary);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 10px;
            }

            .stat-value {
                font-size: 32px;
                font-weight: 800;
                color: var(--text-primary);
                margin-bottom: 5px;
            }

            .stat-change {
                font-size: 12px;
                color: var(--text-muted);
            }

            /* Main Grid */
            .dashboard-main-grid {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 25px;
                margin-bottom: 30px;
            }

            @media (max-width: 1200px) {
                .dashboard-main-grid {
                    grid-template-columns: 1fr;
                }
            }

            .dashboard-card {
                background: var(--bg-secondary);
                border-radius: 16px;
                padding: 28px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                border: 1px solid var(--border-color);
                transition: background-color 0.3s ease, border-color 0.3s ease;
            }

            .card-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 2px solid var(--border-color);
                transition: border-color 0.3s ease;
            }

            .card-title {
                font-size: 20px;
                font-weight: 700;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .card-icon {
                font-size: 24px;
            }

            /* Chart Container */
            .chart-container {
                position: relative;
                height: 300px;
                margin-top: 20px;
            }

            /* Recent Activities */
            .activity-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .activity-item {
                padding: 15px;
                border-left: 3px solid #667eea;
                margin-bottom: 12px;
                background: var(--bg-tertiary);
                border-radius: 0 8px 8px 0;
                transition: all 0.2s;
            }

            .activity-item:hover {
                background: var(--filter-tab-hover);
                transform: translateX(5px);
            }

            .activity-time {
                font-size: 11px;
                color: var(--text-muted);
                margin-bottom: 5px;
            }

            .activity-title {
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 3px;
            }

            .activity-desc {
                font-size: 13px;
                color: var(--text-secondary);
            }

            /* System Status */
            .status-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .status-item {
                padding: 15px;
                background: var(--bg-tertiary);
                border-radius: 8px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background-color 0.3s ease;
            }

            .status-badge {
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
            }

            .status-badge.up {
                background: #d4edda;
                color: #155724;
            }

            .status-badge.down {
                background: #f8d7da;
                color: #721c24;
            }

            /* Quick Actions */
            .quick-actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
                margin-top: 20px;
            }

            .quick-action-btn {
                padding: 12px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 14px;
                text-align: center;
                transition: all 0.3s;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }

            .quick-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }

            /* Dark mode styles for quick action buttons */
            [data-theme="dark"] .quick-action-btn {
                background: #4a5568 !important;
                background-image: none !important;
                box-shadow: none;
            }

            [data-theme="dark"] .quick-action-btn:hover {
                background: #5a6578 !important;
                background-image: none !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            }

            /* Position Summary Panel */
            .position-summary {
                margin-bottom: 30px;
            }

            .position-table {
                width: 100%;
                border-collapse: collapse;
            }

            .position-table th,
            .position-table td {
                padding: 12px 15px;
                text-align: left;
                border-bottom: 1px solid var(--border-color);
            }

            .position-table th {
                font-weight: 600;
                color: var(--text-secondary);
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                background: var(--bg-tertiary);
            }

            .position-table td {
                color: var(--text-primary);
            }

            .position-table tr:hover {
                background: var(--filter-tab-hover);
            }

            .profit-positive {
                color: #28a745 !important;
                font-weight: 600;
            }

            .profit-negative {
                color: #dc3545 !important;
                font-weight: 600;
            }

            .position-summary-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
                padding: 20px;
                background: var(--bg-tertiary);
                border-radius: 12px;
            }

            .summary-stat-item {
                text-align: center;
            }

            .summary-stat-label {
                font-size: 12px;
                color: var(--text-secondary);
                margin-bottom: 5px;
            }

            .summary-stat-value {
                font-size: 20px;
                font-weight: 700;
                color: var(--text-primary);
            }

            /* Strategy Monitor Panel */
            .strategy-monitor {
                margin-bottom: 30px;
            }

            .strategy-cards {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }

            .strategy-card {
                background: var(--bg-tertiary);
                border-radius: 12px;
                padding: 20px;
                border-left: 4px solid #667eea;
                transition: all 0.3s;
            }

            .strategy-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

            .strategy-card.status-active {
                border-left-color: #28a745;
            }

            .strategy-card.status-paused {
                border-left-color: #ffc107;
            }

            .strategy-card.status-inactive {
                border-left-color: #6c757d;
            }

            .strategy-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .strategy-card-name {
                font-size: 16px;
                font-weight: 700;
                color: var(--text-primary);
            }

            .strategy-status-badge {
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                text-transform: uppercase;
            }

            .strategy-status-badge.active {
                background: rgba(40, 167, 69, 0.2);
                color: #28a745;
            }

            .strategy-status-badge.paused {
                background: rgba(255, 193, 7, 0.2);
                color: #d39e00;
            }

            .strategy-status-badge.inactive {
                background: rgba(108, 117, 125, 0.2);
                color: #6c757d;
            }

            .strategy-card-stats {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }

            .strategy-stat {
                text-align: center;
            }

            .strategy-stat-label {
                font-size: 11px;
                color: var(--text-secondary);
                margin-bottom: 3px;
            }

            .strategy-stat-value {
                font-size: 14px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .strategy-last-signal {
                font-size: 12px;
                color: var(--text-secondary);
                padding-top: 10px;
                border-top: 1px solid var(--border-color);
            }

            /* Realtime Price Chart */
            .realtime-chart-panel {
                margin-bottom: 30px;
            }

            .chart-controls {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 15px;
            }

            .symbol-selector {
                padding: 8px 15px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                font-size: 14px;
                min-width: 200px;
            }

            .chart-legend {
                display: flex;
                align-items: center;
                gap: 20px;
                margin-left: auto;
                font-size: 12px;
                color: var(--text-secondary);
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .legend-marker {
                width: 12px;
                height: 12px;
                border-radius: 2px;
            }

            .legend-marker.buy-signal {
                background: #28a745;
                clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            }

            .legend-marker.sell-signal {
                background: #dc3545;
                clip-path: polygon(0% 0%, 100% 0%, 50% 100%);
            }

            .legend-marker.fill {
                background: #667eea;
            }

            .realtime-chart-container {
                position: relative;
                height: 350px;
            }

            .no-data-message {
                text-align: center;
                padding: 40px;
                color: var(--text-secondary);
            }

            /* Empty state */
            .empty-state {
                text-align: center;
                padding: 40px;
                color: var(--text-secondary);
            }

            .empty-state-icon {
                font-size: 48px;
                margin-bottom: 15px;
                opacity: 0.5;
            }

            .empty-state-text {
                font-size: 14px;
            }

            /* Symbol Search */
            .symbol-search-container {
                position: relative;
                min-width: 280px;
            }

            .symbol-search-input {
                width: 100%;
                padding: 10px 15px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                font-size: 14px;
                outline: none;
                transition: border-color 0.2s, box-shadow 0.2s;
            }

            .symbol-search-input:focus {
                border-color: var(--accent-primary);
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            }

            .symbol-search-input::placeholder {
                color: var(--text-secondary);
            }

            .symbol-search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                max-height: 300px;
                overflow-y: auto;
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                margin-top: 4px;
            }

            .symbol-search-item {
                padding: 10px 15px;
                cursor: pointer;
                border-bottom: 1px solid var(--border-color);
                transition: background 0.2s;
            }

            .symbol-search-item:last-child {
                border-bottom: none;
            }

            .symbol-search-item:hover {
                background: var(--filter-tab-hover);
            }

            .symbol-search-item.selected {
                background: var(--accent-primary);
                color: white;
            }

            .symbol-code {
                font-weight: 700;
                color: var(--text-primary);
            }

            .symbol-search-item:hover .symbol-code,
            .symbol-search-item.selected .symbol-code {
                color: inherit;
            }

            .symbol-name {
                font-size: 12px;
                color: var(--text-secondary);
                margin-left: 8px;
            }

            .symbol-search-item:hover .symbol-name,
            .symbol-search-item.selected .symbol-name {
                color: inherit;
                opacity: 0.8;
            }

            .symbol-market {
                font-size: 11px;
                color: var(--text-secondary);
                float: right;
                padding: 2px 6px;
                background: var(--bg-tertiary);
                border-radius: 4px;
            }

            .symbol-search-loading,
            .symbol-search-empty {
                padding: 15px;
                text-align: center;
                color: var(--text-secondary);
                font-size: 13px;
            }

            .selected-symbol-badge {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 6px 12px;
                background: var(--accent-primary);
                color: white;
                border-radius: 20px;
                font-size: 13px;
                font-weight: 600;
            }

            .selected-symbol-badge .clear-btn {
                cursor: pointer;
                opacity: 0.8;
                transition: opacity 0.2s;
            }

            .selected-symbol-badge .clear-btn:hover {
                opacity: 1;
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="trading-dashboard">
            <div class="dashboard-header">
                <h1>ğŸ“Š Trading System Dashboard</h1>
                <p>ì‹¤ì‹œê°„ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë° ê´€ë¦¬</p>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ì˜¤ëŠ˜ ì£¼ë¬¸</div>
                    <div class="stat-value" th:text="${todayOrders != null ? todayOrders : 0}">0</div>
                    <div class="stat-change">ì´ ì£¼ë¬¸ ê±´ìˆ˜</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ì˜¤ëŠ˜ ì²´ê²°</div>
                    <div class="stat-value" th:text="${todayFills != null ? todayFills : 0}">0</div>
                    <div class="stat-change">ì´ ì²´ê²° ê±´ìˆ˜</div>
                </div>

                <div class="stat-card" th:classappend="${todayProfitLoss != null && todayProfitLoss >= 0 ? 'positive' : 'negative'}">
                    <div class="stat-label">ì˜¤ëŠ˜ ì†ìµ</div>
                    <div class="stat-value">
                        <span th:if="${todayProfitLoss != null}" th:text="${#numbers.formatInteger(todayProfitLoss, 0, 'COMMA')}">0</span>
                        <span th:unless="${todayProfitLoss != null}">0</span>
                        <span style="font-size: 18px;">ì›</span>
                    </div>
                    <div class="stat-change">ì¼ì¼ ì†ìµ</div>
                </div>

                <div class="stat-card" th:classappend="${totalProfitLoss != null && totalProfitLoss >= 0 ? 'positive' : 'negative'}">
                    <div class="stat-label">ëˆ„ì  ì†ìµ</div>
                    <div class="stat-value">
                        <span th:if="${totalProfitLoss != null}" th:text="${#numbers.formatInteger(totalProfitLoss, 0, 'COMMA')}">0</span>
                        <span th:unless="${totalProfitLoss != null}">0</span>
                        <span style="font-size: 18px;">ì›</span>
                    </div>
                    <div class="stat-change">ì „ì²´ ì†ìµ</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">ìŠ¹ë¥ </div>
                    <div class="stat-value">
                        <span th:if="${winRate != null}" th:text="${#numbers.formatDecimal(winRate, 1, 1)}">0.0</span>
                        <span th:unless="${winRate != null}">0.0</span>
                        <span style="font-size: 18px;">%</span>
                    </div>
                    <div class="stat-change">ê±°ë˜ ì„±ê³µë¥ </div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">í™œì„± ì „ëµ</div>
                    <div class="stat-value" th:text="${activeStrategyCount != null ? activeStrategyCount : 0}">0</div>
                    <div class="stat-change" th:text="'ì´ ' + ${strategyCount != null ? strategyCount : 0} + ' ê°œ'">ì´ 0 ê°œ</div>
                </div>
            </div>

            <!-- Position Summary Panel -->
            <div class="dashboard-card position-summary">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ’¼</span>
                        <span>í¬íŠ¸í´ë¦¬ì˜¤ í˜„í™©</span>
                    </div>
                    <select class="symbol-selector" id="accountSelector" th:if="${accounts != null && !#lists.isEmpty(accounts)}">
                        <option th:each="account : ${accounts}"
                                th:value="${account['accountId']}"
                                th:text="${account['alias'] != null ? account['alias'] : account['accountId']}"
                                th:selected="${account['accountId'] == selectedAccountId}">
                        </option>
                    </select>
                </div>

                <!-- Position Summary Stats -->
                <div class="position-summary-stats" id="positionSummaryStats">
                    <div class="summary-stat-item">
                        <div class="summary-stat-label">ë³´ìœ  ì¢…ëª©</div>
                        <div class="summary-stat-value" id="positionCount" th:text="${positionCount != null ? positionCount : 0}">0</div>
                    </div>
                    <div class="summary-stat-item">
                        <div class="summary-stat-label">ì´ í‰ê°€ê¸ˆì•¡</div>
                        <div class="summary-stat-value" id="totalEvaluation">
                            <span th:if="${balance != null && balance['totalEvaluation'] != null}"
                                  th:text="${#numbers.formatInteger(balance['totalEvaluation'], 0, 'COMMA')} + 'ì›'">0ì›</span>
                            <span th:unless="${balance != null && balance['totalEvaluation'] != null}">0ì›</span>
                        </div>
                    </div>
                    <div class="summary-stat-item">
                        <div class="summary-stat-label">ë¯¸ì‹¤í˜„ ì†ìµ</div>
                        <div class="summary-stat-value" id="unrealizedPnL"
                             th:classappend="${balance != null && balance['unrealizedPnL'] != null && balance['unrealizedPnL'] >= 0 ? 'profit-positive' : 'profit-negative'}">
                            <span th:if="${balance != null && balance['unrealizedPnL'] != null}"
                                  th:text="${#numbers.formatInteger(balance['unrealizedPnL'], 0, 'COMMA')} + 'ì›'">0ì›</span>
                            <span th:unless="${balance != null && balance['unrealizedPnL'] != null}">0ì›</span>
                        </div>
                    </div>
                    <div class="summary-stat-item">
                        <div class="summary-stat-label">ìˆ˜ìµë¥ </div>
                        <div class="summary-stat-value" id="returnRate"
                             th:classappend="${balance != null && balance['returnRate'] != null && balance['returnRate'] >= 0 ? 'profit-positive' : 'profit-negative'}">
                            <span th:if="${balance != null && balance['returnRate'] != null}"
                                  th:text="${#numbers.formatDecimal(balance['returnRate'], 1, 2)} + '%'">0.00%</span>
                            <span th:unless="${balance != null && balance['returnRate'] != null}">0.00%</span>
                        </div>
                    </div>
                </div>

                <!-- Position Table -->
                <div th:if="${positions != null && !#lists.isEmpty(positions)}">
                    <table class="position-table" id="positionTable">
                        <thead>
                            <tr>
                                <th>ì¢…ëª©</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>í‰ê· ë‹¨ê°€</th>
                                <th>í˜„ì¬ê°€</th>
                                <th>í‰ê°€ê¸ˆì•¡</th>
                                <th>ì†ìµ</th>
                                <th>ìˆ˜ìµë¥ </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="position : ${positions}">
                                <td>
                                    <strong th:text="${position['symbol']}">AAPL</strong>
                                    <div style="font-size: 11px; color: var(--text-secondary);" th:text="${position['symbolName']}">Apple Inc.</div>
                                </td>
                                <td th:text="${position['quantity']}">100</td>
                                <td th:text="${#numbers.formatInteger(position['avgPrice'], 0, 'COMMA')} + 'ì›'">50,000ì›</td>
                                <td th:text="${#numbers.formatInteger(position['currentPrice'], 0, 'COMMA')} + 'ì›'">55,000ì›</td>
                                <td th:text="${#numbers.formatInteger(position['evaluation'], 0, 'COMMA')} + 'ì›'">5,500,000ì›</td>
                                <td th:classappend="${position['profitLoss'] != null && position['profitLoss'] >= 0 ? 'profit-positive' : 'profit-negative'}"
                                    th:text="${#numbers.formatInteger(position['profitLoss'], 0, 'COMMA')} + 'ì›'">500,000ì›</td>
                                <td th:classappend="${position['returnRate'] != null && position['returnRate'] >= 0 ? 'profit-positive' : 'profit-negative'}"
                                    th:text="${#numbers.formatDecimal(position['returnRate'], 1, 2)} + '%'">10.00%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div th:unless="${positions != null && !#lists.isEmpty(positions)}" class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <div class="empty-state-text">ë³´ìœ  ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- Strategy Monitor Panel -->
            <div class="dashboard-card strategy-monitor">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ¯</span>
                        <span>ì „ëµ ëª¨ë‹ˆí„°</span>
                    </div>
                    <a th:href="@{/trading/strategies}" style="font-size: 13px; color: var(--accent-primary); text-decoration: none;">ëª¨ë‘ ë³´ê¸° â†’</a>
                </div>

                <div th:if="${strategies != null && !#lists.isEmpty(strategies)}" class="strategy-cards" id="strategyCards">
                    <div th:each="strategy, iterStat : ${strategies}" th:if="${iterStat.index < 6}"
                         class="strategy-card"
                         th:classappend="${strategy['status'] == 'ACTIVE' ? 'status-active' : (strategy['status'] == 'PAUSED' ? 'status-paused' : 'status-inactive')}">
                        <div class="strategy-card-header">
                            <div class="strategy-card-name" th:text="${strategy['name']}">MA Crossover</div>
                            <span class="strategy-status-badge"
                                  th:classappend="${strategy['status'] == 'ACTIVE' ? 'active' : (strategy['status'] == 'PAUSED' ? 'paused' : 'inactive')}"
                                  th:text="${strategy['status']}">ACTIVE</span>
                        </div>
                        <div class="strategy-card-stats">
                            <div class="strategy-stat">
                                <div class="strategy-stat-label">ìŠ¹ë¥ </div>
                                <div class="strategy-stat-value">
                                    <span th:if="${strategy['winRate'] != null}" th:text="${#numbers.formatDecimal(strategy['winRate'], 1, 1)} + '%'">65.5%</span>
                                    <span th:unless="${strategy['winRate'] != null}">-</span>
                                </div>
                            </div>
                            <div class="strategy-stat">
                                <div class="strategy-stat-label">ê±°ë˜ìˆ˜</div>
                                <div class="strategy-stat-value" th:text="${strategy['totalTrades'] != null ? strategy['totalTrades'] : 0}">156</div>
                            </div>
                            <div class="strategy-stat">
                                <div class="strategy-stat-label">ì†ìµ</div>
                                <div class="strategy-stat-value"
                                     th:classappend="${strategy['totalProfitLoss'] != null && strategy['totalProfitLoss'] >= 0 ? 'profit-positive' : 'profit-negative'}">
                                    <span th:if="${strategy['totalProfitLoss'] != null}"
                                          th:text="${#numbers.formatInteger(strategy['totalProfitLoss'], 0, 'COMMA')}">1,250,000</span>
                                    <span th:unless="${strategy['totalProfitLoss'] != null}">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="strategy-last-signal" th:if="${strategy['lastSignal'] != null}">
                            ìµœê·¼ ì‹ í˜¸: <span th:text="${strategy['lastSignal']}">BUY at 50,000</span>
                        </div>
                        <div class="strategy-last-signal" th:unless="${strategy['lastSignal'] != null}">
                            ìµœê·¼ ì‹ í˜¸: ì—†ìŒ
                        </div>
                    </div>
                </div>
                <div th:unless="${strategies != null && !#lists.isEmpty(strategies)}" class="empty-state">
                    <div class="empty-state-icon">ğŸ¯</div>
                    <div class="empty-state-text">ë“±ë¡ëœ ì „ëµì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- Realtime Price Chart Panel -->
            <div class="dashboard-card realtime-chart-panel">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ“ˆ</span>
                        <span>ì‹¤ì‹œê°„ ì‹œì„¸</span>
                    </div>
                </div>
                <div class="chart-controls">
                    <div class="symbol-search-container">
                        <input type="text" class="symbol-search-input" id="symbolSearchInput"
                               placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰..." autocomplete="off">
                        <input type="hidden" id="selectedSymbol" value="">
                        <div class="symbol-search-results" id="symbolSearchResults" style="display: none;"></div>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-marker buy-signal"></div>
                            <span>ë§¤ìˆ˜ ì‹ í˜¸</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker sell-signal"></div>
                            <span>ë§¤ë„ ì‹ í˜¸</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-marker fill"></div>
                            <span>ì²´ê²°</span>
                        </div>
                    </div>
                </div>
                <div class="realtime-chart-container">
                    <canvas id="realtimePriceChart"></canvas>
                    <div id="chartNoData" class="no-data-message" style="display: none;">
                        ì¢…ëª©ì„ ì„ íƒí•˜ë©´ ì‹¤ì‹œê°„ ì‹œì„¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                    </div>
                </div>
            </div>

            <!-- Main Grid -->
            <div class="dashboard-main-grid">
                <!-- Chart Section -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ“ˆ</span>
                            <span>ì¼ë³„ ì†ìµ ì¶”ì´</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="profitLossChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ“‹</span>
                            <span>ìµœê·¼ í™œë™</span>
                        </div>
                    </div>
                    <ul class="activity-list">
                        <li th:if="${recentActivities == null || #lists.isEmpty(recentActivities)}" class="activity-item">
                            <div class="activity-desc" style="text-align: center; color: var(--text-muted);">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </li>
                        <li th:each="activity : ${recentActivities}" class="activity-item">
                            <div class="activity-time" th:text="${activity['timestamp']}">2024-01-01 10:00:00</div>
                            <div class="activity-title" th:text="${activity['title']}">í™œë™ ì œëª©</div>
                            <div class="activity-desc" th:text="${activity['description']}">í™œë™ ì„¤ëª…</div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- System Status Grid -->
            <div class="dashboard-main-grid">
                <!-- System Health -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ¥</span>
                            <span>ì‹œìŠ¤í…œ ìƒíƒœ</span>
                        </div>
                        <span id="health-system" class="status-badge" th:classappend="${systemStatus == 'UP' ? 'up' : 'down'}" th:text="${systemStatus ?: 'UNKNOWN'}">UP</span>
                    </div>
                    <div class="status-grid">
                        <div class="status-item">
                            <span>Database</span>
                            <span id="health-db" class="status-badge"
                                  th:classappend="${health != null and health['components'] != null and health['components']['db'] == 'UP' ? 'up' : 'down'}"
                                  th:text="${health != null and health['components'] != null ? health['components']['db'] : 'UNKNOWN'}">UP</span>
                        </div>
                        <div class="status-item">
                            <span>KIS REST</span>
                            <span id="health-kisRest" class="status-badge"
                                  th:classappend="${health != null and health['components'] != null and health['components']['kisRest'] == 'UP' ? 'up' : 'down'}"
                                  th:text="${health != null and health['components'] != null ? health['components']['kisRest'] : 'UNKNOWN'}">UP</span>
                        </div>
                        <div class="status-item">
                            <span>KIS WebSocket</span>
                            <span id="health-kisWs" class="status-badge"
                                  th:classappend="${health != null and health['components'] != null and health['components']['kisWs'] == 'UP' ? 'up' : 'down'}"
                                  th:text="${health != null and health['components'] != null ? health['components']['kisWs'] : 'UNKNOWN'}">UP</span>
                        </div>
                        <div class="status-item">
                            <span>Token</span>
                            <span id="health-token" class="status-badge"
                                  th:classappend="${health != null and health['components'] != null and health['components']['token'] == 'VALID' ? 'up' : 'down'}"
                                  th:text="${health != null and health['components'] != null ? health['components']['token'] : 'UNKNOWN'}">VALID</span>
                        </div>
                    </div>
                </div>

                <!-- Accounts & Strategies -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-title">
                            <span class="card-icon">ğŸ’¼</span>
                            <span>ê³„ì¢Œ ë° ì „ëµ</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">í™œì„± ê³„ì¢Œ</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-primary);" th:text="${accountCount != null ? accountCount : 0}">0</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">ì‹¤í–‰ ì¤‘ì¸ ì „ëµ</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--accent-primary);" th:text="${activeStrategyCount != null ? activeStrategyCount : 0}">0</div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">âš¡</span>
                        <span>ë¹ ë¥¸ ì•¡ì„¸ìŠ¤</span>
                    </div>
                </div>
                <div class="quick-actions">
                    <a th:href="@{/trading/accounts}" class="quick-action-btn">ğŸ’¼ ê³„ì¢Œ ê´€ë¦¬</a>
                    <a th:href="@{/trading/strategies}" class="quick-action-btn">ğŸ¯ ì „ëµ ê´€ë¦¬</a>
                    <a th:href="@{/trading/orders}" class="quick-action-btn">ğŸ“ˆ ì£¼ë¬¸ ì¡°íšŒ</a>
                    <a th:href="@{/trading/positions}" class="quick-action-btn">ğŸ“Š í¬ì§€ì…˜ ê´€ë¦¬</a>
                    <a th:href="@{/trading/fills}" class="quick-action-btn">âœ… ì²´ê²° ë‚´ì—­</a>
                    <a th:href="@{/trading/execution-history}" class="quick-action-btn">ğŸ“‹ ì‹¤í–‰ íˆìŠ¤í† ë¦¬</a>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="extra-scripts">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script>
            // Chart.jsë¥¼ ì‚¬ìš©í•œ ì†ìµ ì°¨íŠ¸
            let profitLossChart = null;
            const ctx = document.getElementById('profitLossChart');

            function initializeChart() {
                if (!ctx) return;

                const dailyStats = /*[[${dailyStats}]]*/ [];

                // ë°ì´í„° ì¤€ë¹„
                const labels = [];
                const profitLossData = [];

                if (dailyStats && dailyStats.length > 0) {
                    dailyStats.forEach(stat => {
                        labels.push(stat.date);
                        profitLossData.push(stat.profitLoss || 0);
                    });
                } else {
                    // ê¸°ë³¸ ë°ì´í„° (ìµœê·¼ 7ì¼)
                    const today = new Date();
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        labels.push(date.toISOString().split('T')[0]);
                        profitLossData.push(0);
                    }
                }

                profitLossChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ì¼ë³„ ì†ìµ (ì›)',
                            data: profitLossData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += new Intl.NumberFormat('ko-KR').format(context.parsed.y) + 'ì›';
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return new Intl.NumberFormat('ko-KR').format(value) + 'ì›';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // í†µê³„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateDashboardStats(stats) {
                console.log('Updating dashboard stats:', stats);

                // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
                updateStatCard('todayOrders', stats.todayOrders || 0);
                updateStatCard('todayFills', stats.todayFills || 0);
                updateStatCard('todayProfitLoss', stats.todayProfitLoss || 0, true);
                updateStatCard('totalProfitLoss', stats.totalProfitLoss || 0, true);
                updateStatCard('winRate', stats.winRate || 0, false, '%');

                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                if (stats.dailyStats && profitLossChart) {
                    const labels = stats.dailyStats.map(stat => stat.date);
                    const data = stats.dailyStats.map(stat => stat.profitLoss || 0);

                    profitLossChart.data.labels = labels;
                    profitLossChart.data.datasets[0].data = data;
                    profitLossChart.update();
                }

                // ìµœê·¼ í™œë™ ì—…ë°ì´íŠ¸
                if (stats.recentActivities) {
                    updateRecentActivities(stats.recentActivities);
                }
            }

            function updateStatCard(name, value, isCurrency = false, suffix = '') {
                const elements = document.querySelectorAll('.stat-card .stat-value');
                const labels = ['ì˜¤ëŠ˜ ì£¼ë¬¸', 'ì˜¤ëŠ˜ ì²´ê²°', 'ì˜¤ëŠ˜ ì†ìµ', 'ëˆ„ì  ì†ìµ', 'ìŠ¹ë¥ '];
                const names = ['todayOrders', 'todayFills', 'todayProfitLoss', 'totalProfitLoss', 'winRate'];

                const index = names.indexOf(name);
                if (index !== -1 && elements[index]) {
                    const card = elements[index].closest('.stat-card');
                    let displayValue = value;

                    if (isCurrency) {
                        displayValue = new Intl.NumberFormat('ko-KR').format(value);
                        elements[index].innerHTML = displayValue + '<span style="font-size: 18px;">ì›</span>';

                        // positive/negative í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸
                        card.classList.remove('positive', 'negative');
                        if (value >= 0) {
                            card.classList.add('positive');
                        } else {
                            card.classList.add('negative');
                        }
                    } else if (suffix === '%') {
                        displayValue = value.toFixed(1);
                        elements[index].innerHTML = displayValue + '<span style="font-size: 18px;">%</span>';
                    } else {
                        elements[index].textContent = displayValue;
                    }
                }
            }

            function updateRecentActivities(activities) {
                const activityList = document.querySelector('.activity-list');
                if (!activityList || !activities || activities.length === 0) return;

                activityList.innerHTML = '';
                activities.forEach(activity => {
                    const li = document.createElement('li');
                    li.className = 'activity-item';
                    li.innerHTML = `
                        <div class="activity-time">${activity.timestamp || ''}</div>
                        <div class="activity-title">${activity.title || ''}</div>
                        <div class="activity-desc">${activity.description || ''}</div>
                    `;
                    activityList.appendChild(li);
                });
            }

            // WebSocket ì—°ê²° ë° ëŒ€ì‹œë³´ë“œ í†µê³„ êµ¬ë…
            document.addEventListener('DOMContentLoaded', function() {
                initializeChart();

                // WebSocket ì—°ê²°
                const socket = new SockJS('/ws-trading');
                const stompClient = Stomp.over(socket);

                stompClient.connect({}, function(frame) {
                    console.log('Dashboard WebSocket connected');

                    // ëŒ€ì‹œë³´ë“œ í†µê³„ êµ¬ë…
                    stompClient.subscribe('/topic/dashboard/stats', function(message) {
                        const stats = JSON.parse(message.body);
                        updateDashboardStats(stats);
                    });

                    console.log('Subscribed to /topic/dashboard/stats');
                }, function(error) {
                    console.error('Dashboard WebSocket error:', error);
                });

                // ì£¼ê¸°ì ìœ¼ë¡œ ì„œë²„ì—ì„œ ìµœì‹  í†µê³„ ìš”ì²­ (30ì´ˆë§ˆë‹¤)
                setInterval(function() {
                    fetch('/api/v1/query/dashboard/stats')
                        .then(response => response.json())
                        .then(stats => updateDashboardStats(stats))
                        .catch(error => console.error('Failed to fetch dashboard stats:', error));
                }, 30000);

                // í—¬ìŠ¤ ìƒíƒœ ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆë§ˆë‹¤)
                refreshHealthStatus();
                setInterval(refreshHealthStatus, 30000);
            });

            // í—¬ìŠ¤ ìƒíƒœ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
            function refreshHealthStatus() {
                fetch('/trading/api/health')
                    .then(response => response.json())
                    .then(health => {
                        updateHealthBadge('health-system', health.status);
                        const components = health.components || {};
                        updateHealthBadge('health-db', components.db);
                        updateHealthBadge('health-kisRest', components.kisRest);
                        updateHealthBadge('health-kisWs', components.kisWs);
                        updateHealthBadge('health-token', components.token, 'VALID');
                    })
                    .catch(error => {
                        console.error('Health check failed:', error);
                        // ì—°ê²° ì‹¤íŒ¨ ì‹œ ëª¨ë“  ìƒíƒœë¥¼ UNKNOWNìœ¼ë¡œ í‘œì‹œ
                        ['health-system', 'health-db', 'health-kisRest', 'health-kisWs', 'health-token'].forEach(id => {
                            const badge = document.getElementById(id);
                            if (badge) {
                                badge.textContent = 'UNKNOWN';
                                badge.classList.remove('up');
                                badge.classList.add('down');
                            }
                        });
                    });
            }

            // ê°œë³„ í—¬ìŠ¤ ë±ƒì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateHealthBadge(id, value, successValue = 'UP') {
                const badge = document.getElementById(id);
                if (badge) {
                    badge.textContent = value || 'UNKNOWN';
                    badge.classList.remove('up', 'down');
                    badge.classList.add(value === successValue ? 'up' : 'down');
                }
            }

            // =============================================
            // Position Summary & Realtime Chart Functions
            // =============================================

            let realtimePriceChart = null;
            let priceDataBuffer = [];
            let priceUpdateInterval = null;
            let selectedSymbol = null;

            // ê³„ì¢Œ ì„ íƒ ë³€ê²½ ì‹œ í¬ì§€ì…˜ ë°ì´í„° ê°±ì‹ 
            const accountSelector = document.getElementById('accountSelector');
            if (accountSelector) {
                accountSelector.addEventListener('change', function() {
                    const accountId = this.value;
                    if (accountId) {
                        refreshPositionData(accountId);
                        refreshBalanceData(accountId);
                    }
                });
            }

            // í¬ì§€ì…˜ ë°ì´í„° ê°±ì‹ 
            function refreshPositionData(accountId) {
                fetch(`/trading/api/positions?accountId=${accountId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.items) {
                            updatePositionTable(data.items);
                            document.getElementById('positionCount').textContent = data.items.length;
                        }
                    })
                    .catch(error => console.error('Failed to refresh positions:', error));
            }

            // ì”ê³  ë°ì´í„° ê°±ì‹ 
            function refreshBalanceData(accountId) {
                fetch(`/trading/api/balance?accountId=${accountId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateBalanceSummary(data);
                        }
                    })
                    .catch(error => console.error('Failed to refresh balance:', error));
            }

            // í¬ì§€ì…˜ í…Œì´ë¸” ì—…ë°ì´íŠ¸
            function updatePositionTable(positions) {
                const tableBody = document.querySelector('#positionTable tbody');
                if (!tableBody) return;

                if (positions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary);">ë³´ìœ  ì¤‘ì¸ í¬ì§€ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tableBody.innerHTML = positions.map(pos => `
                    <tr>
                        <td>
                            <strong>${pos.symbol}</strong>
                            <div style="font-size: 11px; color: var(--text-secondary);">${pos.symbolName || ''}</div>
                        </td>
                        <td>${pos.quantity}</td>
                        <td>${formatNumber(pos.avgPrice)}ì›</td>
                        <td>${formatNumber(pos.currentPrice)}ì›</td>
                        <td>${formatNumber(pos.evaluation)}ì›</td>
                        <td class="${pos.profitLoss >= 0 ? 'profit-positive' : 'profit-negative'}">${formatNumber(pos.profitLoss)}ì›</td>
                        <td class="${pos.returnRate >= 0 ? 'profit-positive' : 'profit-negative'}">${pos.returnRate?.toFixed(2) || '0.00'}%</td>
                    </tr>
                `).join('');
            }

            // ì”ê³  ìš”ì•½ ì—…ë°ì´íŠ¸
            function updateBalanceSummary(balance) {
                const totalEval = document.getElementById('totalEvaluation');
                const unrealizedPnL = document.getElementById('unrealizedPnL');
                const returnRate = document.getElementById('returnRate');

                if (totalEval && balance.totalEvaluation != null) {
                    totalEval.textContent = formatNumber(balance.totalEvaluation) + 'ì›';
                }
                if (unrealizedPnL && balance.unrealizedPnL != null) {
                    unrealizedPnL.textContent = formatNumber(balance.unrealizedPnL) + 'ì›';
                    unrealizedPnL.className = 'summary-stat-value ' + (balance.unrealizedPnL >= 0 ? 'profit-positive' : 'profit-negative');
                }
                if (returnRate && balance.returnRate != null) {
                    returnRate.textContent = balance.returnRate.toFixed(2) + '%';
                    returnRate.className = 'summary-stat-value ' + (balance.returnRate >= 0 ? 'profit-positive' : 'profit-negative');
                }
            }

            // ìˆ«ì í¬ë§·íŒ…
            function formatNumber(num) {
                if (num == null) return '0';
                return new Intl.NumberFormat('ko-KR').format(Math.round(num));
            }

            // ì°¨íŠ¸ ì¢…ëª© ì„ íƒê¸° ì—…ë°ì´íŠ¸ (ê²€ìƒ‰ ê¸°ëŠ¥ ì‚¬ìš©ìœ¼ë¡œ ì œê±°ë¨)

            // ì‹¤ì‹œê°„ ì°¨íŠ¸ ì´ˆê¸°í™”
            function initRealtimeChart() {
                const ctx = document.getElementById('realtimePriceChart');
                if (!ctx) return;

                const noDataMsg = document.getElementById('chartNoData');
                noDataMsg.style.display = 'block';
                ctx.style.display = 'none';

                realtimePriceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ê°€ê²©',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: true,
                                callbacks: {
                                    label: function(context) {
                                        return formatNumber(context.parsed.y) + 'ì›';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxTicksLimit: 8
                                }
                            },
                            y: {
                                display: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value) + 'ì›';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // =============================================
            // Symbol Search Functions
            // =============================================

            const symbolSearchInput = document.getElementById('symbolSearchInput');
            const symbolSearchResults = document.getElementById('symbolSearchResults');
            const selectedSymbolInput = document.getElementById('selectedSymbol');
            let searchTimeout = null;
            let searchResultsData = [];
            let selectedResultIndex = -1;

            if (symbolSearchInput) {
                // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
                symbolSearchInput.addEventListener('input', function() {
                    const query = this.value.trim();

                    if (searchTimeout) {
                        clearTimeout(searchTimeout);
                    }

                    if (query.length < 1) {
                        hideSearchResults();
                        return;
                    }

                    // ë””ë°”ìš´ìŠ¤: 300ms í›„ ê²€ìƒ‰
                    searchTimeout = setTimeout(() => {
                        searchInstruments(query);
                    }, 300);
                });

                // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
                symbolSearchInput.addEventListener('keydown', function(e) {
                    if (!symbolSearchResults.style.display || symbolSearchResults.style.display === 'none') {
                        return;
                    }

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedResultIndex = Math.min(selectedResultIndex + 1, searchResultsData.length - 1);
                        updateSelectedResult();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedResultIndex = Math.max(selectedResultIndex - 1, 0);
                        updateSelectedResult();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedResultIndex >= 0 && searchResultsData[selectedResultIndex]) {
                            selectSymbol(searchResultsData[selectedResultIndex]);
                        }
                    } else if (e.key === 'Escape') {
                        hideSearchResults();
                    }
                });

                // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ê²°ê³¼ ìˆ¨ê¹€
                symbolSearchInput.addEventListener('blur', function() {
                    setTimeout(() => hideSearchResults(), 200);
                });
            }

            // ì¢…ëª© ê²€ìƒ‰ API í˜¸ì¶œ
            function searchInstruments(query) {
                symbolSearchResults.innerHTML = '<div class="symbol-search-loading">ê²€ìƒ‰ ì¤‘...</div>';
                symbolSearchResults.style.display = 'block';

                fetch(`/trading/api/instruments/search?query=${encodeURIComponent(query)}&limit=15`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.items && data.items.length > 0) {
                            searchResultsData = data.items;
                            selectedResultIndex = -1;
                            renderSearchResults(data.items);
                        } else {
                            searchResultsData = [];
                            symbolSearchResults.innerHTML = '<div class="symbol-search-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Search failed:', error);
                        symbolSearchResults.innerHTML = '<div class="symbol-search-empty">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                    });
            }

            // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§
            function renderSearchResults(items) {
                symbolSearchResults.innerHTML = items.map((item, index) => `
                    <div class="symbol-search-item" data-index="${index}" data-symbol="${item.symbol}">
                        <span class="symbol-code">${item.symbol}</span>
                        <span class="symbol-name">${item.nameKr || item.name || ''}</span>
                        <span class="symbol-market">${item.market || ''}</span>
                    </div>
                `).join('');

                // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                symbolSearchResults.querySelectorAll('.symbol-search-item').forEach(el => {
                    el.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        selectSymbol(searchResultsData[index]);
                    });
                });
            }

            // ì„ íƒëœ ê²°ê³¼ í•˜ì´ë¼ì´íŠ¸
            function updateSelectedResult() {
                symbolSearchResults.querySelectorAll('.symbol-search-item').forEach((el, index) => {
                    el.classList.toggle('selected', index === selectedResultIndex);
                });

                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¡°ì •
                const selectedEl = symbolSearchResults.querySelector('.symbol-search-item.selected');
                if (selectedEl) {
                    selectedEl.scrollIntoView({ block: 'nearest' });
                }
            }

            // ì¢…ëª© ì„ íƒ
            function selectSymbol(item) {
                selectedSymbol = item.symbol;
                selectedSymbolInput.value = item.symbol;
                symbolSearchInput.value = `${item.symbol} - ${item.nameKr || item.name || ''}`;
                hideSearchResults();

                // ì°¨íŠ¸ ì‹œì‘
                const ctx = document.getElementById('realtimePriceChart');
                const noDataMsg = document.getElementById('chartNoData');

                ctx.style.display = 'block';
                noDataMsg.style.display = 'none';
                startPriceUpdates(selectedSymbol);
            }

            // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¹€
            function hideSearchResults() {
                symbolSearchResults.style.display = 'none';
                selectedResultIndex = -1;
            }

            // ê°€ê²© ì—…ë°ì´íŠ¸ ì‹œì‘ (í´ë§)
            function startPriceUpdates(symbol) {
                stopPriceUpdates();
                priceDataBuffer = [];

                // ì´ˆê¸° ë°ì´í„° ìƒì„± (ë°ëª¨ìš©)
                generateDemoData(symbol);

                // 5ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
                priceUpdateInterval = setInterval(() => {
                    updatePriceData(symbol);
                }, 5000);
            }

            // ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘ì§€
            function stopPriceUpdates() {
                if (priceUpdateInterval) {
                    clearInterval(priceUpdateInterval);
                    priceUpdateInterval = null;
                }
            }

            // ë°ëª¨ ë°ì´í„° ìƒì„±
            function generateDemoData(symbol) {
                const now = new Date();
                const basePrice = 50000 + Math.random() * 50000;

                for (let i = 59; i >= 0; i--) {
                    const time = new Date(now - i * 60000);
                    const noise = (Math.random() - 0.5) * basePrice * 0.02;
                    priceDataBuffer.push({
                        time: time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                        price: basePrice + noise
                    });
                }

                updateChartWithData();
            }

            // ê°€ê²© ë°ì´í„° ì—…ë°ì´íŠ¸
            function updatePriceData(symbol) {
                const now = new Date();
                const lastPrice = priceDataBuffer.length > 0 ? priceDataBuffer[priceDataBuffer.length - 1].price : 50000;
                const noise = (Math.random() - 0.5) * lastPrice * 0.01;

                priceDataBuffer.push({
                    time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                    price: lastPrice + noise
                });

                // ìµœëŒ€ 120ê°œ ë°ì´í„° í¬ì¸íŠ¸ ìœ ì§€
                if (priceDataBuffer.length > 120) {
                    priceDataBuffer.shift();
                }

                updateChartWithData();
            }

            // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
            function updateChartWithData() {
                if (!realtimePriceChart) return;

                realtimePriceChart.data.labels = priceDataBuffer.map(d => d.time);
                realtimePriceChart.data.datasets[0].data = priceDataBuffer.map(d => d.price);
                realtimePriceChart.update('none');
            }

            // ì „ëµ ìƒíƒœ ê°±ì‹ 
            function refreshStrategyStatus() {
                fetch('/trading/api/strategies/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.items) {
                            updateStrategyCards(data.items);
                        }
                    })
                    .catch(error => console.error('Failed to refresh strategies:', error));
            }

            // ì „ëµ ì¹´ë“œ ì—…ë°ì´íŠ¸
            function updateStrategyCards(strategies) {
                const container = document.getElementById('strategyCards');
                if (!container) return;

                const displayStrategies = strategies.slice(0, 6);
                container.innerHTML = displayStrategies.map(strategy => {
                    const statusClass = strategy.status === 'ACTIVE' ? 'status-active' :
                                       (strategy.status === 'PAUSED' ? 'status-paused' : 'status-inactive');
                    const badgeClass = strategy.status === 'ACTIVE' ? 'active' :
                                      (strategy.status === 'PAUSED' ? 'paused' : 'inactive');
                    const pnlClass = (strategy.totalProfitLoss || 0) >= 0 ? 'profit-positive' : 'profit-negative';

                    return `
                        <div class="strategy-card ${statusClass}">
                            <div class="strategy-card-header">
                                <div class="strategy-card-name">${strategy.name}</div>
                                <span class="strategy-status-badge ${badgeClass}">${strategy.status}</span>
                            </div>
                            <div class="strategy-card-stats">
                                <div class="strategy-stat">
                                    <div class="strategy-stat-label">ìŠ¹ë¥ </div>
                                    <div class="strategy-stat-value">${strategy.winRate != null ? strategy.winRate.toFixed(1) + '%' : '-'}</div>
                                </div>
                                <div class="strategy-stat">
                                    <div class="strategy-stat-label">ê±°ë˜ìˆ˜</div>
                                    <div class="strategy-stat-value">${strategy.totalTrades || 0}</div>
                                </div>
                                <div class="strategy-stat">
                                    <div class="strategy-stat-label">ì†ìµ</div>
                                    <div class="strategy-stat-value ${pnlClass}">${formatNumber(strategy.totalProfitLoss || 0)}</div>
                                </div>
                            </div>
                            <div class="strategy-last-signal">
                                ìµœê·¼ ì‹ í˜¸: ${strategy.lastSignal || 'ì—†ìŒ'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            document.addEventListener('DOMContentLoaded', function() {
                initRealtimeChart();

                // 30ì´ˆë§ˆë‹¤ í¬ì§€ì…˜, ì”ê³ , ì „ëµ ê°±ì‹ 
                const accountSel = document.getElementById('accountSelector');
                if (accountSel && accountSel.value) {
                    setInterval(() => {
                        refreshPositionData(accountSel.value);
                        refreshBalanceData(accountSel.value);
                    }, 30000);
                }

                setInterval(refreshStrategyStatus, 30000);
            });
        </script>
    </th:block>
</body>
</html>
